# Contributor: Michał Polański <michal@polanski.me>
# Maintainer: mio <miyopan@e.email>
maintainer="mio <miyopan@e.email>"
pkgname=task3
pkgver=3.4.2
pkgrel=0
pkgdesc="Command-line to-do list manager"
url="https://taskwarrior.org"
arch="all"
license="MIT"
install="$pkgname.post-install"
makedepends="
	cargo
	cargo-auditable
	clang-libclang
	cmake
	corrosion
	samurai
	sqlite-dev
	util-linux-dev
	"
checkdepends="bash python3"
subpackages="$pkgname-doc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
# Release tarball excludes the test suite, extract from the archive tarball
source="https://github.com/GothenburgBitFactory/taskwarrior/releases/download/v$pkgver/task-$pkgver.tar.gz
	https://github.com/GothenburgBitFactory/taskwarrior/archive/v$pkgver/task-archive-$pkgver.tar.gz
	increase-test-timeouts.patch
	"
builddir="$srcdir"/task-$pkgver

prepare() {
	cp -r "$srcdir"/taskwarrior-$pkgver/test "$builddir"/

	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DSYSTEM_CORROSION=ON
	cmake --build build

	if want_check; then
		cmake --build build --target test_runner --target task_executable
	fi
}

check() {
	# 3.3.0: abbreviation failed on CI, delete failed on builder
	# 3.4.2: ids and delete flaky in CI on x86_64, ppc64le, riscv64
	# despite increased timeout
	case "$CARCH" in
	armhf|armv7|x86) ctest --test-dir build -E "abbreviation.test.py" ;;
	loongarch64) ctest --test-dir build -E "delete.test.py" ;;
	*) ctest --test-dir build -E "(delete|ids).test.py" ;;
	esac
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm644 scripts/bash/task.sh \
		"$pkgdir"/usr/share/bash-completion/completions/task
	install -Dm644 scripts/fish/task.fish \
		"$pkgdir"/usr/share/fish/vendor_completions.d/task.fish
	install -Dm644 scripts/zsh/_task \
		"$pkgdir"/usr/share/zsh/site-functions/_task
}

sha512sums="
e784d057e30d85de3a1d920a7272cc94739c34d1901664a45d60eb065b51f4e6b0c1478f3c442b7a88d7c9b194c37c9cc9cbee97cd73bfd294a415deb6d8aac6  task-3.4.2.tar.gz
685fc93fbfeefcd813d49e21b35567c179c4110c68305dd1f4556cd0eb4caff7dff193fd552199f4800fbb57d8e48b529f4104f90c94e7f540786791c72f130e  task-archive-3.4.2.tar.gz
6fda6fe2c412afb1aba50b90bd4ae152ad4396123838cf5d98f579e9a06db739fe435745d5f97dc5de8bc15c795dad9f46857cf00e51042eafd057802aca467e  increase-test-timeouts.patch
"
