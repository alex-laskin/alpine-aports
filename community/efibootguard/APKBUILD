# Maintainer: Thomas Liske <thomas@fiasko-nw.net>
pkgname=efibootguard
pkgver=0.21
pkgrel=0
pkgdesc="Simple UEFI boot loader with support for safely switching between current and updated partition sets"
url="https://github.com/siemens/efibootguard/"
arch="aarch64 riscv64 x86 x86_64"
license="GPL-2.0-only"
depends="python3"
makedepends="
	argp-standalone
	autoconf
	autoconf-archive
	automake
	bsd-compat-headers
	check-dev
	gnu-efi-dev
	libtool
	linux-headers
	pciutils-dev
	py3-shtab
	python3
	"
checkdepends="bats"
options="!check" # fff is missing on alpine
source="$pkgname-$pkgver.tar.gz::https://github.com/siemens/efibootguard/archive/v$pkgver/efibootguard-$pkgver.tar.gz
	0001-fallback-outb_p.patch
	0002-configure.patch
	"
subpackages="$pkgname-dev $pkgname-bash-completion $pkgname-zsh-completion"

prepare() {
	default_prepare
	autoreconf -fvi
}

build() {
	./configure
	make LIBS="-largp"
}

package() {
	make DESTDIR="$pkgdir" install

	mkdir -p "$pkgdir/usr/share/bash-completion"
	mv "$pkgdir/usr/share/efibootguard/completion/bash" "$pkgdir/usr/share/bash-completion/completions"

	mkdir -p "$pkgdir/usr/share/zsh"
	mv "$pkgdir/usr/share/efibootguard/completion/zsh" "$pkgdir/usr/share/zsh/site-functions"
}

sha512sums="
f814a11c230fa9e6c23ef46c944aff76b1a1efc061b6285a410492ea30d32b026b5809de87b8e93b5cab5aa065f253e40f6d6fed4537ffaf5eda7dedb4178b25  efibootguard-0.21.tar.gz
ea5a5ac3b624746883d19ed0ff51a7d815c71cd8955ff30d38badd63f1d7b191c15365a8465bfcf3cb5b01b35b0924eb5db33c22e2380de13dca22319602a1a4  0001-fallback-outb_p.patch
79f0c325177057bfd88b811983abae47b2fba2a79b68b2ed33d1093cd40d3e23a1be5e4c2c1d319329af7ea8d2663c645ef39e5976b4eb7b9ab7fa68ee0a4430  0002-configure.patch
"
