# Maintainer: Kevin Daudt <kdaudt@alpinelinux.org>
pkgname=openbao
pkgver=2.4.3
_pkgver=${pkgver/_/-}
pkgrel=0
pkgdesc="solution to manage, store, and distribute sensitive data including secrets, certificates, and keys"
url="https://openbao.org/"
arch="all"
license="MPL-2.0"
makedepends="go"
install="$pkgname.pre-install"
pkgusers="openbao"
pkggroups="openbao"
subpackages="$pkgname-openrc"
options="!check net" # many tests require docker
source="https://github.com/openbao/openbao/archive/v$_pkgver/openbao-$_pkgver.tar.gz
	openbao.confd
	openbao.hcl
	openbao.initd
	"

# secfixes:
#   2.4.3-r0:
#     - CVE-2025-62513
#     - CVE-2025-62705
#   2.4.1-r0:
#     - CVE-2025-59043
#   2.3.2-r0:
#     - CVE-2025-54996
#     - CVE-2025-54997
#     - CVE-2025-54998
#     - CVE-2025-54999
#     - CVE-2025-55000
#     - CVE-2025-55003
#   2.3.1-r0:
#     - CVE-2025-52894
#     - CVE-2025-52893
#   2.2.2-r0:
#     - CVE-2025-4166

prepare() {
	default_prepare

	echo "$_pkgver" >version/VERSION
}

build() {
	ldflags="
		-X github.com/openbao/openbao/version.fullVersion=$pkgver
		-X github.com/openbao/openbao/version.BuildDate=$EPOCH_SOURCE_DATE
	"
	go build -v -ldflags="$ldflags" -o bao .
}

check() {
	make test
}

package() {
	install -Dm0755 -t "$pkgdir/usr/bin/" bao

	install -m755 -D "$srcdir/$pkgname.initd" \
		"$pkgdir/etc/init.d/$pkgname"

	install -m644 -D "$srcdir/$pkgname.confd" \
		"$pkgdir/etc/conf.d/$pkgname"

	install -m640 -o root -g openbao -D "$srcdir/$pkgname.hcl" \
		"$pkgdir/etc/$pkgname.hcl"

	install -m750 -o openbao -g openbao -d "$pkgdir/var/lib/$pkgname"
}

sha512sums="
3a59592cc1e2f4bf8c69f1af992d1aea1164d22a3a0545dd3bd818a5952b9e7f5ffa9a698c33fe4c8596ffe73456d37afd6cceabf7b665e793f2a77355a714d6  openbao-2.4.3.tar.gz
f6ab6bf696085c350f08952084b865aa9bbf191a627f73cbf811632ed9282a31188e7386380dd89ffce38e4e8c4686b39fe15d46a2ff468c1347a773b64dc7ff  openbao.confd
6b833c86d18d0f1033f6a0a45c03c5a2191075fbe2c0fa6dede2e510c7aada2fa595cadc2a544a654347f9c9d264de1ddd1f8c3b3b06c881834a41379717fa0e  openbao.hcl
8d835dee70418eaec091f30efd2c3254537b584802d3bd4a5c4d2367b5e1ca1f7b4cc99015ba6346e597ca9b07eddc75f067f9688eed44ee439ef2cdc67def57  openbao.initd
"
