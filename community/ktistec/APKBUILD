# Contributor: qaqland <qaq@qaq.land>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=ktistec
pkgver=3.1.1
pkgrel=0
pkgdesc="Single-user ActivityPub server written in Crystal"
url="https://github.com/toddsundsted/ktistec"
arch="x86_64 aarch64" # crystal
license="AGPL-3.0-or-later"
depends="tzdata"
makedepends="
	gc-dev
	git
	gmp-dev
	libxml2-dev
	musl-utils
	openssl-dev
	pcre2-dev
	sqlite-dev
	yaml-dev
	zlib-dev
	"
options="net"
install="$pkgname.pre-install"
pkgusers="ktistec"
pkggroups="ktistec"
subpackages="$pkgname-openrc"
_bootver=1.16.3 # Remove when upstream reverts https://github.com/toddsundsted/ktistec/commit/85a60cd434b456de0c35546dff786285f9a1e74e
_shardsver=0.19.1-r0
source="$pkgname-$pkgver.tar.gz::https://github.com/toddsundsted/ktistec/archive/refs/tags/v$pkgver.tar.gz
	ktistec.initd
	ktistec.confd

	https://dev.alpinelinux.org/archive/crystal/crystal-$_bootver-x86_64-alpine-linux-musl.tar.gz
	https://dev.alpinelinux.org/archive/crystal/crystal-$_bootver-aarch64-alpine-linux-musl.tar.gz
	https://github.com/crystal-lang/crystal/archive/refs/tags/$_bootver/crystal-$_bootver.tar.gz

	shards-$_shardsver-x86_64.apk::https://dl-cdn.alpinelinux.org/alpine/v3.22/community/x86_64/shards-$_shardsver.apk
	shards-$_shardsver-aarch64.apk::https://dl-cdn.alpinelinux.org/alpine/v3.22/community/aarch64/shards-$_shardsver.apk
	"

export PATH="$srcdir/crystal-$_bootver-$CBUILD/bin:$PATH"
export CRYSTAL_PATH="$srcdir/crystal-$_bootver/src:$srcdir/ktistec-$pkgver/lib"

export CRYSTAL_CACHE_DIR="${CRYSTAL_CACHE_DIR:-"$srcdir/.cache"}"
export SHARDS_CACHE_PATH="${SHARDS_CACHE_PATH:-"$srcdir/.cache"}"

unpack() {
	default_unpack

	cd "$srcdir"/crystal-$_bootver-$CBUILD
	$APK extract ../shards-$_shardsver-$CBUILD_ARCH.apk
	mv -v usr/bin/shards bin/
}

prepare() {
	default_prepare

	shards install --frozen
}

build() {
	crystal build --no-debug --release src/ktistec/server.cr
}

check() {
	local i; for i in $(seq 0 5); do
		[ $i -eq 0 ] || msg "Retrying ($i/5)..."
		crystal spec -v && return 0
		sleep 5
	done
}

package() {
	install -Dvm755 server "$pkgdir"/usr/bin/ktistec
	install -dvm750 -o ktistec -g ktistec "$pkgdir"/var/lib/ktistec

	cp -a etc public "$pkgdir"/var/lib/ktistec/
	ln -sv public/uploads "$pkgdir"/var/lib/ktistec/
	chown -R ktistec:ktistec "$pkgdir"/var/lib/ktistec/public/uploads

	install -Dm755 "$srcdir"/ktistec.initd "$pkgdir"/etc/init.d/ktistec
	install -Dm644 "$srcdir"/ktistec.confd "$pkgdir"/etc/conf.d/ktistec
}

sha512sums="
2daa90192d9cd0dba658b1382feab80a57f1917d199a32cbd239de889343764fd516681ac4a5fb285195fc3a4eba87852a1f3acabc214d5f446a40c8de3a1fca  ktistec-3.1.1.tar.gz
f2520a9306daf544fec456e739abf1bb1e1a188992bbd8ef4a3ce3915a342209521ceedef8fc871c659d12ca57914825a8dcebc04e0114147fe32fc7de1dcabb  ktistec.initd
b8971fe3a504df6173015a33a8edd64d74144128a1247328067fe82bee796d5faa55fa00de01690fedd7a027fb55e584b98b20277faa4140b913f52e4ec094e3  ktistec.confd
64d527d5c47de0b8b6851628cb5f2ef117a5531e6d9cc9df97ab0a778d84621e6e0b8c0d3404fdb432c5977ede62d0ad264dcf413976f8c66cff006c71cae929  crystal-1.16.3-x86_64-alpine-linux-musl.tar.gz
568fdb104905e0a58b074fab915eab7279f90e52021b20280cf6249b07aad0e80a3c71c20c7bf4f2aba9abd53507d17a395d60ddd7758d1dea20e416041c7c63  crystal-1.16.3-aarch64-alpine-linux-musl.tar.gz
4a4a409ad28629c088ddd824fa17a4a1eacf16cb71a644f8df7636208cca0101c0fb190dcad759f1a56e5471fe2094a37d00df47381e54b8259f93f78481f517  crystal-1.16.3.tar.gz
26a39650f9263a70be854272fadc25a5152abeee37be2f3a1c23210242607bab3bd8ff83686007a67db872cb4270272f868afde7eb3e4d76e516a977b92146cd  shards-0.19.1-r0-x86_64.apk
48807de32da3810712dc261363c5326ad083e786e344ec88e2bb91ca043ee22e1e0ad228920d15cd0ea030ac7ad286bd99a797cd609c6f99c5ee32afe1430b33  shards-0.19.1-r0-aarch64.apk
"
