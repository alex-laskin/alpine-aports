# Contributor: Paul Onyschuk <blink@bojary.koba.pl>
# Contributor: David Demelier <markand@malikania.fr>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=fossil
pkgver=2.27
pkgrel=0
pkgdesc="Simple, high-reliability, distributed software configuration management"
url="https://www.fossil-scm.org/"
arch="all"
license="BSD-2-Clause"
makedepends_host="openssl-dev tcl-dev zlib-dev"
checkdepends="ed tcl-lib sqlite-tcl"
subpackages="$pkgname-bash-completion $pkgname-zsh-completion"
source="https://www.fossil-scm.org/home/tarball/version-$pkgver/fossil-src-$pkgver.tar.gz
	fix-tests.patch
	"
patch_args="-p0"
builddir="$srcdir/$pkgname-src-$pkgver"

prepare() {
	default_prepare

	# https://fossil-scm.org/home/info/4619d2efab946460
	mv -v test/settings.test test/settings.test.off
}

build() {
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--json \
		--with-th1-docs \
		--with-th1-hooks \
		--with-tcl=1 \
		--with-tcl-private-stubs

	make \
		BCC="${HOSTCC:-$CC}" \
		BCCFLAGS="${HOSTCFLAGS:-$CFLAGS}" \
		TCC="$CC $CFLAGS"
}

check() {
	export USER="${USER:-$(id -un)}"
	make TESTFLAGS="-verbose" test
}

package() {
	install -Dm755 fossil -t "$pkgdir"/usr/bin/

	# add shell completions
	install -Dm644 tools/fossil-autocomplete.bash \
		"$pkgdir"/usr/share/bash-completion/completions/fossil
	install -Dm644 tools/fossil-autocomplete.zsh \
		"$pkgdir"/usr/share/zsh/site-functions/_fossil
}

sha512sums="
39a43d769212f5ecb891eef215054ed418f1e9da81abfd79d7e307b000adec8054675ca7b9a640fd78c327f50cd4e21285954ddc3b3c85967d9b511235bc8092  fossil-src-2.27.tar.gz
54c90121467cfaac8d81f8d798b4ce71ba8ef582ff48278c6099916629ed76aee25becf9055c105d16756e1ae7f70f9305c03c62487f4f1be0c8353abc499bf0  fix-tests.patch
"
