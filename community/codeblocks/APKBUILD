# Maintainer: Antoni Aloy <aaloytorrens@gmail.com>
pkgname=codeblocks
pkgver=25.03
pkgrel=0
pkgdesc="Cross-platform C/C++ and Fortran IDE"
url="https://codeblocks.org"
arch="all"
license="GPL-3.0-or-later"
makedepends="
	autoconf
	automake
	boost-dev
	hunspell-dev
	imagemagick
	libtool
	nspr-dev
	tinyxml-dev
	wxwidgets-dev
	zip
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-contrib"
source="
	https://sourceforge.net/projects/codeblocks/files/Sources/$pkgver/codeblocks_$pkgver.tar.xz
	use-system-nspr.patch
	"
options="!check" # No test suite
patch_args="-p1 -F3"
builddir="$srcdir/codeblocks_$pkgver"

prepare() {
	default_prepare

	magick $builddir/src/mime/codeblocks.png +set date:create \
		+set date:modify -background none -extent 64x64 src/mime/codeblocks.png

	sed -i 's|$(datadir)/pixmaps|$(datadir)/icons/hicolor/64x64/apps|' \
		src/mime/Makefile.am

	sed -i 's|$(datarootdir)/appdata|$(datarootdir)/metainfo|' \
		Makefile.am src/plugins/contrib/appdata/Makefile.am

	sed -i "s|@VERSION@|$pkgver|" codeblocks.pc.in

	./bootstrap
}

build() {
	export CFLAGS="$CFLAGS -O2 -flto=auto -U_FORTIFY_SOURCE"
	export CXXFLAGS="$CXXFLAGS -O2 -flto=auto -U_FORTIFY_SOURCE"

	# Deactivate wxsmith-related plugins because they depend on wxpropgrid
	./configure \
		--prefix=/usr \
		--build=$CBUILD \
		--host=$CHOST \
		--with-boost-libdir=/usr/lib \
		--with-contrib-plugins=all,-FileManager

	sed -i 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
	make
}

package() {
	make DESTDIR="$pkgdir" install

	# Replace pkgconfig file for 25.03 version (Reason: 25.03svn version is invalid)
	find "$pkgdir" -type f -exec sed -i 's/25.03svn/25.03/g' {} +
}

dev() {
	default_dev
	pkgdesc="$pkgdesc (SDK)"
}

contrib() {
	pkgdesc="$pkgdesc (contrib plugins)"

	# Move plugins and wxContribItems to this subpackage
	amove usr/lib/codeblocks

	# Move contrib metainfo file
	amove usr/share/metainfo/codeblocks-contrib.metainfo.xml

	# Move optional plugins to this subcategory
	amove \
		usr/share/codeblocks/AutoVersioning.zip \
		usr/share/codeblocks/BrowseTracker.zip \
		usr/share/codeblocks/Cccc.zip \
		usr/share/codeblocks/CppCheck.zip \
		usr/share/codeblocks/Cscope.zip \
		usr/share/codeblocks/DoxyBlocks.zip \
		usr/share/codeblocks/EditorConfig.zip \
		usr/share/codeblocks/EditorTweaks.zip \
		usr/share/codeblocks/HexEditor.zip \
		usr/share/codeblocks/IncrementalSearch.zip \
		usr/share/codeblocks/MouseSap.zip \
		usr/share/codeblocks/NassiShneiderman.zip \
		usr/share/codeblocks/Profiler.zip \
		usr/share/codeblocks/ProjectOptionsManipulator.zip \
		usr/share/codeblocks/RegExTestbed.zip \
		usr/share/codeblocks/ReopenEditor.zip \
		usr/share/codeblocks/SmartIndentCpp.zip \
		usr/share/codeblocks/SmartIndentFortran.zip \
		usr/share/codeblocks/SmartIndentHDL.zip \
		usr/share/codeblocks/SmartIndentLua.zip \
		usr/share/codeblocks/SmartIndentPascal.zip \
		usr/share/codeblocks/SmartIndentPython.zip \
		usr/share/codeblocks/SmartIndentXML.zip \
		usr/share/codeblocks/SpellChecker \
		usr/share/codeblocks/SpellChecker.zip \
		usr/share/codeblocks/SymTab.zip \
		usr/share/codeblocks/ThreadSearch.zip \
		usr/share/codeblocks/ToolsPlus.zip \
		usr/share/codeblocks/Valgrind.zip \
		usr/share/codeblocks/abbreviations.zip \
		usr/share/codeblocks/byogames.zip \
		usr/share/codeblocks/cb_koders.zip \
		usr/share/codeblocks/codesnippets.zip \
		usr/share/codeblocks/codestat.zip \
		usr/share/codeblocks/copystrings.zip \
		usr/share/codeblocks/dragscroll.zip \
		usr/share/codeblocks/envvars.zip \
		usr/share/codeblocks/exporter.zip \
		usr/share/codeblocks/headerfixup.zip \
		usr/share/codeblocks/help_plugin.zip \
		usr/share/codeblocks/images \
		usr/share/codeblocks/keybinder.zip \
		usr/share/codeblocks/lib_finder \
		usr/share/codeblocks/lib_finder.zip \
		usr/share/codeblocks/occurrenceshighlighting.zip \
		usr/share/codeblocks/rndgen.zip

	mkdir -p "$subpkgdir"/usr/share/codeblocks/images
}

sha512sums="
a5a7d6fd554dde781c5bd31c24f0f8a40c15d0525ecd66139e30709d72f46bee89fb75607c1ebc04d1473329add10bf7ee8c41ef2760a7e7bec221503b37efa1  codeblocks_25.03.tar.xz
e2bface9fd253e22a5c2acd4c5ee37dc482b193b51f18b8e0f3e423a83b92aa6821ffe12c5570c2eba25a900453197d321dfad7e034bbed9b53b2cc7d0427240  use-system-nspr.patch
"
