# Maintainer: Alex McGrath <amk@amk.ie>
pkgname=foot
pkgver=1.25.0
pkgrel=0
pkgdesc="Fast, lightweight and minimalistic Wayland terminal emulator"
url="https://codeberg.org/dnkl/foot"
license="MIT"
arch="all"
depends="ncurses-terminfo"
makedepends="
	cage
	font-dejavu
	fcft-dev
	fontconfig-dev
	freetype-dev
	libxkbcommon-dev
	meson
	ncurses
	pixman-dev
	scdoc
	tllist-dev
	utf8proc-dev
	wayland-dev
	wayland-protocols
	"
subpackages="
	$pkgname-dbg
	$pkgname-doc
	$pkgname-openrc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	$pkgname-extra-terminfo:_extra_terminfo:noarch
	$pkgname-themes:_themes:noarch
	"
source="
	$pkgname-$pkgver.tar.gz::https://codeberg.org/dnkl/foot/archive/$pkgver.tar.gz
	foot.initd
	"
options="!check" # ran during profiling
builddir="$srcdir/foot"

build() {
	export CFLAGS="$CFLAGS -O3" # -O3 as the package is intended to use it
	export CXXFLAGS="$CXXFLAGS -O3"
	export CPPFLAGS="$CPPFLAGS -O3"

	abuild-meson \
		-Db_pgo=generate \
		-Db_lto=true \
		-Dterminfo-base-name=foot-extra \
		-Dutmp-backend=none \
		. output
	meson compile -C output

	ninja -C output test

	# segfault on loongarch64
	if [ "$CARCH" != "loongarch64" ]; then
		./pgo/full-headless-cage.sh . output
	fi

	meson configure -Db_pgo=use output
	meson compile -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	install -Dm755 "$srcdir"/foot.initd "$pkgdir"/etc/user/init.d/foot
}

_extra_terminfo() {
	pkgdesc="$pkgdesc (extra terminfo data)"

	amove usr/share/terminfo/f
}

_themes() {
	pkgdesc="$pkgdesc (color schemes)"

	amove usr/share/foot/themes
}

sha512sums="
9399f2cb97044350e24324a17dc80c84b25ac30b148f18363ca06e10d102750412d079fec4bfcd8d06354c3e74ffbaf181c1dfefb92d9abbe147ea7bb9b88dd7  foot-1.25.0.tar.gz
0ca584efcf2ef6e3682e67253bfff092710619fa02af258dd6fb49170fe6581c8ff18784dd58ba6417b69dc39a155c32ef05b40cfe5688509d46e244d5ffbd4f  foot.initd
"
