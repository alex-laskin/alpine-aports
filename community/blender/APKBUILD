# Contributor: Mark Riedesel <mark@klowner.com>
# Contributor: Leon Marz <main@lmarz.org>
# Maintainer: Leon Marz <main@lmarz.org>
pkgname=blender
pkgver=4.5.3
_pkgver=${pkgver%.[0-9]}
pkgrel=4
pkgdesc="3D Creation/Animation/Publishing System"
url="https://www.blender.org/"
arch="x86_64 aarch64" # limited by openvdb
license="GPL-2.0-or-later"
depends="blender-shared=$pkgver-r$pkgrel"
makedepends="
	alembic-dev
	blosc-dev
	boost-dev
	clang-dev
	cmake
	eigen-dev
	embree-dev
	embree-static
	ffmpeg-dev
	fftw-dev
	freetype-dev
	gmp-dev
	jack-dev
	jemalloc-dev
	libdecor-dev
	libepoxy-dev
	libharu-dev
	libjpeg-turbo-dev
	libpng-dev
	libsndfile-dev
	libx11-dev
	libxi-dev
	libxkbcommon-dev
	libxrender-dev
	lzo-dev
	onetbb-dev
	openal-soft-dev
	opencolorio-dev
	openexr-dev
	openimagedenoise-dev
	openimageio-dev
	openjpeg-dev
	openpgl-dev
	opensubdiv-dev
	openvdb-dev
	openvdb-nanovdb
	openxr-dev
	osl
	osl-dev
	pipewire-dev
	potrace-dev
	pugixml-dev
	pulseaudio-dev
	py3-numpy-dev
	py3-zstandard
	python3-dev
	samurai
	sdl2-dev
	shaderc-dev
	tiff-dev
	vulkan-loader-dev
	wayland-dev
	wayland-protocols
	"
subpackages="$pkgname-doc $pkgname-shared::noarch $pkgname-headless py3-$pkgname:python"
source="https://download.blender.org/source/blender-$pkgver.tar.xz
	0001-musl-fixes.patch
	0002-fix-includes.patch
	ffmpeg8.patch
	147232.patch
	"

# secfixes:
#   3.3.0-r0:
#     - CVE-2022-2831
#     - CVE-2022-2832
#     - CVE-2022-2833

build() {
	# Headless
	_build build-headless -C build_files/cmake/config/blender_headless.cmake

	# Full
	_build build-full -C build_files/cmake/config/blender_full.cmake

	# Python module
	_build build-py -C build_files/cmake/config/bpy_module.cmake
}

_build() {
	local py_version=$(python3 -c 'import sys; print("%i.%i" % (sys.version_info.major, sys.version_info.minor))')
	local outdir="$1"
	shift

	cmake -B "$outdir" -G Ninja -Wno-dev \
		"$@" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=Release \
		-DWITH_PYTHON_INSTALL=OFF \
		-DWITH_INSTALL_PORTABLE=OFF \
		-DWITH_LIBS_PRECOMPILED=OFF \
		-DWITH_SYSTEM_EIGEN3=ON \
		-DWITH_SYSTEM_LZO=ON \
		-DWITH_LZMA=OFF \
		-DPYTHON_VERSION=$py_version \
		-DWITH_DRACO=OFF

	cmake --build "$outdir"
}

package() {
	# Install and rename the headless blender to blender-headless
	install -Dm755 build-headless/bin/blender "$pkgdir"/usr/bin/blender-headless

	# Install python module
	DESTDIR="$pkgdir" cmake --install build-py

	# Install the full package
	DESTDIR="$pkgdir" cmake --install build-full
}

shared() {
	pkgdesc="Blender shared runtime data and add-on scripts"
	depends=""
	amove usr/share/blender
}

headless() {
	pkgdesc="$pkgdesc (headless build)"
	depends="blender-shared=$pkgver-r$pkgrel"

	amove usr/bin/blender-headless
}

python() {
	pkgdesc="Blender modules for Python 3"
	depends="py3-numpy py3-zstandard"
	local py_version=$(python3 -c 'import sys; print("%i.%i" % (sys.version_info.major, sys.version_info.minor))')

	mkdir -p "$subpkgdir"/usr/lib/python"$py_version"/site-packages

	# temporary fix, while the build script has a bug
	mv "$pkgdir"/usr/lib/python"$py_version"/site-packages/bpy/__init__.so "$subpkgdir"/usr/lib/python"$py_version"/site-packages/bpy.so

	rm -rf "$pkgdir"/usr/lib

	# Symlink to the blender-shared files
	ln -s ../../../share/blender/"$_pkgver" "$subpkgdir"/usr/lib/python"$py_version"/site-packages/"$_pkgver"
}

sha512sums="
30712d13565a263bef76d79a9f4bda5aa2a618a6d7f167cbc9cceb96283f25518a9b96d085abbca68041a77063044d092b9ff59f8fd12e35b59f89606503deb1  blender-4.5.3.tar.xz
1c7da1ff5858be4f502f9f32c5c755e11784caa75d18dbc4bdbc3c09f9e9a966215388acdc89406906b732f5091b2e492e5793e5c423be8b5c970c00755ddc43  0001-musl-fixes.patch
3238d219a2d26ab8a65409967efceb6ac39ecc83a69f47f98484b20b0199739275b0aa4b88909a04e663339640b344fbab85abeaa8405fe286ee824eae7293e5  0002-fix-includes.patch
f336a460f44f317fcf8a705e68327135bdda9d5469b891cedd035fd44843bed8286fb8fc65f9ff57a37687e95f05e9fe13238d060a721919c439089231fd4bba  ffmpeg8.patch
43c1b3d7b546ce88ee52ea2950565b8272f677d8a6f9eee2867e5ffb24aa3449cf7402f7bc3478b51c693f9965df09f7620b3ff764c559ed355159535b21256d  147232.patch
"
