# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Contributor: Daniel Fancsali <fancsali@gmail.com>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
pkgname=clojure
pkgver=1.12.3
_tools="$pkgver.1577"
pkgrel=0
pkgdesc="The Clojure Programming Language"
url="https://clojure.org"
arch="noarch"
license="EPL-1.0"
case "$CARCH" in
	armhf|armv7|x86)	_jdkbuild=8	;;
	*)			_jdkbuild=21	;;
esac
depends="bash java-jdk rlwrap"
makedepends="maven openjdk$_jdkbuild-jdk"
subpackages="$pkgname-doc"
source="https://github.com/clojure/clojure/archive/clojure-$pkgver.tar.gz
	https://download.clojure.org/install/clojure-tools-$_tools.tar.gz
	"
builddir="$srcdir/clojure-clojure-$pkgver"
options="!check" # Check occurs in build

# secfixes:
#   1.11.2-r0:
#     - CVE-2024-22871

prepare() {
	default_prepare

	cd "$srcdir"/clojure-tools
	sed -i '/^bin_dir=BINDIR$/s/BINDIR/\/usr\/bin/' clj
	sed -i '/^install_dir=PREFIX$/s/PREFIX/\/usr\/share\/clojure/' clojure
	echo 'export CLOJURE_HOME=/usr/share/clojure' > clojure.sh
}

build() {
	export JAVA_HOME="/usr/lib/jvm/java-${_jdkbuild%%-*}-openjdk"

	mvn -Plocal package
}

package() {
	local sharedir="$pkgdir/usr/share/clojure"

	install -Dvm644 clojure.jar -t "$sharedir"/

	cd "$srcdir"/clojure-tools
	install -Dvm644 ./*.edn -t "$sharedir"/
	install -Dvm644 ./*.jar -t "$sharedir"/libexec/
	install -Dvm755 clj clojure -t "$pkgdir"/usr/bin/
	install -Dvm644 clojure.sh -t "$pkgdir"/etc/profile.d/
	install -Dvm644 ./*.1 -t "$pkgdir"/usr/share/man/man1/
}

sha512sums="
50c8ed7fe40551a63fa3b6d478913b7cd33fd5ec99e87c0fbee82d21716956853094509313b1d7484ff955a285e3f298be84f694d654ec4669a7771248887d49  clojure-1.12.3.tar.gz
c9c5381a78e6e8ff601e5cc061580fb952d34aabf7c87786d50ec33f41c656e58dcd917cffb33b1f69d75b698dbf74ab9d512639fac868fc7f1ccfc6a74040d6  clojure-tools-1.12.3.1577.tar.gz
"
