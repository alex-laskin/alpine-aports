# Contributor: Sergei Lukin <sergej.lukin@gmail.com>
# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Contributor: Jakub Skrzypnik <j.skrzypnik@openmailbox.org>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=ffmpeg7
pkgver=7.1.2
pkgrel=4
pkgdesc="Complete and free Internet live audio and video broadcasting solution for Linux/Unix"
url="https://ffmpeg.org/"
arch="all"
license="GPL-2.0-or-later AND LGPL-2.1-or-later"
makedepends="
	alsa-lib-dev
	aom-dev
	bzip2-dev
	coreutils
	dav1d-dev
	fontconfig-dev
	freetype-dev
	fribidi-dev
	harfbuzz-dev
	imlib2-dev
	ladspa-dev
	lame-dev
	libass-dev
	libbluray-dev
	libdrm-dev
	libjxl-dev
	libopenmpt-dev
	libplacebo-dev
	librist-dev
	libsrt-dev
	libssh-dev
	libtheora-dev
	libva-dev
	libvdpau-dev
	libvorbis-dev
	libvpx-dev
	libwebp-dev
	libxfixes-dev
	libxml2-dev
	lilv-dev
	nasm
	openssl-dev
	opus-dev
	perl-dev
	pulseaudio-dev
	rav1e-dev
	sdl2-dev
	soxr-dev
	v4l-utils-dev
	vidstab-dev
	vulkan-loader-dev
	x264-dev
	x265-dev
	xvidcore-dev
	zeromq-dev
	zimg-dev
	zlib-dev
	"
checkdepends="rsync"
subpackages="
	$pkgname-dbg
	$pkgname-dev
	$pkgname-doc
	$pkgname-libavcodec
	$pkgname-libavdevice
	$pkgname-libavfilter
	$pkgname-libavformat
	$pkgname-libavutil
	$pkgname-libpostproc
	$pkgname-libswresample
	$pkgname-libswscale
	$pkgname-libs
	"
source="https://ffmpeg.org/releases/ffmpeg-$pkgver.tar.xz
	add-av_stream_get_first_dts-for-chromium.patch
	handbrake-Expose-the-unmodified-Dolby-Vision-RPU-T35-buffers.patch
	"
options="!check" # tests/data/hls-lists.append.m3u8 fails
builddir="$srcdir/ffmpeg-$pkgver"

case "$CARCH" in
x86|armhf|armv7)
	;;
*)
	makedepends="$makedepends svt-av1-dev"
	_svt_av1="--enable-libsvtav1"
	;;
esac

case "$CARCH" in
x86_64)
	makedepends="$makedepends libvpl-dev"
	_libvpl="--enable-libvpl"
	;;
esac

build() {
	case "$CARCH" in
	x86) local asm="--disable-asm" ;;
	esac

	./configure \
		--prefix=/usr \
		--disable-librtmp \
		--disable-lzma \
		--disable-static \
		--disable-stripping \
		--enable-avfilter \
		--enable-gpl \
		--enable-ladspa \
		--enable-libaom \
		--enable-libass \
		--enable-libbluray \
		--enable-libdav1d \
		--enable-libdrm \
		--enable-libfontconfig \
		--enable-libfreetype \
		--enable-libfribidi \
		--enable-libharfbuzz \
		--enable-libjxl \
		--enable-libmp3lame \
		--enable-libopenmpt \
		--enable-libopus \
		--enable-libplacebo \
		--enable-libpulse \
		--enable-librav1e \
		--enable-librist \
		--enable-libsoxr \
		--enable-libsrt \
		--enable-libssh \
		--enable-libtheora \
		--enable-libv4l2 \
		--enable-libvidstab \
		--enable-libvorbis \
		--enable-libvpx \
		--enable-libwebp \
		--enable-libx264 \
		--enable-libx265 \
		--enable-libxcb \
		--enable-libxml2 \
		--enable-libxvid \
		--enable-libzimg \
		--enable-libzmq \
		--enable-lto=auto \
		--enable-lv2 \
		--enable-openssl \
		--enable-pic \
		--enable-postproc \
		--enable-pthreads \
		--enable-shared \
		--enable-vaapi \
		--enable-vdpau \
		--enable-version3 \
		--enable-vulkan \
		--optflags="-O3" \
		$asm \
		$_svt_av1 \
		$_libvpl
	make
	${CC:-gcc} -o tools/qt-faststart $CFLAGS $LDFLAGS tools/qt-faststart.c
}

# https://ffmpeg.org/fate.html
check() {
	./configure \
		--samples=fate-suite/
	make fate-rsync
	make fate-list
	make fate
}

package() {
	make DESTDIR="$pkgdir" install install-man
	install -D -m755 tools/qt-faststart "$pkgdir/usr/bin/qt-faststart"
}

doc() {
	default_doc

	amove usr/share/ffmpeg/examples
}

libavcodec() {
	pkgdesc="$pkgdesc (libavcodec library)"

	amove usr/lib/libavcodec.so.*
}

libavdevice() {
	pkgdesc="$pkgdesc (libavdevice library)"

	amove usr/lib/libavdevice.so.*
}

libavfilter() {
	pkgdesc="$pkgdesc (libavfilter library)"

	amove usr/lib/libavfilter.so.*
}

libavformat() {
	pkgdesc="$pkgdesc (libavformat library)"

	amove usr/lib/libavformat.so.*
}

libavutil() {
	pkgdesc="$pkgdesc (libavutil library)"

	amove usr/lib/libavutil.so.*
}

libpostproc() {
	pkgdesc="$pkgdesc (libpostproc library)"

	amove usr/lib/libpostproc.so.*
}

libswresample() {
	pkgdesc="$pkgdesc (libswresample library)"

	amove usr/lib/libswresample.so.*
}

libswscale() {
	pkgdesc="$pkgdesc (libswscale library)"

	amove usr/lib/libswscale.so.*
}

libs() {
	pkgdesc="compat hack for all ffmpeg libs"

	mkdir -p "$subpkgdir"
	depends="
		$pkgname-libavcodec=$pkgver-r$pkgrel
		$pkgname-libavdevice=$pkgver-r$pkgrel
		$pkgname-libavfilter=$pkgver-r$pkgrel
		$pkgname-libavformat=$pkgver-r$pkgrel
		$pkgname-libavutil=$pkgver-r$pkgrel
		$pkgname-libpostproc=$pkgver-r$pkgrel
		$pkgname-libswresample=$pkgver-r$pkgrel
		$pkgname-libswscale=$pkgver-r$pkgrel
		"
}

sha512sums="
181e6415da359e3addbc448ff09b5cebe57d9c37106e5125c41f484adebc250502fc9efe150cb117d7378e20830715035be94c2ba4ad7c369b18af85f1a4ca20  ffmpeg-7.1.2.tar.xz
0c2284bc053c92478ce6e3665e03273cb93926534c6f927eb60e060c7770c68dca12724853adbcac03c4a58df81f2de938d54e82f43c7e789d345bed872ffc69  add-av_stream_get_first_dts-for-chromium.patch
83a69540889173eac71585a2b5eb64f5bea335d032c550dd6cfa5c8a31632d5c079ab2474ee4f45793535dfc9e34545898fbbaadc56315466ec428fc8e8211a9  handbrake-Expose-the-unmodified-Dolby-Vision-RPU-T35-buffers.patch
"
