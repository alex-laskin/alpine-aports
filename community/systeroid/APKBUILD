# Contributor: Hoang Nguyen <folliekazetani@protonmail.com>
# Maintainer: omni <omni+alpine@hack.org>
pkgname=systeroid
pkgver=0.4.6
pkgrel=0
pkgdesc="A more powerful alternative to sysctl(8)"
arch="all"
url="https://systeroid.cli.rs/"
license="Apache-2.0"
makedepends="cargo libxcb-dev cargo-auditable"
checkdepends="xclip"
subpackages="$pkgname-doc $pkgname-tui:_tui $pkgname-tui-doc:_tui_doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/orhun/systeroid/archive/refs/tags/v$pkgver.tar.gz"
options="net"

case "$CARCH" in
armhf)
	;;
*)
	checkdepends="$checkdepends linux-lts-doc"
	;;
esac

prepare() {
	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	case "$CARCH" in
	loongarch64|s390x)
		# Fail to build old nix crate (see cargo tree output)
		cargo auditable build --release --frozen -p systeroid
		cargo auditable build --release --frozen --no-default-features -p systeroid-tui
		;;
	*)
		cargo auditable build --release --frozen
		;;
	esac
}

check() {
	case "$CARCH" in
	ppc64le)
		NO_COLOR=1 cargo test --frozen --no-default-features -- \
			--skip app::tests::test_app
		./target/release/systeroid --version
		;;
	armhf|riscv64)
		NO_COLOR=1 cargo test --frozen --no-default-features -- \
			--skip app::tests::test_app \
			--skip sysctl::controller::tests::test_sysctl_controller
		./target/release/systeroid --version
		;;
	*)
		NO_COLOR=1 cargo test --frozen --no-default-features
		;;
	esac
}

package() {
	install -Dm0755 target/release/systeroid target/release/systeroid-tui \
		-t "$pkgdir"/usr/bin/
	install -Dm0644 man8/systeroid.8 -t "$pkgdir"/usr/share/man/man8/
}

_tui() {
	pkgdesc="$pkgname terminal user interface"
	amove usr/bin/systeroid-tui
}

_tui_doc() {
	pkgdesc="$pkgname terminal user interface (documentation)"

	cd "$builddir"
	install -Dm0644 man8/systeroid-tui.8 -t "$subpkgdir"/usr/share/man/man8/

	default_doc
	install_if="docs $pkgname-tui=$pkgver-r$pkgrel"
}

sha512sums="
cb5cf3dae37ddec8343561c43d91e0f0de9eef94acdae3b1203db6aaecd31a0e3542a259b7c8298ebdcfde56483b1a8248d1504eed3f2dffea6ea3601ca8a5b5  systeroid-0.4.6.tar.gz
"
