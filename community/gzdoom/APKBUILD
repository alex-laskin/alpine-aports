# Maintainer: Antoni Aloy <aaloytorrens@gmail.com>
pkgname=gzdoom
pkgver=4.14.2
pkgrel=1
pkgdesc="Feature centric port for all Doom engine games"
url="https://www.zdoom.org/"
# ppc64le blocked by zmusic
# x86 blocked by sse2
# 32-bit builds blocked by src/common/engine/i_interface.cpp:4:29 (error: static assertion failed: 32 builds are not supported)
arch="all !ppc64le !x86 !armv7 !armhf"
license="GPL-3.0-or-later"
depends="
	fluidsynth
	libwebpdemux
	libwebpmux
	"
makedepends="
	bzip2-dev
	cmake
	gtk+3.0-dev
	libgme-dev
	libjpeg-turbo-dev
	libsndfile-dev
	libvpx-dev
	libwebp-dev
	mesa-dev
	mpg123-dev
	musl-fts-dev
	nasm
	openal-soft-dev
	samurai
	sdl2-dev
	vulkan-loader-dev
	zlib-dev
	zmusic-dev
	"
subpackages="$pkgname-doc"

source="
	https://github.com/coelckers/gzdoom/archive/refs/tags/g$pkgver.tar.gz
	0001-link-zipdir-against-fts.patch
	0002-fix-musl-fts.patch
	0003-define-cpu_set_t.patch
	no-execinfo.patch
	force-include-order.patch
	cmake-version.patch
	remove-wadsrc_bm-from-cmakelists.patch
	"
builddir="$srcdir/$pkgname-g$pkgver"
options="!check" # No test suite

prepare() {
	default_prepare
	# Delete non-free files. See https://zdoom.org/wiki/License#Commercial_use and https://gitlab.alpinelinux.org/alpine/aports/-/issues/17601
	rm -r wadsrc_bm # brightmaps.pk3
	# From Guix's package definition (https://codeberg.org/guix/guix/src/commit/8daae75de3670594dfcb63b6ae6f1603ca6f7971/gnu/packages/games.scm#L9255-L9383):
	#   Removing game_support.pk3 entirely would break Freedoom & remove
	#   users' ability to play commercial games, despite owning (only) the
	#   non-functional data.  That can't be right.  Out of an abundance of
	#   caution, remove anything from the PK3 that could conceivably be
	#   derived from copyrightable data that's not freely redistributable.
	find wadsrc_extra/static ! -regex '.*\(/font\.inf\|/harmony/.*\.\(txt\|zs\)\|/\(iwadinfo\|mapinfo\|sprofs\).txt\|\.z\)$' -delete
}

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local cmake_crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DDYN_GTK=OFF \
		-DDYN_OPENAL=OFF \
		-DALPINE_PKGVER="$pkgver" \
		$cmake_crossopts
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
0f4039292ffbe3ee6f6366a8631d61a34223b2c2078f97de4bd071c98256d16b0a770b2f40d9062527cf396ca1e372a37b55e0a54782f5fe2e500e61777c0e8f  g4.14.2.tar.gz
137d3211cdae714499bc5e99017f5d51f491416ac2ce41c9f67ad4b76ca3c74a3b801321c79229a4e69fe60796d9d9daf3e7d579e2499417d193745c4d95f64a  0001-link-zipdir-against-fts.patch
c7096ade84a73d8813af70ad0aad90d4f057a9027fd8bb368091bac66323b59090c8f3da74821aae86e86eae7771d441b8f7dd299448d85c03e39ef5c4bcf419  0002-fix-musl-fts.patch
c452e71a64a9d929a62207a7d1531f732ff622b4f7c2c0b94c3aaec37c25e6e9a2d919ed1c1457d7e1e7da990a981934cfb0b32952aa47d4b98855b60b2ce48e  0003-define-cpu_set_t.patch
db1166ba7561fb560a67797764c715b124d8cf39f9c251d3dbdd1f42b34257144c5d7873796d1c6cfa13be5dc11860e325527b7019f186fac1f7cd9c0c48ef8b  no-execinfo.patch
6b6eef6aa46aa3a065567f93165960bf6894dd7b0ea0b2f184772b985c4b3612d5863499f683fecf6f5977178c62e38218abd7bc288947b3d31461a8f935e9e9  force-include-order.patch
be700d296aebfbd26d280eaae6192788915c3fc13fb87b49e68512b6aa8cfddd41132c6f694086d872ba886e0853f3cbf182d7b8871296f1c663623aac919cba  cmake-version.patch
f6b075490025e0db4b3259eb561ca702325616cb18a50a0e2ddaa7cf0c352aebb5051d6efcfad169c963f4daa63a795dd2c89fb27d16786a4c7d45ec7cf74cc8  remove-wadsrc_bm-from-cmakelists.patch
"
