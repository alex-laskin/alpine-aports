# Maintainer: Dylan Van Assche <dylan@postmarketos.org>
# Contributor: Dylan Van Assche <dylan@postmarketos.org>
pkgname=hexagonrpcd
pkgver=0.4.0
pkgrel=1
pkgdesc="Qualcomm HexagonFS daemon"
url="https://github.com/linux-msm/hexagonrpc"
# s390x: fails on 1 test. Hexagonrpcd is specific to Qualcomm ARM SoCs, so let's ignore it for now.
arch="all !s390x"
license="GPL-3.0-or-later"
makedepends="linux-headers meson"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-openrc"

source="$pkgname-$pkgver.tar.gz::https://github.com/linux-msm/hexagonrpc/archive/refs/tags/v$pkgver.tar.gz
	10-fastrpc.rules
	$pkgname-adsp-rootpd.initd
	$pkgname-adsp-sensorspd.initd
	$pkgname-sdsp.initd
	"
builddir="$srcdir/hexagonrpc-$pkgver"

build() {
	abuild-meson -Db_lto=true . output
	meson compile -C output
}

check() {
	meson test -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	# Allow access for FastRPC node for FastRPC user/group
	install -Dm644 "$srcdir"/10-fastrpc.rules -t "$pkgdir"/usr/lib/udev/rules.d/

	install -Dm755 "$srcdir"/$pkgname-adsp-rootpd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-rootpd
	install -Dm755 "$srcdir"/$pkgname-adsp-sensorspd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-sensorspd
	install -Dm755 "$srcdir"/$pkgname-sdsp.initd "$pkgdir"/etc/init.d/$pkgname-sdsp
}


sha512sums="
18ebe4beeed97018243bec5043b8395c07c76f1174085e41a32648fd481485076fefffa091700ca1f72163687405456e5537aa538bc4f08fecacb3f83e3a82d8  hexagonrpcd-0.4.0.tar.gz
f931cf5f901a7c17ffb0eb194b5de2c532fd238692898bf264c484b13b93119c9727bd8f8daf6a7d1668cc9108a9a0662231d300c6f1376e3e4edd3ce41d235d  10-fastrpc.rules
314962528a610e3fe311f1cac96feb6dda2ba5a425dff4002e98cb9b5c23bb3b95e7df9f16807cbd2a6d2de5474dc566f3af59580303fb83cf893ebcbbe8fc2f  hexagonrpcd-adsp-rootpd.initd
1f34b4bd37b82cc02247c1ed9c7b417dff8947bef8d6e77b515b5319ab7dea57753d41d19cc072ab0c2a3bb4b415dcb7b3ba2dba73803638f4933fc3f5dc784d  hexagonrpcd-adsp-sensorspd.initd
2313906375eb34a7b9b19fdad14d34dbf39d1c0d6244483bb419227bb16d64cb46a3c367285fce54c8df7a6ac6b4ca00f475c9520803ef7d6c8f2e2e0459adfa  hexagonrpcd-sdsp.initd
"
