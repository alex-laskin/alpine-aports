From f6a7a98916b635524f1d9548324d24899df11f52 Mon Sep 17 00:00:00 2001
From: Achill Gilgenast <achill@achill.org>
Date: Fri, 26 Sep 2025 09:47:14 +0200
Subject: [PATCH] ffmpegthumbs: Backport ffmpeg 8 fixes

Ref: https://invent.kde.org/multimedia/ffmpegthumbs/-/commit/b673e4a1b798dc8099ecf1e9b04a02cebebfdf3f
---
 src/utils/ffmpegthumbs/moviedecoder.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/src/utils/ffmpegthumbs/moviedecoder.cpp b/src/utils/ffmpegthumbs/moviedecoder.cpp
index 95779a9..bfae4d6 100644
--- a/src/utils/ffmpegthumbs/moviedecoder.cpp
+++ b/src/utils/ffmpegthumbs/moviedecoder.cpp
@@ -11,6 +11,7 @@
 
 extern "C" {
 #include <libswscale/swscale.h>
+#include <libavcodec/version.h>
 #include <libavutil/imgutils.h>
 }
 
@@ -87,7 +88,11 @@ void MovieDecoder::destroy()
 {
     deleteFilterGraph();
     if (m_pVideoCodecContext) {
+#if LIBAVCODEC_VERSION_MAJOR >= 60
+        avcodec_free_context(&m_pVideoCodecContext);
+#else
         avcodec_close(m_pVideoCodecContext);
+#endif
         m_pVideoCodecContext = nullptr;
     }
 
@@ -211,7 +216,11 @@ void MovieDecoder::seek(int timeInSeconds)
         }
 
         ++keyFrameAttempts;
+#if LIBAVCODEC_VERSION_MAJOR >= 60
+    } while ((!gotFrame || !(m_pFrame->flags & AV_FRAME_FLAG_KEY)) && keyFrameAttempts < 200);
+#else
     } while ((!gotFrame || !m_pFrame->key_frame) && keyFrameAttempts < 200);
+#endif
 
     if (gotFrame == 0) {
         qDebug() << "Seeking in video failed";
@@ -365,7 +374,11 @@ bool MovieDecoder::processFilterGraph(AVFrame *dst, const AVFrame *src,
 
 void MovieDecoder::getScaledVideoFrame(int scaledSize, bool maintainAspectRatio, VideoFrame& videoFrame)
 {
+#if LIBAVCODEC_VERSION_MAJOR >= 60
+    if (m_pFrame->flags & AV_FRAME_FLAG_INTERLACED) {
+#else
     if (m_pFrame->interlaced_frame) {
+#endif
         processFilterGraph((AVFrame*) m_pFrame, (AVFrame*) m_pFrame, m_pVideoCodecContext->pix_fmt,
                               m_pVideoCodecContext->width, m_pVideoCodecContext->height);
     }
-- 
GitLab

