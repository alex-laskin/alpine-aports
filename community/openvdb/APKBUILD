# Contributor: Leon Marz <main@lmarz.org>
# Maintainer: Leon Marz <main@lmarz.org>
pkgname=openvdb
pkgver=12.1.1
pkgrel=0
pkgdesc="Sparse volume data structure and tools"
url="https://www.openvdb.org/"
arch="aarch64 x86_64" # tests fail on all other arches
license="MPL-2.0"
makedepends="cmake
	blosc-dev
	boost-dev
	gtest-dev
	onetbb-dev
	python3-dev
	py3-nanobind
	samurai
	"
subpackages="$pkgname-static $pkgname-nanovdb:nanovdb:noarch $pkgname-tools:tools $pkgname-dev py3-$pkgname:python"
source="$pkgname-$pkgver.tar.gz::https://github.com/AcademySoftwareFoundation/openvdb/archive/v$pkgver.tar.gz"
# deadlocked unit tests on builders
[ "$CARCH" = "aarch64" ] && options="$options !check"


build() {
	local py_version=$(python3 -c 'import sys; print("%i.%i" % (sys.version_info.major, sys.version_info.minor))')

	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=Release \
		-DOPENVDB_BUILD_PYTHON_MODULE=ON \
		-DOPENVDB_BUILD_UNITTESTS=ON \
		-DOPENVDB_BUILD_NANOVDB=ON \
		-DOPENVDB_ENABLE_RPATH=OFF \
		-Dnanobind_DIR="/usr/lib/python$py_version/site-packages/nanobind/cmake"

	cmake --build build -j $(($(nproc) / 2))
}

check() {
	cd build
	ctest
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

tools() {
	pkgdesc="$pkgdesc (Tools)"
	amove usr/bin
}

nanovdb() {
	pkgdesc="$pkgdesc (nanovdb)"
	amove usr/include/nanovdb
}

python() {
	pkgdesc="$pkgdesc (Python bindings)"
	amove 'usr/lib/python3*'
}

sha512sums="
3ca5f7656aa0bf753ae2bd4f8c40f2e0eec48a22a187fbd519e6a42c2f2b3c9a4b2f32d4a2daa692894af712e13172dfb4ca2e9af99b4d63196bf6b74c87ffb5  openvdb-12.1.1.tar.gz
"
