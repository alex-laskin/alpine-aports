# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=tokay
pkgver=0.6.12
pkgrel=0
pkgdesc="Programming language for ad-hoc parsing and syntax-based development"
url="https://tokay.dev/"
# s390x: nix crate
arch="all !s390x"
license="MIT"
makedepends="cargo cargo-auditable"
subpackages="$pkgname-doc"
source="https://github.com/tokay-lang/tokay/archive/v$pkgver/tokay-$pkgver.tar.gz
	try-testing-release-executable.patch
	nix-crate-loongarch64.patch
	"

# taken from main/rust/APKBUILD
_clear_vendor_checksums() {
	sed -i 's/\("files":{\)[^}]*/\1/' vendor/$1/.cargo-checksum.json
}

prepare() {
	mkdir -p .cargo
	cat >> .cargo/config.toml <<-EOF
		[source.crates-io]
		replace-with = "vendored-sources"

		[source.vendored-sources]
		directory = "vendor"
	EOF

	cargo vendor --locked
	_clear_vendor_checksums nix-0.20.2
	default_prepare
}

build() {
	cargo auditable build --frozen --release
}

check() {
	cargo test --frozen
}

package() {
	local targetdir="target/${CARGO_BUILD_TARGET:+$CARGO_BUILD_TARGET/}"

	install -Dvm755 $targetdir/release/tokay -t "$pkgdir"/usr/bin/

	mkdir -p "$pkgdir"/usr/share/doc/$pkgname
	cp -R examples "$pkgdir"/usr/share/doc/$pkgname/
	install -Dvm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

sha512sums="
b223e4b0fadb8e6a572e816143a5d3c3d540c0e238f65d562147a89901a4f44287f6227fd2ef22819c13e8ed0e7e76f31506303ba45c8281aaddb8e6ce301d2f  tokay-0.6.12.tar.gz
960dcf94e1475349cb38431d869ce2052400e92f323f518deec302958e41a1a046611e18a46f4585a4e4c1641804eb4c7e47a496abf66fc5f298a3af65b97905  try-testing-release-executable.patch
04fa0903e49774047662c7e2d7c63bdb0b6f229a9564643a7893c0ea4c102cbbdfcabfcd69546645075e5602d728c42b1e311be7be18610e78e54172a60c5b57  nix-crate-loongarch64.patch
"
