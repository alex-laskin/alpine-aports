# Maintainer: Nathan Angelacos <nangel@alpinelinux.org>
pkgname=handbrake
_pkgname=HandBrake
pkgver=1.10.2
pkgrel=2
pkgdesc="Handbrake video transcoder"
url="https://handbrake.fr"
# x86, armhf, armv7: no svt-av1
arch="all !x86 !armhf !armv7"
license="GPL-2.0-only"
makedepends="
	autoconf
	automake
	bash
	bzip2-dev
	cmake
	dav1d-dev
	ffmpeg7-dev
	fontconfig-dev
	freetype-dev
	fribidi-dev
	glib-dev
	gst-plugins-base-dev
	gtk4.0-dev
	jansson-dev
	lame-dev
	libass-dev
	libbluray-dev
	libdvdnav-dev
	libdvdread-dev
	libgudev-dev
	libnotify-dev
	libogg-dev
	libtheora-dev
	libtool
	libva-dev
	libvorbis-dev
	libvpx-dev
	linux-headers
	meson
	nasm
	numactl-dev
	opus-dev
	python3
	speex-dev
	svt-av1-dev
	tinyxml-dev
	x264-dev
	x265-dev
	xz-dev
	zlib-dev
	zimg-dev
	"
subpackages="$pkgname-lang $pkgname-gtk"
source="https://github.com/HandBrake/HandBrake/releases/download/$pkgver/HandBrake-$pkgver-source.tar.bz2
	handbrake-9999-remove-dvdnav-dup.patch
	fix-missing-libva-link-flag.patch
	fix-missing-x265-link-flag.patch
	"
builddir="$srcdir/$_pkgname-$pkgver"
options="!check"

case "$CARCH" in
	# Enable support HW acceleration on Intel GPUs (Quick Sync Video).
	x86_64)
		makedepends="$makedepends libvpl-dev"
		_conf_flags='--enable-qsv'
		export CFLAGS="$CFLAGS -I/usr/include/vpl"
		export CXXFLAGS="$CXXFLAGS -I/usr/include/vpl"
		export LDFLAGS="$LDFLAGS -lvpl -lva -lva-drm"
		;;
	*)
		_conf_flags='--disable-qsv'
		;;
esac

# This is a video transcoder, performance is the most important.
export CFLAGS="$CFLAGS -O2 -flto=auto"
export CXXFLAGS="$CXXFLAGS -O2 -flto=auto"
export CPPFLAGS="$CPPFLAGS -O2 -flto=auto"

prepare() {
	default_prepare
	# build against external libs
	sed -i '/MODULES.*contrib\//d' \
		make/include/main.defs
}

build() {
	# Create the contrib/include directory that GTK build expects
	mkdir -p build/contrib/include

	./configure \
		--prefix=/usr \
		--force \
		--verbose \
		--disable-nvenc \
		--enable-numa \
		--enable-x265 \
		--disable-df-fetch \
		$_conf_flags

	make -C build
}

package() {
	make -C build -j1 install DESTDIR="$pkgdir"
}

gtk() {
	pkgdesc="HandBrake Video Transcoder - GUI"

	amove usr/bin/ghb
	amove usr/share
}

sha512sums="
a1166ffb1597179e1ca58519cb6a7865ffbdedd5f1feda789cdb17cee94a9bb62b120926462bbc34b93c7ea53825099c45f70e809de7c456c88b60fce157b645  HandBrake-1.10.2-source.tar.bz2
a3d57dd37d518286a62554cfcc4722d6fd588a0c3966d30785100edc4476febb2b48fc4f9b2a7eb5b5dc049043fabd4398e1e190e10cbd63c25b2936824977d3  handbrake-9999-remove-dvdnav-dup.patch
26bc7d48436335d4d34ab5022a32d7bbff9d1bfab9f1398cb763cf27da71529a20784a00131825f2b140c2ce80a73e608ee4fb2f9736badb15e5d0a67dbbcf53  fix-missing-libva-link-flag.patch
59dc985a3664849556890bd92abc7e652e47ace066f33894d518abe97439bedc00c7cc6832ec49e81aea509b51ff6b64888bfbf32d74a03634bd6578aecee3f0  fix-missing-x265-link-flag.patch
"
