# Contributor: Clayton Craft <clayton@craftyguy.net>
maintainer="Clayton Craft <clayton@craftyguy.net>"
pkgname=stellarsolver
pkgver=2.7
pkgrel=0
pkgdesc="SEP-based star extractor and astrometry.net-based internal astrometric solver"
url="https://github.com/rlancaste/stellarsolver"
# armhf blocked by qt6-qtdeclarative
arch="all !armhf"
license="GPL-3.0-or-later"
makedepends="
	cfitsio-dev
	cmake
	gsl-dev
	qt6-qtbase
	qt6-qtdeclarative-dev
	samurai
	wcslib-dev
"
checkdepends="xwayland-run"
subpackages="$pkgname-dev"
source="
	https://github.com/rlancaste/stellarsolver/archive/$pkgver/stellarsolver-$pkgver.tar.gz
	https://data.astrometry.net/4100/index-4107.fits
	https://data.astrometry.net/4100/index-4110.fits
	0001-Fix-qsort_r-handling.patch
"

# Tests fail/segfault on 32-bit arch builders
case "$CARCH" in
	armhf|armv7|x86) options="!check";;
esac

prepare() {
	default_prepare
	mkdir -p build
	ln -s "$srcdir" build/astrometry
}

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake3.5 -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		-DUSE_QT5=OFF \
		-DBUILD_TESTER="$(want_check && echo ON || echo OFF)" \
		-DBUILD_TESTS="$(want_check && echo ON || echo OFF)" \
		$crossopts
	cmake --build build
}

check() {
	# Tests do not appear to be automatically run by ctest
	# Invoke separately for now based on CMakeLists.txt
	# ctest --test-dir build
	cd build
	xwfb-run ./TestTwoStellarSolvers
	xwfb-run ./TestDeleteSolver
	xwfb-run ./TestMultipleSyncSolvers
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
f666023bcc4e5c83d5a88224ebe524a490852d7b2aab89a52f596aa891f965367a6057997592eab50035f55565e330cf0a48074d2bf339fbaa78afdf56fda876  stellarsolver-2.7.tar.gz
4ed9722089a8cd85675e651d299063654dd24260a2afa802c18d145b6cc307404a2720a3746fd37043af76cf74fc1a97880db56069cf4b8c31f9f9b0774d6b91  index-4107.fits
569fa60acb8df532371f85126d64db62445aab14443a7022b534f793155b0e237e454d4b2a26d5e767539256bbab8f0eb398d7fab5fd8729b6008f77db2d4a62  index-4110.fits
056e3ffa5d59ed97557fc08b678753dded77833923fa8b8ddb6dda7f156bbd7a8aa31740370f96f43ef4869ae8597bf8a2b71e83954d896a7bd5be81bbd3d424  0001-Fix-qsort_r-handling.patch
"
