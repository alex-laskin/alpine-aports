# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=py3-rfl
pkgver=1.6.0
pkgrel=0
pkgdesc="Rackslab Foundation Library"
url="https://github.com/rackslab/RFL"
arch="noarch"
license="GPL-3.0-or-later"
depends="python3"
makedepends="py3-gpep517 py3-setuptools py3-wheel"
checkdepends="py3-pytest
	py3-flask
	py3-jwt
	py3-ldap
	py3-pyaml
	"
subpackages="$pkgname-core:_core $pkgname-core-pyc:_rfl_pyc
	$pkgname-authentication:_authentication $pkgname-authentication-pyc:_rfl_pyc
	$pkgname-build:_build $pkgname-build-pyc:_rfl_pyc
	$pkgname-log:_log $pkgname-log-pyc:_rfl_pyc
	$pkgname-permissions:_permissions $pkgname-permissions-pyc:_rfl_pyc
	$pkgname-settings:_settings $pkgname-settings-pyc:_rfl_pyc
	$pkgname-web:_web $pkgname-web-pyc:_rfl_pyc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/rackslab/RFL/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/RFL-$pkgver"

prepare() {
	default_prepare

	# missing in source tarball, last checked in 1.5.0
	touch "$builddir"/src/log/rfl/tests/__init__.py
}

build() {
	gpep517 build-wheel --wheel-dir .dist --output-fd 3 3>&1 >&2

	for subpkg in core authentication build log permissions settings web; do
		cd "$builddir"/src/"$subpkg"
		gpep517 build-wheel --wheel-dir .dist --output-fd 3 3>&1 >&2
	done
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	for subpkg in core authentication build log permissions settings web; do
		.testenv/bin/python3 -m installer src/"$subpkg"/.dist/*.whl
		echo "TESTING SUBPACKAGE $subpkg"
		.testenv/bin/python3 -m unittest discover -v src/"$subpkg"/rfl
	done
}

package() {
	pkgdesc="$pkgdesc: meta package"
	depends="$pkgname-core
		$pkgname-authentication
		$pkgname-build
		$pkgname-log
		$pkgname-permissions
		$pkgname-web
		"

	mkdir -p "$pkgdir"
}

_rfl_pyc() {
	_rflpkgname="${subpkgname%-pyc}"
	_rflpkgdir="${subpkgdir%-pyc}"
	_pyver="$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')"
	_subpath="usr/lib/python$_pyver/site-packages/rfl/${_rflpkgname#py3-rfl-}"

	pkgdesc="Precompiled Python bytecode for $_rflpkgname"
	install_if="$_rflpkgname=$pkgver-r$pkgrel pyc"

	mkdir -p "$subpkgdir"/"$_subpath"
	mv "$_rflpkgdir"/"$_subpath"/__pycache__ "$subpkgdir"/"$_subpath"/
}

_core() {
	pkgdesc="$pkgdesc: core package"
	depends="python3"

	cd "$builddir"/src/core
	python3 -m installer -d "$subpkgdir" .dist/*.whl
}

_authentication() {
	pkgdesc="$pkgdesc: authentication package"
	depends="$pkgname-core
		py3-ldap
		py3-jwt
		"

	cd "$builddir"/src/authentication
	python3 -m installer -d "$subpkgdir" .dist/*.whl
}

_build() {
	pkgdesc="$pkgdesc: build package"
	depends="$pkgname-core
		py3-tomli
		"

	cd "$builddir"/src/build
	python3 -m installer -d "$subpkgdir" .dist/*.whl
}

_log() {
	pkgdesc="$pkgdesc: log package"
	depends="$pkgname-core"

	cd "$builddir"/src/log
	python3 -m installer -d "$subpkgdir" .dist/*.whl
}

_permissions() {
	pkgdesc="$pkgdesc: permissions package"
	depends="$pkgname-core $pkgname-authentication
		py3-pyaml
		"

	cd "$builddir"/src/permissions
	python3 -m installer -d "$subpkgdir" .dist/*.whl
}

_settings() {
	pkgdesc="$pkgdesc: settings package"
	depends="$pkgname-core
		py3-pyaml
		"

	cd "$builddir"/src/settings
	python3 -m installer -d "$subpkgdir" .dist/*.whl
}

_web() {
	pkgdesc="$pkgdesc: web package"
	depends="$pkgname-core $pkgname-permissions
		py3-flask
		"

	cd "$builddir"/src/web
	python3 -m installer -d "$subpkgdir" .dist/*.whl
}

sha512sums="
5efcf9b6a5dfccd7341b76e8d3e09d2019c0bc9847d4b75282f0b04483ff39210cc7010e2a6399693d0adc5e7546395cdda00ca834cbd7aa3623ea9b06e3d431  py3-rfl-1.6.0.tar.gz
"
