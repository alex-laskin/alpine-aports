# Contributor: Duncan Bellamy <dunk@denkimushi.com>
# Maintainer: Duncan Bellamy <dunk@denkimushi.com>
pkgname=vectorscan
pkgver=5.4.12
pkgrel=1
pkgdesc="High-performance regular expression matching library"
url="https://www.hyperscan.io"
# requires SSSE3, Neon, or VSX
arch="x86_64 aarch64 ppc64le"
license="BSD-3-Clause"
_llvmver=21
makedepends="
	boost-dev
	chrpath
	clang$_llvmver
	cmake
	llvm$_llvmver-dev
	pcre-dev
	ragel
	samurai
	sqlite-dev
	"
subpackages="$pkgname-doc $pkgname-static $pkgname-dev $pkgname-utils"
source="$pkgname-$pkgver.tar.gz::https://github.com/VectorCamp/vectorscan/archive/refs/tags/vectorscan/$pkgver.tar.gz
	gcc12.patch
	fix-unit-gtest.patch
	"
builddir="$srcdir/$pkgname-$pkgname-$pkgver"

build() {
	export PATH="$PATH:/usr/lib/llvm$_llvmver/bin"
	export CC=clang
	export CXX=clang++
	export CFLAGS="$CFLAGS -flto=thin"
	export CXXFLAGS="$CXXFLAGS -flto=thin"

	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DBUILD_SHARED_LIBS=ON \
		-DBUILD_STATIC_LIBS=ON \
		-DFAT_RUNTIME=OFF \
		$CMAKE_CROSSOPTS
	cmake --build build --target all
}

check() {
	cd build
	./bin/unit-hyperscan
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	for _f in hsbench hscheck; do
		chrpath -d "$builddir/build/bin/$_f"
		install -Dm755 "$builddir/build/bin/$_f" -t "$pkgdir"/usr/bin/
	done
}

utils() {
	pkgdesc="$pkgdesc (utils)"

	amove usr/bin/hsbench usr/bin/hscheck
}

sha512sums="
b9e750cb53a109ebed6e472cccbd280434c4a8e6a9217acfd30c10cc88381712de2444d31794a1f0bebc0b5ca0def21c031234bc1706f4029d51d2830f0cb5ac  vectorscan-5.4.12.tar.gz
f41f5f0b86226e23b926236bfec15d79ab54c8f91647abbeb8ed0dcdef223a162bea1a93933b29f56cfe67f2f22fe214198cf167b2cfb19d2a93c417a449803d  gcc12.patch
64db64726a22c04bc09ea9305ab4e21875f2ef3b7fe3ab2810b2619ee776ee85dccfd1ccde598e5cf3575957c88444d20986bf408f515277310abe946c988404  fix-unit-gtest.patch
"
