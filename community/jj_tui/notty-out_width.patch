Patch-Source: https://github.com/ocaml-dune/notty/pull/10
--
From c388d60af47ebd8106115cb7d5c10d6903be38f7 Mon Sep 17 00:00:00 2001
From: Marek Kubica <marek@tarides.com>
Date: Fri, 14 Feb 2025 11:12:47 +0100
Subject: [PATCH] Update code to use the default definition of `out_width` on
 OCaml 5.4+

Introduced in https://github.com/ocaml/ocaml/pull/13570

Signed-off-by: Marek Kubica <marek@tarides.com>
---
 src/notty.ml | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

--- a/forks/notty/src/notty.ml
+++ b/forks/notty/src/notty.ml
@@ -385,7 +385,12 @@ module I = struct
 
     let create () =
       let img, line, attr = ref empty, ref empty, ref [] in
-      let fmt = formatter_of_out_functions {
+      (* OCaml 5.4 added a new record field so to keep compatibility, get and
+         update the record, even if warning 23 "useless-record-with" is
+         triggered, about all fields being updated in <5.4. *)
+      let formatter_out_functions = get_formatter_out_functions () in
+      let[@warning "-23"] formatter_out_functions = {
+        formatter_out_functions with
           out_flush = (fun () ->
             img := !img <-> !line; line := empty; attr := [])
         ; out_newline = (fun () ->
@@ -395,7 +400,9 @@ module I = struct
         (* Not entirely clear; either or both could be void: *)
         ; out_spaces = (fun w -> line := !line <|> char (top_a attr) ' ' w 1)
         ; out_indent = (fun w -> line := !line <|> char (top_a attr) ' ' w 1)
-      } in
+      }
+      in
+      let fmt = formatter_of_out_functions formatter_out_functions in
       pp_set_formatter_stag_functions fmt {
         (pp_get_formatter_stag_functions fmt ()) with
             mark_open_stag =
