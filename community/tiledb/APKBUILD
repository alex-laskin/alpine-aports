# Contributor: Holger Jaekel <holger.jaekel@gmx.de>
# Maintainer: Holger Jaekel <holger.jaekel@gmx.de>
pkgname=tiledb
pkgver=2.29.1
pkgrel=0
pkgdesc="Engine for storing and accessing dense and sparse multi-dimensional arrays"
url="https://tiledb.com/"
# Tests fail on s390x
# doesn't build on 32-bit
arch="all !armhf !armv7 !x86 !s390x"
license="MIT"
makedepends="
	abseil-cpp-dev
	blosc-dev
	bzip2-dev
	capnproto-dev
	catch2-3
	clang
	cmake
	crc32c-dev
	curl-dev
	doxygen
	file-dev
	google-cloud-cpp-dev
	libpng-dev
	lz4-dev
	nlohmann-json
	openssl-dev
	rapidcheck-dev
	samurai
	spdlog-dev
	zlib-dev
	zstd-dev
	"
subpackages="
	$pkgname-dev
	"
source="tiledb-$pkgver.tar.gz::https://github.com/TileDB-Inc/TileDB/archive/refs/tags/$pkgver.tar.gz
	https://raw.githubusercontent.com/muellan/clipp/v1.2.3/include/clipp.h
	10-compression.patch
	20-catch.patch
	70-avx2.patch
	gcc-15.patch
	"
builddir="$srcdir/TileDB-$pkgver"

# secfixes:
#   2.17.4-r0:
#     - CVE-2023-5129

# Optional dependencies aws-* are not available on s390x and ppc64le
_with_s3="OFF"
case "$CARCH" in
arm*|s390x|ppc64le) ;;
*)
# S3 support presently fails to build from source with current AWS SDK.
#	makedepends="$makedepends aws-crt-cpp-dev aws-sdk-cpp-dev"
#	_with_s3="ON"
	;;
esac

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	CXXFLAGS="$CXXFLAGS -Wno-deprecated-declarations" \
	LDFLAGS="$LDFLAGS -Wl,--copy-dt-needed-entries" \
	TILEDB_DISABLE_AUTO_VCPKG=OFF \
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=None \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_SKIP_RPATH=ON \
		-DTILEDB_VERBOSE=OFF \
		-DTILEDB_HDFS=OFF \
		-DTILEDB_S3=$_with_s3 \
		-DTILEDB_AZURE=OFF \
		-DTILEDB_GCS=ON \
		-DTILEDB_SERIALIZATION=ON \
		-DTILEDB_TOOLS=OFF \
		-DTILEDB_WERROR=OFF \
		-DTILEDB_CPP_API=ON \
		-DTILEDB_STATS=ON \
		-DTILEDB_TESTS="$(want_check && echo ON || echo OFF)" \
		-DTILEDB_CCACHE=OFF \
		-DTILEDB_ARROW_TESTS=OFF \
		-DTILEDB_WEBP=OFF \
		$crossopts

	# compile Capâ€™n Proto schema with the current version
	cd "$builddir/tiledb/sm/serialization"
	capnp compile -oc++:. tiledb-rest.capnp
	cd "$builddir"

	cmake --build build
	if want_check; then
		cmake --build build --target tests
	fi
}

check() {
	ctest --test-dir build \
		-R '^unit_|test_assert' -E 'unit_capi_query_plan|unit_capi_query_aggregate|unit_capi_current_domain|unit_capi_vfs|unit_capi_ndrectangle|unit_array_schema|unit_run_filter_pipeline|unit_vfs'
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
4359836f85911db067b7cb3502c5a5f4272971c8f5276e0375a7faf483e3a9003fc9ee392e1b830e254048914dc61eca5f858d189454a35b157462677b210955  tiledb-2.29.1.tar.gz
0a801eff46581a96e571b41ce734d5a8e7f30333d46e3fb81c4c40fc44c18035d4b4597732221e37945ad23b94e53e496562ae4b24d358761dbf5ed803f66ff4  clipp.h
a39fd01dc509669337d17641e343292b7fb3e8100e6a20912c31088d6806a9e0c0cb286c8979f66614f289bca6e525129df3c564da4ba1af2d803e2636fa3c9d  10-compression.patch
41933edbb34371c4826dbfbe807a2d827381c192362a0cbe89cea643a4093379d59e4dea4a7afa3d2ad2549129cad1da6093e5ce1a86f665e10654801dd0d990  20-catch.patch
86e5f9722e4ef8524b96d059ba434508cf03e3c264ec3bfcaf3585dae5584f4863e4bbc6f34be68e653df18cd7d827f8fc36b058acdc4636609412526bc95d5b  70-avx2.patch
8d031f7fbcee0d569d43bf11c4b8ea15bd98d45cf01f07ff63312e91ee85712de9a60568e1543b1f9d1b13f38403d5ea9e543d6f6743b765019cd552494c9d5b  gcc-15.patch
"
