# Contributor: Angelo Verlain <hey@vixalien.com>
# Maintainer: Angelo Verlain <hey@vixalien.com>
pkgname=gnome-software-plugin-apk2
pkgver=0.0.3
pkgrel=0
pkgdesc="Yet Another APK plugin for GNOME Software"
url="https://github.com/vixalien/gnome-software-plugin-apk2"
arch="all"
license="GPL-2.0-or-later"
makedepends="
	meson
	gnome-software-dev
	apk-polkit-rs-dev
	appstream-dev
	gobject-introspection-dev
	vala
	"
checkdepends="py3-dbusmock gnome-software !gnome-software-plugin-apk"
subpackages="$pkgname-dbg"
source="$pkgname-$pkgver.tar.gz::https://github.com/vixalien/gnome-software-plugin-apk2/archive/$pkgver.tar.gz
	"
provides="gnome-software-plugin-apk=1.0.0"
case "$CARCH" in
	riscv64) options="$options !check" #TODO: fix tests on riscv64
esac

build() {
	abuild-meson . output

	# convoluted build process
	cd output
	ninja src/vapi/Gs-49.gir
	ninja src/vapi/ApkPolkit2-0.gir
	ninja src/vapi/gnome-software.vapi
	ninja src/vapi/apk-polkit-client-2.vapi
	ninja
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

check() {
	dbus-run-session -- sh -c '
		python3 -m dbusmock --session --template tests/apkpolkit2.py &
		meson test --no-rebuild --print-errorlogs -C output
	'
}
sha512sums="
a43b76c2cfda61078fdcb8475f8381c325d4a6d7993c7cecc0ecd0daa12c7591d7102a44d891e5d1809c5dd319ff2251f254d1d8419dde2326cc361975fdcaf3  gnome-software-plugin-apk2-0.0.3.tar.gz
"
