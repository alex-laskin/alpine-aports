# Maintainer: Marian Buschsieweke <marian.buschsieweke@posteo.net>
pkgname=tinycbor
pkgver=0.6.1
pkgrel=0
pkgdesc="Concise Binary Object Representation (CBOR) Library"
url="https://github.com/intel/tinycbor"
checkdepends="qt6-qtbase-dev"
arch="all"
license="MIT"
subpackages="$pkgname-dev lib$pkgname:libs"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/intel/tinycbor/archive/v$pkgver.tar.gz
	0001-disable-failing-tests.patch
	recursion.patch
	"

_make() {
	make CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" BUILD_SHARED=1 \
		QMAKE=qmake6 prefix=/usr "$@"
}

build() {
	_make
}

check() {
	case "$CARCH" in
		# FIXME
		ppc64le|loongarch64) export PARSER_NO_MMAP=1 ;;
	esac
	_make check
}

package() {
	_make DESTDIR="$pkgdir" BUILD_STATIC=0 install
}

sha512sums="
7c7fff9c1e9a2f04a3bb0247b79723526685b2821df720d0211c8e86b1a516c955926b3668fa6dcdaaf6cb811aff238db39a9add1bc12a4d32f8a51741f3f2ce  tinycbor-0.6.1.tar.gz
388dafc40b674d72649e9b687142d75d687bf6f1cf156d160a183abd4b73e175d357d4daede8a530789539e630cef447563483d267c7fd2744de579dcdec4c9f  0001-disable-failing-tests.patch
13317d85a6dff3c737b2e816eb12ea245b4602f968ea3254db81f0045baf57383cc33fc6a86116796f5ba1bf6992014faf4ae0e178b4d9bd976cfdc74c475126  recursion.patch
"
