# Contributor: xrs <xrs@mail36.net>
# Maintainer: xrs <xrs@mail36.net>
pkgname=gnunet
# version needs to be (vaguely) kept in sync with gnunet-gtk
pkgver=0.25.2
pkgrel=0
pkgdesc="A framework for secure and privacy enhancing peer-to-peer networking"
url="https://gnunet.org"
# ppc64le, s390x, riscv64 and loongarch64 blocked by luatex -> texlive
arch="all !s390x !ppc64le !riscv64 !loongarch64"
license="AGPL-3.0-only"
depends="
	gnutls-utils
	iptables
	nss-tools
	openssl
	runit
	which"
makedepends="
	curl-dev
	gettext-dev
	gmp-dev
	gnutls-dev
	jansson-dev
	jose-dev
	libgcrypt-dev
	libgpg-error-dev
	libidn2-dev
	libmicrohttpd-dev
	libsodium-dev jose-dev
	libtool
	libunistring-dev
	meson
	miniupnpc-dev
	nettle-dev
	nss-dev
	openjpeg-dev
	openssl-dev>3
	py3-sphinx
	py3-sphinx_rtd_theme
	python3
	sqlite-dev
	texinfo
	texlive
	texlive-luatex
	unbound-dev
	zlib-dev"
checkdepends="
	bash
	coreutils
	python3
	"
install="$pkgname.pre-install $pkgname.post-install"
pkgusers="gnunet"
pkggroups="gnunet gnunetdns"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-lang
	$pkgname-openrc"
options="!check suid" # No check: GNUnet checks can only run after install
source="https://ftpmirror.gnu.org/gnu/gnunet/gnunet-$pkgver.tar.gz
	$pkgname-system.conf
	$pkgname-system-services.initd
	$pkgname-user-services.initd
	setup-$pkgname-user
	gcc-15.patch
	"

build() {
	abuild-meson build
	meson compile -C build
}

package() {
	DESTDIR="$pkgdir" meson install -C build

	libexecdir=$pkgdir/usr/lib/gnunet/libexec/
	# Limit access to critical gnunet-helper-dns to group "gnunetdns"
	chgrp gnunetdns $libexecdir/gnunet-helper-dns
	chgrp gnunetdns $libexecdir/gnunet-service-dns
	# Limit access to certain SUID binaries by group "gnunet"
	chgrp gnunet    $libexecdir/gnunet-helper-exit
	chgrp gnunet    $libexecdir/gnunet-helper-vpn
	chgrp gnunet    $libexecdir/gnunet-helper-nat-client
	chgrp gnunet    $libexecdir/gnunet-helper-nat-server
	chmod u+s       $libexecdir/gnunet-helper-exit
	chmod u+s       $libexecdir/gnunet-helper-vpn
	chmod 2750      $libexecdir/gnunet-helper-dns
	chmod 2700      $libexecdir/gnunet-service-dns
	chmod u+s       $libexecdir/gnunet-helper-nat-client
	chmod u+s       $libexecdir/gnunet-helper-nat-server

	install -m644 -D $srcdir/$pkgname-system.conf \
		$pkgdir/etc/$pkgname.conf
	install -m755 -D $srcdir/$pkgname-system-services.initd \
		$pkgdir/etc/init.d/$pkgname-system-services
	install -m755 -D $srcdir/$pkgname-user-services.initd \
		$pkgdir/etc/init.d/$pkgname-user-services
	install -m755 -D $srcdir/setup-$pkgname-user \
		$pkgdir/usr/bin/setup-$pkgname-user
	install -dm0755 -o $pkgusers \
		$pkgdir/var/run/$pkgname
}

dev() {
	default_dev

	# dev() will move gnunet-config from $pkg to $pkg-dev, but it's an
	# intended part of $pkg.
	mv $subpkgdir/usr/bin/gnunet-config $pkgdir/usr/bin/
}

sha512sums="
c40d0a8108d312b0140a1acd02a0a111ba8e2d8b31f53583e1834753bf7679e1dc903fdf50b1d93f844322a78903a35a95e8997c5f9bd44a31bc0c9484b20b73  gnunet-0.25.2.tar.gz
ff516b8a212ae539fee64e5c413041261d451db9867b81b759e138a8bb4dcacb4706fb5418a2e63ea63cd551aed807d20eb9073cfc2fadacc4ad7755681c6f81  gnunet-system.conf
469132bce6ddb1c7ef7a0fb175dd79e98c32e5d89313ecf8b64430ecb80205cc671f5855b8509a0e117644bc28fbe2237dc964947ef261e300055ff650102a5c  gnunet-system-services.initd
d3cf7e7004f364628f020c11d93798fbbb9b392a3818585e9981bced1f9b053a83cad0326b09ba1504e7f623e4363383759acf974631dc9aef1ef82e5059a5c3  gnunet-user-services.initd
e3fdeb11a36ba92f9995bc919879ee3d5f7358dd29c15f2474986f8e505c04edaf184ae093716ce8d7c5a549ad33a067a6ad63cbc451b200e4cf258a3aba68db  setup-gnunet-user
59f1249d07f49b9373003a50311ce2548998fad5c5b0a37a038c85cbb548eef90ac9717a706a056a0898a4b4c3110a1341263ec875ff014148509aa2fa92e911  gcc-15.patch
"
