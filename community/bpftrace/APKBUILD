# Contributor: Konstantin Kulikov <k.kulikov2@gmail.com>
# Maintainer: Adam Jensen <adam@acj.sh>
pkgname=bpftrace
pkgver=0.24.1
pkgrel=0
pkgdesc="High-level tracing language for Linux eBPF"
url="https://github.com/bpftrace/bpftrace"
arch="all !x86" # x86 unsupported
license="Apache-2.0"
_llvmver=20
makedepends="
	asciidoctor
	bcc-dev
	binutils-dev
	bison
	blazesym
	cereal
	clang$_llvmver-dev
	clang$_llvmver-extra-tools
	clang$_llvmver-static
	cmake
	elfutils-dev
	flex-dev
	libbpf-dev
	linux-headers
	llvm$_llvmver-dev
	llvm$_llvmver-gtest
	llvm$_llvmver-static
	samurai
	libxml2-dev
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/bpftrace/bpftrace/archive/v$pkgver.tar.gz
	00-location-header.patch
	01-min-32-bit.patch
	"
# Tests require root, network to download gmock and a few tests fail.
options="!check"
subpackages="$pkgname-doc:doc $pkgname-tools:tools:noarch $pkgname-tools-doc:tools_doc"

check_bcc_clang() {
	# check bcc builds with the same llvm version as we do
	local bcc_clang
	bcc_clang=$(readelf -d /usr/lib/libbcc.so.0 \
			| sed -ne 's/.*libclang-cpp.so\.\([0-9]*\)\..*/\1/p')
	if [ "$_llvmver" != "$bcc_clang" ]; then
		echo "BCC depends on LLVM $bcc_clang, update \$_llvmver (was $_llvmver)" >&2
		exit 1
	fi
}

build() {
	check_bcc_clang

	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DBUILD_TESTING=OFF \
		-DCMAKE_PREFIX_PATH=/usr/lib/llvm$_llvmver/lib/cmake \
		-DLLVM_REQUESTED_VERSION="$(/usr/lib/llvm$_llvmver/bin/llvm-config --version)"
	cmake --build build
}

# Main package contains only bpftrace binary.
package() {
	DESTDIR="$pkgdir" cmake --install build
}

# Doc package should contain only man page for bpftrace.
doc() {
	mkdir -p "$subpkgdir/usr/share/man/man8"
	mv "$pkgdir/usr/share/man/man8/bpftrace.8.gz" "$subpkgdir/usr/share/man/man8/"
}

# Tools are not installed in PATH, because they would conflict with other tools provided by bcc or perf-tools.
tools() {
	depends="$pkgname"
	pkgdesc="$pkgdesc (tools)"
	amove usr/share/bpftrace/tools
}

# Tools docs contains man pages and examples for tools.
tools_doc() {
	pkgdesc="$pkgdesc (tool docs and examples)"

	amove usr/share/man
}

sha512sums="
97ce3d909c6d6fe021afc6db4ea67dd70fa85502358ee89314d8cf58cb8727ce091bbbdf23f73d9eaadae59d8244d76530dda89993b499deebe7f90edd21cda7  bpftrace-0.24.1.tar.gz
b463ff664a4d3eba632fa7481f5e05f1a3312787e197b6afcea90410ef238b8a8b980a6ed2f69454d251098eab1f2dab72975269c3478be7b155284274df39aa  00-location-header.patch
45c8c937864b2b5e6ec8ad13670624cd77d0798760de5c27d960d48c85165ccc237974bee8fcb3dbce840ea2aed5d493b660f83ea4c103213874b44072f216a7  01-min-32-bit.patch
"
