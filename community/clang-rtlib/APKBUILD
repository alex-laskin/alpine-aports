# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=clang-rtlib
pkgver=0.1.0
pkgrel=1
pkgdesc="compiler-rt for non-default Clang"
url="https://compiler-rt.llvm.org/"
arch="all"
license="Apache-2.0"
makedepends="
	clang
	cmake
	linux-headers
	python3
	samurai
	"
_clang_vers="
	16.0.6
	18.1.8
	19.1.7
	20.1.8
	"
for _ver in $_clang_vers; do
	subpackages="$subpackages clang${_ver%%.*}-rtlib"
	source="$source
		https://github.com/llvm/llvm-project/releases/download/llvmorg-$_ver/compiler-rt-$_ver.src.tar.xz
		https://github.com/llvm/llvm-project/releases/download/llvmorg-$_ver/cmake-$_ver.src.tar.xz
		https://github.com/llvm/llvm-project/releases/download/llvmorg-$_ver/llvm-$_ver.src.tar.xz
		"
done
source="$source
	armv6-arch.patch.noauto
	1601-compiler-rt-lsan-dtp-offset.patch
	1602-compiler-rt-ppc-fixes.patch
	1603-fix-msan-with-musl.patch
	1604-gcc15-cstdint.patch
	1801-compiler-rt-lsan-dtp-offset.patch
	1802-compiler-rt-ppc-fixes.patch
	1803-fix-msan-with-musl.patch
	1901-compiler-rt-aarch64-use-getauxval.patch
	1902-compiler-rt-lsan-dtp-offset.patch
	1903-compiler-rt-ppc-fixes.patch
	1904-fix-msan-with-musl.patch
	2001-compiler-rt-lsan-dtp-offset.patch
	2002-compiler-rt-ppc-fixes.patch
	2003-fix-msan-with-musl.patch
	"
builddir="$srcdir"
options="!archcheck !check" # first try enabling it for default Clang in main/llvm-runtimes

prepare() {
	default_prepare

	case "$CARCH" in
	armhf)
		msg "armv6-arch.patch.noauto"
		for _ver in $_clang_vers; do
			patch -Np2 -i "$srcdir"/armv6-arch.patch.noauto \
				-d "$builddir"/compiler-rt-$_ver.src
		done
		;;
	esac
}

build() {
	export CFLAGS="$CFLAGS -DNDEBUG -DSANITIZER_CAN_USE_PREINIT_ARRAY=0"
	export CXXFLAGS="$CXXFLAGS -DNDEBUG -DSANITIZER_CAN_USE_PREINIT_ARRAY=0"

	local suffix
	case "$CARCH" in
	x86)		suffix="-i386"		;;
	armv7)		suffix="-armhf"		;;
	ppc64le)	suffix="-powerpc64le"	;;
	*)		suffix="-$CARCH"	;;
	esac

	local builtins=ON sanitizers=ON
	case "$CARCH" in
	arm*|x86)
		sanitizers=OFF
		;;
	s390x)
		builtins=OFF
		sanitizers=OFF
		;;
	esac

	for _ver in $_clang_vers; do
		local llvmver=${_ver%%.*}
		ln -Tsvf cmake-$_ver.src cmake
		ln -Tsvf llvm-$_ver.src llvm

		cmake -B builtins-$_ver -G Ninja -Wno-dev -S compiler-rt-$_ver.src \
			-DCMAKE_BUILD_TYPE=Release \
			-DCMAKE_ASM_COMPILER=clang \
			-DCMAKE_C_COMPILER=clang \
			-DCMAKE_C_COMPILER_TARGET="$CHOST" \
			-DCMAKE_CXX_COMPILER=clang++ \
			\
			-DCOMPILER_RT_BUILD_BUILTINS=ON \
			-DCOMPILER_RT_BUILD_CRT=OFF \
			-DCOMPILER_RT_BUILD_CTX_PROFILE=OFF \
			-DCOMPILER_RT_BUILD_LIBFUZZER=OFF \
			-DCOMPILER_RT_BUILD_MEMPROF=OFF \
			-DCOMPILER_RT_BUILD_ORC=OFF \
			-DCOMPILER_RT_BUILD_PROFILE=OFF \
			-DCOMPILER_RT_BUILD_SANITIZERS=OFF \
			-DCOMPILER_RT_BUILD_XRAY=OFF \
			-DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
			-DCOMPILER_RT_INCLUDE_TESTS=OFF
		cmake --build builtins-$_ver

		cmake -B build-$_ver -G Ninja -Wno-dev -S compiler-rt-$_ver.src \
			-DCMAKE_BUILD_TYPE=Release \
			-DCMAKE_ASM_COMPILER=clang \
			-DCMAKE_C_COMPILER=clang \
			-DCMAKE_C_COMPILER_TARGET="$CHOST" \
			-DCMAKE_CXX_COMPILER=clang++ \
			\
			-DCOMPILER_RT_BUILD_GWP_ASAN=OFF \
			-DCOMPILER_RT_BUILD_CTX_PROFILE=$sanitizers \
			-DCOMPILER_RT_BUILD_MEMPROF=$sanitizers \
			-DCOMPILER_RT_BUILD_SANITIZERS=$sanitizers \
			-DCOMPILER_RT_BUILD_XRAY=$sanitizers \
			-DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON \
			-DCOMPILER_RT_ENABLE_WERROR=OFF \
			-DCOMPILER_RT_HAS_WTHREAD_SAFETY_FLAG=OFF \
			-DCOMPILER_RT_INCLUDE_TESTS=OFF \
			-DCOMPILER_RT_INSTALL_PATH=/usr/lib/llvm$llvmver/lib/clang/$llvmver \
			-DCOMPILER_RT_LIBRARY_builtins_$CHOST="$builddir/builtins-$_ver/lib/linux/libclang_rt.builtins$suffix.a" \
			-DCOMPILER_RT_USE_BUILTINS_LIBRARY=$builtins
		cmake --build build-$_ver
	done
}

package() {
	depends="$subpackages"

	local d; for d in build-*; do
		DESTDIR="$pkgdir" cmake --install $d
	done
}

rtlib() {
	local llvmver=${subpkgname%-rtlib}
	llvmver=${llvmver#clang}
	pkgdesc="$pkgdesc $llvmver"

	amove usr/lib/llvm$llvmver/lib/clang/$llvmver
}

sha512sums="
852e2105facb12ea0943aa24e0c220f76671ad76dfe7d07b8164c3a1d8360670ca565a2b6dd590722b974e16a2adf3c466fdabdfd3bb3ebbd005162c8ac4406c  compiler-rt-16.0.6.src.tar.xz
52ecd941d2d85a5b668caa5d0d40480cb6a97b3bf1174e634c2a93e9ef6d03670ca7e96abb0a60cb33ba537b93d5788754dab1f2f45c1f623f788162717d088b  cmake-16.0.6.src.tar.xz
8d4cdadc9a1ad249fbf9248c8e56f3bcafab73a473a0b0ca73499ed8825c62e27668aac4f1d03341631e5ad93701621e834e9e196ca32eac3ef805cf1c860083  llvm-16.0.6.src.tar.xz
fb8795bd51c9b005c2ad1975591e9e2715740d6407ccad41379f136ef2e8d24ded8b97b01165a3ae4bd377119a6a1049ca05d3220404fc12bee86114ff2bff0d  compiler-rt-18.1.8.src.tar.xz
e02243b491f9e688db28d7b53270fcf87debf09d3c95b136a7c7b96e26890de68712c60a1e85f5a448a95ad8c81f2d8ae77047780822443bbe39f1a9e6211007  cmake-18.1.8.src.tar.xz
930814730bb2d80cf7f7b2968f0f1f1442009ca62a7ca29992b69d63823270584b059d16aa845bb381411da566e7e4f255fcfbc38acbdf865eb0419b4dfd7459  llvm-18.1.8.src.tar.xz
e2e8e6a094525b84184e9e4a4c1a727de518d4ef1a91370515f0c955719dc946fd60e7fabd10f52ab1905ef6d4a86084b8ddfb9b45de838aa1c5ddf3c042748b  compiler-rt-19.1.7.src.tar.xz
3ff56e1a61dbace35d8c168ad5c94c5a09d92eb683494bfe1deabcb3640cf79b7422d44903d049d2298d54c2874f9a60c4f13f6795a3949e7eaefd5d42e62621  cmake-19.1.7.src.tar.xz
140275e35d2046fcbfc38241fed7bae92d34b761c09a5209e298a4241958a91e069dab76454efa32325d2f1205f0f0f25d886518533df55948a78b14e88b41a8  llvm-19.1.7.src.tar.xz
905fe22cbcb777255245b8594fb6cbb496c9ad96c962e9c429335a9358c6520f2aa2964d2019a40dd5ac20b0df17569dd62f635078f92d34206700ee06123a1d  compiler-rt-20.1.8.src.tar.xz
0ff6018c0753f208e990e45403c4ae5764a0ac83a8d80d8db7d3c7dbface14a7c8339893d8f757ff2d7b3662253ba356cf157ae7072a0be170a9dc028f4d7a74  cmake-20.1.8.src.tar.xz
4781d494fcb9a3d21cc9b76718e15f2d357573bfec53d9779c9ad6e871103beccf4023afc8f60ef1d463acde58c083e083cdc5a74001a3da361d8dbf160b01b7  llvm-20.1.8.src.tar.xz
ed30960bc5dea6d611a691e12949ddff1346fb5ba0ff36741496bf36442468f3724bb98526d230a97e58848bef703d6b793db27e254d927004f1903e3f2816ed  armv6-arch.patch.noauto
9b40d3f256a23e418a2d76ae8d5798e1f2ef773ff540d7d03b5e6d0f5c72f10b31692df5b5c3a87d199365805a5f86b7538eacbf6cbb11b706ea1f59f46685d3  1601-compiler-rt-lsan-dtp-offset.patch
52aa3194eb9fbd1979feba89d636cac162d6d183b806a2b409870f7006173a0fd68c443c9f21d57ed0818def73483fb518f30655642804de82b98887dc94dd4c  1602-compiler-rt-ppc-fixes.patch
794bfcf33b0b5537e686f4ae14de346668cf2f0cb0526bd7c0f27b6cb4d3e381c1ce697984092ba3d105c6070ec3542ceb03385ef158d7f8c3a3e510c3b29b00  1603-fix-msan-with-musl.patch
65718dc84a6835cc1a7500b9ca61f0ceb8e4007ca8bbee59b10fee058f654959f7350ba7fec5cc2cf728940f3fe47496c10a29ef3df05091fccb69009b38e838  1604-gcc15-cstdint.patch
0f2db06a913b231897f084999644aecd94d8985cad944f865b8d9864428d36d3bd357bbeb4d98d3da6f8db7483ab6949a7c58832a18d90ecb825e5801f8c079f  1801-compiler-rt-lsan-dtp-offset.patch
ddb23ae63165f611267a3234924ccc8b33df3d3bcc8d2127efbecf770cc0f88287ccae64272862229438c11ac0105699c65d792f7ec0c2915bb646cfae3b06fa  1802-compiler-rt-ppc-fixes.patch
726336fcdeb9a00bd9d3dcc20957ce4d0cbc636db420a1315c91c808f532f9932993b3f11722b49670a8add5b46a90cb61a055abd7decd37166de6819b95209b  1803-fix-msan-with-musl.patch
bb5d775e5fcd524ece3c76e55d582cc392835c1961611ba620afe5ecdbfcf2d77aba712dfe17e4cbf3396e998df3cbe389a43b3f2412c00f01bc803b6c498987  1901-compiler-rt-aarch64-use-getauxval.patch
4f72d18915166c226ace41d025c45e53c471825cbfea2d302ef285077731b39f7b94857ff5a7542d47a1933ec1006aa2036c686db9beff1500ff17999b7bf745  1902-compiler-rt-lsan-dtp-offset.patch
de65b8cecea09b33146b3e35a9ba4b84f1ce409bb40164f1cf695472c08c6ed7ce02f55146dc467087c2273a908b21fae2807caf2fca1542afecd4fc34ca3210  1903-compiler-rt-ppc-fixes.patch
a82e5e4892bb4cd9e4ff9e2254611ca51c1eb252d80ec78d77a1ec73f83066da850a967b712ef5ce09cf65c5b8b79f4e0dd7694b4300f3b25175a95439bb056e  1904-fix-msan-with-musl.patch
bf28d958406c9cf25facdab1ff70efaa1555705eb7f720edd9f72772486f9c46e6e52b12f378a59f9655151604ffcf88af54dc64289e5433915302fc4a6917ac  2001-compiler-rt-lsan-dtp-offset.patch
802eef85c7bae14cdf00b3922603ae837b6c8f2c557c10378f9deacd1248141d7af8747495fc2f0f90940e93e4a34f9d388d56a5912cec14160764dbea7cdf0b  2002-compiler-rt-ppc-fixes.patch
dcb5158d666cf157dd550bf9593c8e6f5557df74d7117601816881d97e8c817fc9851f9ff7cf9b747e9ebccf4b295d89129948674edc346c1b97591c8edac107  2003-fix-msan-with-musl.patch
"
