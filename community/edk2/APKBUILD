# Contributor: Timo Ter√§s <timo.teras@iki.fi>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>

pkgname=edk2
pkgver=0.0.202508
_realver=edk2-stable${pkgver##*.}
_libfdtver=1.7.2
_libspdmver=3.6.0
_mbedtlsver=3.3.0
_sslver=3.5.1
_janssonver=2.13.1
pkgrel=2
pkgdesc="EFI Development Kit II"
url="https://github.com/tianocore/tianocore.github.io/wiki/EDK-II/"
arch="x86_64 aarch64 loongarch64"
license="BSD-2-Clause-Patent"
makedepends="bash dtc-dev python3 iasl nasm util-linux-dev util-linux-misc"
options="!archcheck !check" # has no checks
subpackages="$pkgname-pyc $pkgname-shell:_shell $pkgname-ext4:_ext4"
_mipisyst_commit=370b5944c046bab043dd8b133727b2135af7747a
_platforms_commit=6174ce95f5eaaf5b27066e5a556d6eba424a18ff
source="$pkgname-$pkgver.tar.gz::https://github.com/tianocore/edk2/archive/$_realver.tar.gz
	$pkgname-platforms-$_platforms_commit.tar.gz::https://github.com/tianocore/edk2-platforms/archive/$_platforms_commit.tar.gz
	libfdt-$_libfdtver.tar.gz::https://github.com/devicetree-org/pylibfdt/archive/refs/tags/v$_libfdtver.tar.gz
	libspdm-$_libspdmver.tar.gz::https://github.com/DMTF/libspdm/archive/refs/tags/$_libspdmver.tar.gz
	mbedtls-$_mbedtlsver.tar.gz::https://github.com/ARMmbed/mbedtls/archive/v$_mbedtlsver.tar.gz
	mipisyst-$_mipisyst_commit.tar.gz::https://github.com/MIPI-Alliance/public-mipi-sys-t/archive/$_mipisyst_commit.tar.gz
	https://www.openssl.org/source/openssl-$_sslver.tar.gz
	https://github.com/akheron/jansson/releases/download/v$_janssonver/jansson-$_janssonver.tar.gz
	build-hack.patch
	ext4-werror.patch
	ext4-loongarch.patch
	0001-LoongArchQemuPkg-Add-missing-VirtNorFlashDeviceLib-i.patch
	0002-SerialPortLib-Fix-compile.patch
	0008-BaseTools-do-not-build-BrotliCompress-RH-only.patch
	0009-MdeModulePkg-remove-package-private-Brotli-include-p.patch
	"
builddir="$srcdir/$pkgname-$_realver"

PLATFORM="ShellPkg/ShellPkg.dsc Features/Ext4Pkg/Ext4Pkg.dsc"
case "$CARCH" in
	x86)
		TARGET_ARCH=IA32
		PLATFORM="$PLATFORM OvmfPkg/OvmfPkgIa32X64.dsc"
		;;
	x86_64)
		TARGET_ARCH=X64
		PLATFORM="$PLATFORM OvmfPkg/OvmfPkgX64.dsc OvmfPkg/OvmfXen.dsc"
		subpackages="$subpackages ovmf:_ovmf:noarch ovmf-xen:_xen:noarch"
		;;
	aarch64)
		TARGET_ARCH=AARCH64
		PLATFORM="$PLATFORM ArmVirtPkg/ArmVirtQemu.dsc"
		subpackages="$subpackages aavmf::noarch"
		;;
	loongarch64)
		TARGET_ARCH=LOONGARCH64
		PLATFORM="$PLATFORM Platform/Loongson/LoongArchQemuPkg/Loongson.dsc"
		subpackages="$subpackages edk2-loongarch64:_loongarch64:noarch"
		;;
esac

TOOLCHAIN=GCC5
RELEASE=RELEASE

prepare() {
	# unix line endings for the files to be patched
	sed -e 's/\r$//' -i BaseTools/Source/C/VfrCompile/VfrUtilityLib.cpp \
		BaseTools/Source/C/VolInfo/VolInfo.c
	if [ "$CARCH" = "aarch64" ] || [ "$CARCH" = "loongarch64" ]; then
		rm -rf MdePkg/Library/BaseFdtLib/libfdt
		ln -s "$srcdir"/pylibfdt-$_libfdtver \
			MdePkg/Library/BaseFdtLib/libfdt
	fi
	rm -rf SecurityPkg/DeviceSecurity/SpdmLib/libspdm
	ln -s "$srcdir"/libspdm-$_libspdmver SecurityPkg/DeviceSecurity/SpdmLib/libspdm
	rm -rf CryptoPkg/Library/MbedTlsLib/mbedtls
	ln -s "$srcdir"/mbedtls-$_mbedtlsver CryptoPkg/Library/MbedTlsLib/mbedtls
	rm -rf CryptoPkg/Library/OpensslLib/openssl
	ln -s "$srcdir"/openssl-$_sslver CryptoPkg/Library/OpensslLib/openssl

	rm -rf MdePkg/Library/MipiSysTLib/mipisyst
	ln -s  "$srcdir"/public-mipi-sys-t-$_mipisyst_commit \
		MdePkg/Library/MipiSysTLib/mipisyst

	rm -rf RedfishPkg/Library/JsonLib/jansson/src
	ln -s "$srcdir"/jansson-$_janssonver RedfishPkg/Library/JsonLib/jansson/src

	mv "$srcdir"/$pkgname-platforms-$_platforms_commit \
		$pkgname-platforms

	dos2unix "$builddir"/$pkgname-platforms/Features/Ext4Pkg/Ext4Pkg.dsc

	default_prepare
}

build() {
	export PYTHON_COMMAND=python3
	export WORKSPACE=$PWD
	export PACKAGES_PATH=$PWD:$PWD/$pkgname-platforms
	export EDK_TOOLS_PATH=$PWD/BaseTools/
	export PATH=$PWD/BaseTools/BinWrappers/PosixLike/:$PATH
	# parallel build fails
	unset MAKEFLAGS

	bash -c ". edksetup.sh"
	make -C BaseTools

	for _p in $PLATFORM; do
		msg "Building Plaform Files $_p"
		command build -b $RELEASE \
			-a $TARGET_ARCH  \
			-t $TOOLCHAIN \
			-p $_p \
			-n ${JOBS:-2} \
			-DSECURE_BOOT_ENABLE=TRUE \
			-DTPM2_ENABLE=TRUE
	done
}

package() {
	mkdir -p "$pkgdir"/usr/bin \
		"$pkgdir"/usr/share/$pkgname/Conf \
		"$pkgdir"/usr/share/$pkgname/Scripts

	install BaseTools/Source/C/bin/* BaseTools/BinWrappers/PosixLike/LzmaF86Compress \
		"$pkgdir"/usr/bin
	install BaseTools/BuildEnv "$pkgdir"/usr/share/$pkgname/
	install BaseTools/Conf/*.template "$pkgdir"/usr/share/$pkgname/Conf
	install BaseTools/Scripts/GccBase.lds "$pkgdir"/usr/share/$pkgname/Scripts

	for i in $(find BaseTools/Source/Python -type d -maxdepth 1); do
		local mod=${i##*/}
		test -f "$i/$mod.py" || continue
		cp -R BaseTools/Source/Python/"$mod" "$pkgdir"/usr/share/edk2/Python/
		cat <<- EOF > "$pkgdir"/usr/bin/"$mod".py
		#!/bin/sh
		export PYTHONPATH=/usr/share/edk2/Python
		exec $PYTHON_COMMAND /usr/share/edk2/Python/$mod/$mod.py "\$@"
		EOF
		chmod +x "$pkgdir"/usr/bin/"$mod".py
	done
}

_shell() {
	pkgdesc="EDK2 UEFI Shell"

	# taken from arch
	# minimal UEFI shell, as defined in ShellPkg/Application/Shell/Shell.inf
	local _min='7C04A583-9E3E-4f1c-AD65-E05268D0B4D1'
	# full UEFI shell, as defined in ShellPkg/ShellPkg.dsc
	local _full='EA4BB293-2D7F-4456-A681-1F22F42CD0BC'

	install -Dm644 "$builddir"/Build/Shell/"$RELEASE"_"$TOOLCHAIN"/$TARGET_ARCH/Shell_$_min.efi \
		"$subpkgdir"/usr/share/edk2-shell/Shell.efi

	install -Dm644 "$builddir"/Build/Shell/"$RELEASE"_"$TOOLCHAIN"/$TARGET_ARCH/Shell_$_full.efi \
		"$subpkgdir"/usr/share/edk2-shell/ShellFull.efi
}

_ext4() {
	pkgdesc="EDK2 Ext4 filesystem driver"

	install -Dm644 "$builddir"/Build/Ext4Pkg/"$RELEASE"_"$TOOLCHAIN"/$TARGET_ARCH/Ext4Dxe.efi \
		"$subpkgdir"/usr/share/edk2-ext4/Ext4Dxe.efi
}

_ovmf() {
	pkgdesc="Open Virtual Machine Firmware (OVMF) BIOS"
	license="BSD MIT"

	for fw in "$builddir"/Build/OvmfX64/"$RELEASE"_"$TOOLCHAIN"/FV/*.fd; do
		install -Dm644 $fw "$subpkgdir"/usr/share/OVMF/${fw##*/}
	done

	# dont ship memfd for now to save space
	rm -f "$subpkgdir"/usr/share/OVMF/MEMFD.fd

	install -d "$subpkgdir"/usr/share/ovmf
	ln -sf ../OVMF/OVMF.fd "$subpkgdir"/usr/share/ovmf/bios.bin
}

_xen() {
	pkgdesc="Open Virtual Machine Firmware (OVMF) - Xen build"
	license="BSD MIT"

	install -Dm644 "$builddir"/Build/OvmfXen/"$RELEASE"_"$TOOLCHAIN"/FV/OVMF.fd \
		"$subpkgdir"/usr/lib/xen/boot/ovmf.bin
}

aavmf() {
	pkgdesc="ARM (aarch64) Virtual Machine Firmware EFI"
	license="BSD MIT"

	dd if=/dev/zero \
		of="$builddir"/Build/ArmVirtQemu-AARCH64/"$RELEASE"_$TOOLCHAIN/FV/AAVMF_CODE.fd \
		bs=1M seek=64 count=0
	dd if="$builddir"/Build/ArmVirtQemu-AARCH64/"$RELEASE"_$TOOLCHAIN/FV/QEMU_EFI.fd \
		of="$builddir"/Build/ArmVirtQemu-AARCH64/"$RELEASE"_$TOOLCHAIN/FV/AAVMF_CODE.fd \
		conv=notrunc
	dd if=/dev/zero \
	of="$builddir"/Build/ArmVirtQemu-AARCH64/"$RELEASE"_$TOOLCHAIN/FV/AAVMF_VARS.fd \
		bs=1M seek=64 count=0

	for fw in "$builddir"/Build/*/"$RELEASE"_"$TOOLCHAIN"/FV/*.fd; do
		install -Dm644 $fw "$subpkgdir"/usr/share/AAVMF/${fw##*/}
	done
}

_loongarch64() {
	pkgdesc="Loongarch64 Virtual Machine Firmware EFI"
	license="BSD MIT"

	for fw in "$builddir"/Build/LoongArchQemu/"$RELEASE"_"$TOOLCHAIN"/FV/*.fd; do
		truncate -s 16M $fw
		install -Dm644 $fw "$subpkgdir"/usr/share/edk2/loongarch64/${fw##*/}
	done

	install -d "$subpkgdir"/usr/share/edk2/loongarch64
}

pyc() {
	default_pyc

	local IFS=$'\n'
	amove $(find usr/share/edk2/Python -type d -name __pycache__)
}

sha512sums="
822a6fda97a4ed15d11afb36d923cc518de2aeacc47bdbeed38ba3544c0d44a0843274f150f06c0515df75a1c9566b21d98ed46bcb15026146ac1c27db5bd22e  edk2-0.0.202508.tar.gz
53d1711ca3e01e922f9962e4e681cb75ac49f121a8b5bca6244e3e37b8284d81d9b918910156ad50446d037b679b3e7d01076173806442509dd8ad588c8a6023  edk2-platforms-6174ce95f5eaaf5b27066e5a556d6eba424a18ff.tar.gz
e1e2779cee83c918eea67af0ffcfadc4905788a88a62723d1e7329b6f25ecad570200f838ea6da9764b203ed463dd546b15878833b736db67b8dc24a00ff7509  libfdt-1.7.2.tar.gz
5ea3dbe2d8a83d8f6fd594f58f62cc81380841d22e0cb5bdd7bbdc60653475649edf68f1516d51b0cbcb694d3d8b8e54ab9a987b6801eb81d77ac0a345dfaffa  libspdm-3.6.0.tar.gz
c7f59973a77566f5ffc20cb315af5dce774e51c8cb90ad28b1d48bfa4714165617c46aba307523b4f3efa765fb7b8e0f0855d91d52ce7b8607d4a5aa85f5f71a  mbedtls-3.3.0.tar.gz
de6888577ceab7ab6915d792f3c48248cfa53357ccd310fc7f7eae4d25a932de8c7c23e5b898c9ebf61cf86cb538277273f2eb131a628b3bf0d46c9a3b9b6686  mipisyst-370b5944c046bab043dd8b133727b2135af7747a.tar.gz
0fa152ae59ab5ea066319de039dfb1d24cbb247172d7512feb5dd920db3740f219d76b0195ea562f84fe5eae36c23772302eddfbb3509df13761452b4dafb9d3  openssl-3.5.1.tar.gz
e32be6665e41cf1763608c2f1ac4ce0824d4d7ffa5f4a5824cefde279250fdd399d49ba93d8894e16a473731f629b846554654347f027ca9a0a96ed047f10192  jansson-2.13.1.tar.gz
a7d4ab2c82b62ba01c86e59f53bd3896d661c9bfbb9db9598734155b66d5fe03eca4a2a9993a14d3bf555992c6d01ba5d7a15868ff9ec6ed98b8a9b3895bb7df  build-hack.patch
040a6ccbbf4678425e646419841b5502d66d99bed8dac0461abc623d91309096c10021828d8097af446f1e484fec644f5e644df5b6e771b6e23cd71b48b3d462  ext4-werror.patch
d41b3ccbea867daa7ba8f698fe537db66263dd602836d8c33f5c5a0026bcfbbbe940d9e7b0077a9b97f408b61439de5c0208b58f5ccea5fac555149c8ec29c39  ext4-loongarch.patch
67724d38b8919bb19532e51f661374109d9e259773334ee209281b7bb8c8dedb1c9c2eef131e4d4ffcb8b7a2bc25c97d6311883436cc1d5bd191483effa7620e  0001-LoongArchQemuPkg-Add-missing-VirtNorFlashDeviceLib-i.patch
05626f4cdee339a0dcff3571bdbcfec6124da78a60c78fd422a033cfcbf07d8db8e6d5ffddbd8e913917c4f5f5efae997dad89ef1ac94ab5a924a570834462f1  0002-SerialPortLib-Fix-compile.patch
ecbfc1ec3b732580c33c477191b71553247af1a68f1754bd363d179e0f5aabde93e3c5ec7f2574f9a9ffefef34e75787a2a87b1057b02cd206e8f0618a252871  0008-BaseTools-do-not-build-BrotliCompress-RH-only.patch
ecad98ff84ab307bda751c8a9a321e064ef880dc66b4d107e66aedbc4e14d00eed76770437e25fa9153dc30803f5cbbf1299329f56865a3b75d2c19f6615e68b  0009-MdeModulePkg-remove-package-private-Brotli-include-p.patch
"
