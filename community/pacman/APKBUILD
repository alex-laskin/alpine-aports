# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=pacman
pkgver=7.0.0
pkgrel=1
pkgdesc="Simple library-based package manager"
options="!check" # Depends on not packaged fakechroot
url="https://www.archlinux.org/pacman/"
arch="all"
license="GPL-2.0-or-later"
depends="
	bash
	file
	libarchive-tools
	"
depends_dev="gettext-dev"
makedepends="
	$depends_dev
	asciidoc
	curl-dev
	gpgme-dev
	libarchive-dev
	muon
	openssl-dev
	"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-lang
	$pkgname-bash-completion
	$pkgname-zsh-completion
	"
source="https://gitlab.archlinux.org/pacman/pacman/-/archive/v$pkgver/pacman-v$pkgver.tar.gz
	remove-extra-dash.patch
	use-gettext-libintl.patch
	"
builddir="$srcdir/$pkgname-v$pkgver"

provides="$pkgname-makepkg=$pkgver-r$pkgrel"
replaces="$pkgname-makepkg"

# secfixes:
#   5.2.0-r0:
#     - CVE-2019-18183
#     - CVE-2019-18182
#   5.1.3-r0:
#     - CVE-2019-9686

build() {
	abuild-muon \
		-Db_lto=true \
		-Dscriptlet-shell=/usr/bin/bash \
		-Di18n=true \
		-Ddoc=enabled \
		-Dcurl=enabled \
		-Dgpgme=enabled \
		-Dfile-seccomp=enabled \
		build
	ninja -C build
}

check() {
	muon -C build test -j "${JOBS:-0}" -R -d dots
}

package() {
	DESTDIR="$pkgdir" muon -C build install
}

sha512sums="
c26916775e5bccea878da3d77b17b2e2c99b70f5d8dab99929395ec92ff3b145ae8bc996207ebaada3aa0ab87e95904ec6fdf7bbb08c1a1b823af7732049e1bf  pacman-v7.0.0.tar.gz
64cd09b73bd90ee69612a3397ba2520b1221bba49a6998bd18a39a4adfa90079e8f2dbcc49b271cca27c8c0130652f1b27aff3a254d045bc99ef23d85da3c5fc  remove-extra-dash.patch
07ee2b14ceafcc5e8081722a77d7fccebca1de6cb354504dcdb77068e45dc2b908ea71cc32863a256f9b8eb49164a786d334867b21d9eab30880b686f17cba52  use-gettext-libintl.patch
"
