# Contributor: Clayton Craft <clayton@craftyguy.net>
maintainer="team/kde <clayton@craftyguy.net>"
pkgname=kstars
pkgver=3.7.8
pkgrel=0
pkgdesc="Astronomy software"
url="https://kde.org/applications/education/kstars"
# armhf blocked by qt6-qtdeclarative
# x86 blocked by stellarsolver
arch="all !armhf !x86"
license="GPL-2.0-or-later"
makedepends="
	cfitsio-dev
	cmake
	curl-dev
	eigen-dev
	extra-cmake-modules
	gsl-dev
	kconfig
	kcoreaddons
	kcrash
	kdoctools-dev
	ki18n
	kio
	knewstuff-dev
	knotifications
	knotifyconfig-dev
	kplotting-dev
	kwidgetsaddons
	kxmlgui
	libindi-dev
	libnova-dev
	libraw-dev
	libxisf-dev
	qt6-qtbase-dev
	qt6-qtdatavis3d-dev
	qt6-qtdeclarative-dev
	qt6-qtsvg-dev
	qt6-qtwebsockets-dev
	qtkeychain-dev
	samurai
	stellarsolver-dev
	wcslib-dev
"
checkdepends="xwayland-run"
subpackages="$pkgname-dev $pkgname-lang"
source="https://download.kde.org/stable/kstars/$pkgver/kstars-$pkgver.tar.xz
	tests-disable-ngc4535-autofocus3.patch
	QList-size.patch
	test_ekos_scheduler_ops-link.patch
	DATA_INSTALL_DIR.patch
	"

build() {
	cmake -B build -G Ninja -Wno-dev \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_BUILD_TYPE=None \
		-DBUILD_WITH_QT6=ON
	cmake --build build
}

check() {
	local skip_tests=
	case "$CARCH" in
	loongarch64)
		# TODO: test times out due to network issues, try again when builders reach EU
		skip_tests="|TestKSUserDB"
		;;
	esac

	# Note: excluded tests fail because they cannot find TZrules.dat and other
	# things in the 'data' dir. Seems like test framework would allow
	# specifying or overriding the search dir since data is in $srcdir, but I
	# couldn't figure it out yet, so disabling tests...
	xwfb-run -- ctest --test-dir build \
		-E "StarCorrespondenceTest|SchedulerunitTest|Test(ArtificialHorizon|CatalogDownload|Ekos(Simulator|Focus|Capture|FilterWheel|MeridianFlipState|Scheduler|SchedulerOps|Mount)|KSPaths|PlaceholderPath)$skip_tests"
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
1ae1ae02572b832a8b3a45785c353147333baa811c280b132c0597a3ad8dec8a7cfa26458587a4fc7c81847b29c93f2375cc9ce35c4b613583bfdee70727c460  kstars-3.7.8.tar.xz
dba2c42a7eb827d94eff00ae039c963670ee0adee7f3edc8b3cb3201455fa9bbd9f677acd3bd8029a19c7a3817c1d7452d238ad8a77e6911184aa4e678480e74  tests-disable-ngc4535-autofocus3.patch
8e4e236f3dcfb5e970e5c1351b55debc912c5510d7ca8e4a8d42fd78b78d6cd845932eb02c6853de9df2612c0b896fdfadeba0bc45611c411762d815dd39e47c  QList-size.patch
c9f947d914890ea82c0570ecda1b68e06081da2239610b4d7cb72a3095f1440c59b61c0db09d2a24bc350d15da97634167009e75257553945dfec8b892c6e427  test_ekos_scheduler_ops-link.patch
4dab89894cab7f0754f6a190753cae184dc75e6a8d27be0efebd83f00f58c2dee85a2ce918c7be22dfc428a6d60b4f5b1b56ad9fe347fd59e21457525fd4f955  DATA_INSTALL_DIR.patch
"
