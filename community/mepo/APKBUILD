# Maintainer: Miles Alan <m@milesalan.com>
pkgname=mepo
pkgver=1.3.4
pkgrel=2
pkgdesc="Fast, simple, and hackable OSM map viewer for Linux"
url="https://git.sr.ht/~mil/mepo"
arch="aarch64 x86_64" # Limited by zig aport
license="GPL-3.0-or-later"
makedepends="
	curl-dev
	sdl2-dev
	sdl2_gfx-dev
	sdl2_image-dev
	sdl2_ttf-dev
	zig>=0.14.0
	"
depends="
	zenity
	curl
	xwininfo
	geoclue
	jq
	ncurses
	font-hack-nerd
"
source="
	$pkgname-$pkgver.tar.gz::https://git.sr.ht/~mil/mepo/archive/$pkgver.tar.gz
	0001-Zig-0.15-Use-.root_module-in-Build.patch
	0002-Zig-0.15-Update-Zig-version.patch
	0003-Zig-0.15-Writergate.patch
	0004-Zig-0.15-Remove-usingnamespace.patch
	0005-Zig-0.15-json.Stringify-changes.patch
	0006-Zig-0.15-callconv-.c-now-lowercase.patch
	0007-Zig-0.15-ArrayList-is-now-unmanaged-only.patch
	0008-Zig-0.15-fmt-changes.patch
	0009-Zig-0.15-allocPrintZ-allocPrintSentinel.patch
	0010-Zig-0.15-Remove-std.posix.empty_sigset.patch
	0011-Zig-0.15-std.time.sleep-std.Thread.sleep.patch
	"
subpackages="
	$pkgname-doc
"

# We may want other than "baseline" for other targets, when enabled by zig
case "$CARCH" in
	aarch64|x86_64) cputarget=baseline ;;
esac

build() {
	zig build -Doptimize=ReleaseSafe ${cputarget:+-Dcpu="$cputarget"}
	zig-out/bin/mepo -docmd > doc.md
}

check() {
	zig build test
}

package() {
	install -Dm755 zig-out/bin/mepo* -t "$pkgdir/usr/bin/"
	install -Dm755 scripts/mepo* -t "$pkgdir/usr/bin/"
	install -Dm644 zig-out/share/applications/mepo.desktop -t "$pkgdir/usr/share/applications/"
	install -Dm644 zig-out/share/pixmaps/mepo.png -t "$pkgdir/usr/share/pixmaps/"
	install -Dm644 doc.md -t "$pkgdir"/usr/share/doc/"$pkgname"/
}
sha512sums="
ef45de275e46c25ba4aedf6a27298c6b0ce5c751bd0680d37dca81baf86f059be05574d0655013ba405d45d958b1fef3d795050efa2db4fad6ca7f47aa577cb7  mepo-1.3.4.tar.gz
eb8cb8cb0cdcddaffe64197fdb03e09953c1ac8323bbcbfa59eb751c92ad4a98946235c6b573ae32943a469d503bc0eca4763e221e4f0d2630fe43ac26955422  0001-Zig-0.15-Use-.root_module-in-Build.patch
fa87b4189e0f3a1c0a5e5a9986d2c19050007b71de3a9f1857b40202ce91c3ef16a6e971dba014fc9a1eb3964921758083792123ec7298d2e01ee8ef377a3ff2  0002-Zig-0.15-Update-Zig-version.patch
10a974d43c2360566b0f9e5f9cbcb017456a67f53bce2646bf8411e6e4df5c1780e607ddf79b61025e465ce36bf7f69519b2324a20827b39f4d6712475721d74  0003-Zig-0.15-Writergate.patch
97d4ca21422c28385dc62e5cd1c40d63a0a0619dc8dc6daee688291715eb69d254e739a582c85e342ab7005795daf150a6ae954f7011287d3a29926ac513f648  0004-Zig-0.15-Remove-usingnamespace.patch
5a6240d4b117d259268bcd2988a0ca12b33697e6ce2751cdde86f9c4cb971a241573141222de68e192480e0d1f4b919ad31cd75a61abfbbbc4ca3374d155d472  0005-Zig-0.15-json.Stringify-changes.patch
8e1615eb0d7c0cd1996951eb03582f7dc683354690a0ac755cc45d846ee68a6d7a774e8976d8eb5317588fc0161d2f4c3482b3ad07b76c3499dedf8a3c4dd411  0006-Zig-0.15-callconv-.c-now-lowercase.patch
67107c489af34b643db376964cd1a4f0ccda2f2c7c4aca2af07af541fd143ffd384d8c07ee460a4536104d5d45d9deaed91ff23dd6f745d105d4e25c6040e259  0007-Zig-0.15-ArrayList-is-now-unmanaged-only.patch
e68d087f07371d678ccecb561bc70861ae51c998fce28921434a611ab8ebec49e3f06f058a1a5eb175d4cadf1f0902d5297c8b17dea82e9a86ca30e12d642b9c  0008-Zig-0.15-fmt-changes.patch
42e880795811c4cd5f43891c764313eaadcdb5ca1e375b4d80acf825d0a38a6d276ebd62deea1585dcbc947a5a7a4ac1c36e163adc370451bfad46cb209dae92  0009-Zig-0.15-allocPrintZ-allocPrintSentinel.patch
dc1852084cd614d3b422f450a17508d0f161a302ccf3232129a8344bb0d7021fc428f324b77953f28aedc5210e7cd5a254ac79adbf38d56319410518077f9af2  0010-Zig-0.15-Remove-std.posix.empty_sigset.patch
f6dbe4d4619db01ecc6a0f83b649e9e07e76ddf940d8a737cb3b0a00b8da198cf7c894f19dc6c9676d3d5c4da9d71c3060dcdf4b633c51554f050775d9f1a654  0011-Zig-0.15-std.time.sleep-std.Thread.sleep.patch
"
