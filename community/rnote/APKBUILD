# Contributor: Jakob Meier <comcloudway@ccw.icu>
# Maintainer: Jakob Meier <comcloudway@ccw.icu>
pkgname=rnote
pkgver=0.13.1
pkgrel=0
pkgdesc="Sketch and take handwritten notes."
url="https://rnote.flxzt.net/"
# ppc64le: vendored abseil, not possible to override to system
# armhf: doesn't build
# s390x: mainframe
arch="all !armhf !s390x !ppc64le"
license="GPL-3.0-or-later"
makedepends="
	alsa-lib-dev
	appstream-glib-dev
	appstream-dev
	cargo
	cargo-auditable
	cargo-nextest
	clang-dev
	cmake
	desktop-file-utils
	gtk4.0-dev
	libadwaita-dev
	meson
	poppler-dev
	"
subpackages="$pkgname-lang $pkgname-cli:cli"
source="
	https://github.com/flxzt/rnote/archive/refs/tags/v$pkgver/rnote-$pkgver.tar.gz
	update-rustix.patch
	use_cargo_auditable.patch
"
options="net"

export CARGO_PROFILE_RELEASE_LTO=thin

prepare() {
	default_prepare

	export CARGO_HOME="$builddir/output/cargo-home"

	cargo fetch --target="$CTARGET" --locked
	for crate in rnote-cli rnote-compose rnote-engine rnote-ui; do
		cd $builddir/crates/$crate
		cargo fetch --target="$CTARGET" --locked
	done
}

build() {
	abuild-meson \
		. output

	meson configure -Dcli=true output
	meson compile -C output
}
check() {
	meson compile cargo-test -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

cli() {
	pkgdesc="Convert files to and from .rnote"

	amove usr/bin/rnote-cli
}

sha512sums="
3bcd16c207fabd70d4a1be00811c5ebc6e1c16af4a64eba244838010cd1480f1ecfd82a61e64e06ab32ff656a01100042fd356f436325eab5b2c92d4d822de49  rnote-0.13.1.tar.gz
d0c5bdb11df4ac2f016ee956e54f1d27cd2e0772083209a832e928a1aec3838033c6854b93e9ce65039823750acd4595023c59a20f4196fddf97b6c6af3c0be2  update-rustix.patch
7c53d5a603cc6779fa79652cfb04897901f7dc04f226686903bb56dfa55cb8a67720f611c2da80eb2d365bfbdb7a36fea29a5c63f5b62ce5f16c0830c4047aa9  use_cargo_auditable.patch
"
