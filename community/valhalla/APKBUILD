maintainer="Bart Ribbers <bribbers@disroot.org>"
pkgname=valhalla
pkgver=3.6.0
pkgrel=1
pkgdesc="Open Source Routing Engine for OpenStreetMap"
url="https://valhalla.readthedocs.io/"
# riscv64 blocked by luajit
arch="all !riscv64"
license="MIT"
depends_dev="
	boost-dev
	curl-dev
	gtest-dev
	libspatialite-dev
	luajit-dev
	lz4-dev
	prime_server-dev
	protobuf-dev
	python3-dev
	rapidjson-dev
	sqlite-dev
	zeromq-dev
	zlib-dev
	"
makedepends="$depends_dev
	cmake
	samurai
	"
checkdepends="bash"
subpackages="$pkgname-dev $pkgname-doc"
source="https://dev.alpinelinux.org/archive/valhalla/valhalla-$pkgver.tar.gz
	so.patch
	pc.patch
	"
builddir="$srcdir/$pkgname"
# check: localedef: command not found
options="!check"

_disturl="dev.alpinelinux.org:/archive/$pkgname/"

snapshot() {
	clean
	deps
	mkdir -p "$srcdir" && cd "$srcdir"
	git clone https://github.com/valhalla/valhalla --recursive
	cd valhalla && git checkout $pkgver && cd -
	tar czvf $SRCDEST/$pkgname-$pkgver.tar.gz valhalla
	rsync --progress -La $SRCDEST/$pkgname-$pkgver.tar.gz $_disturl
}

build() {
	export CXXFLAGS="$CXXFLAGS -Wno-deprecated-declarations"
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=TRUE \
		-DENABLE_WERROR=OFF \
		-DENABLE_TOOLS=OFF \
		-DENABLE_DATA_TOOLS=OFF \
		-DENABLE_SERVICES=OFF \
		-DENABLE_HTTP=ON \
		-DENABLE_PYTHON_BINDINGS=OFF \
		-DENABLE_CCACHE=OFF \
		-DENABLE_COVERAGE=OFF \
		-DENABLE_COMPILER_WARNINGS=ON \
		-DENABLE_SANITIZERS=OFF \
		-DENABLE_ADDRESS_SANITIZER=OFF \
		-DENABLE_UNDEFINED_SANITIZER=OFF \
		-DENABLE_TESTS="$(want_check && echo ON || echo OFF)" \
		-DENABLE_SINGLE_FILES_WERROR=OFF \
		-DENABLE_THREAD_SAFE_TILE_REF_COUNT=OFF \
		-DProtobuf_PROTOC_EXECUTABLE=/usr/bin/protoc
	cmake --build build
}

check() {
	cmake --build build --target check
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
fe7e01146160d4f8e10f0d9931e3d88dc5fbc54fdf77040983780952301cccd453d872ba0362cc4db94b2322e8fd418dd9d574e3695f57bc85a26cf3a11981d6  valhalla-3.6.0.tar.gz
788a29155dcd8c5b87c27d262c23f7088799fea9698706ae7cd08465297e1dc6aca9ff4aee806b1b16c2d77e320dd1debf66829e518a4c7bdce8a69659616bd2  so.patch
b68b0a267260b92ea4d8fac48bfcd15afa360f1e9b102a1a25d529c9d7117c5e56ab52fe50d9e8eafbaba3b50e06106e3a01858ad7817d3cfd3c98365fedd4ab  pc.patch
"
