# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=x265
pkgver=4.1
pkgrel=0
pkgdesc="Open Source H265/HEVC video encoder"
url="https://www.videolan.org/developers/x265.html"
arch="all"
license="GPL-2.0-or-later"
makedepends="cmake nasm ninja numactl-dev"
subpackages="$pkgname-dev $pkgname-libs"
source="https://bitbucket.org/multicoreware/x265_git/downloads/x265_$pkgver.tar.gz
	ambient-viewing-environment-sei.patch
	cmake4.patch
	"
builddir="$srcdir/${pkgname}_$pkgver"

build() {
	local cmake_opts=""
	case "$CARCH" in
		# It has textrel on x86 so we disable asm.
		x86) cmake_opts="-DENABLE_ASSEMBLY=OFF";;
		ppc*) cmake_opts="-DENABLE_ALTIVEC=OFF -DCPU_POWER8=OFF";;
		# See https://bitbucket.org/multicoreware/x265_git/issues/559
		*) cmake_opts="-DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy";;
	esac

	export CFLAGS="$CFLAGS -flto=auto"
	export CXXFLAGS="$CXXFLAGS -flto=auto"

	# CMAKE_BUILD_TYPE - Don't change to None! This is a video encoder,
	#   performance is the most important.
	# shellcheck disable=2046
	cmake3.5 -B build-12 -S source -G Ninja -Wno-dev \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DHIGH_BIT_DEPTH=TRUE \
		-DMAIN12=TRUE \
		-DEXPORT_C_API=FALSE \
		-DENABLE_CLI=FALSE \
		-DENABLE_SHARED=FALSE \
		$([ "$CARCH" = "aarch64" ] && echo "-DENABLE_ASSEMBLY=OFF") \
		-DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy \
		$cmake_opts
	cmake --build build-12

	# shellcheck disable=2046
	cmake3.5 -B build-10 -S source -G Ninja -Wno-dev \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DHIGH_BIT_DEPTH=TRUE \
		-DEXPORT_C_API=FALSE \
		-DENABLE_CLI=FALSE \
		-DENABLE_SHARED=FALSE \
		$([ "$CARCH" = "aarch64" ] && echo "-DENABLE_ASSEMBLY=OFF") \
		-DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy \
		$cmake_opts
	cmake --build build-10

	ln -s ../build-10/libx265.a build/libx265_main10.a
	ln -s ../build-12/libx265.a build/libx265_main12.a

	cmake3.5 -B build -S source -G Ninja -Wno-dev \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DEXTRA_LIB='x265_main10.a;x265_main12.a' \
		-DEXTRA_LINK_FLAGS='-L.' \
		-DLINKED_10BIT=TRUE \
		-DLINKED_12BIT=TRUE \
		-DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy \
		$cmake_opts

	cmake --build build
}

check() {
	./build/x265 --version
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	rm -fv "$pkgdir"/usr/lib/libx265.a
}

sha512sums="
5af5b958ff507f96a52813a6b72847c9fbc555bf95af287ae7f011055338266fb647dfea3b7789730c7f5c746f7e6cb7d9395ba10cbe43eb5034d3ed99730c3f  x265_4.1.tar.gz
39677126f22d8da7f4c4792c315c5435d60d0ec747b3505399561e8372526fe9281ad75d60302df071c7edcc84b2edbb95e6a11b62a07d484486f8974e3402eb  ambient-viewing-environment-sei.patch
ebcc0fb95566ad3bc5e3d02a19d5705fc9c1d760bfea9587b1840197700661dac0b121167e55e364771f69e71a5bd5425281fa0453a73cf2adc19bab042bae3e  cmake4.patch
"
