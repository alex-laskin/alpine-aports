maintainer="Ariadne Conill <ariadne@ariadne.space>"
pkgname=efifs
pkgver=1.11
pkgrel=0
pkgdesc="free UEFI filesystem drivers"
url="https://efi.akeo.ie"
arch="x86_64 aarch64 loongarch64"
license="GPL-3.0-or-later"
depends=""
makedepends="bash nasm util-linux-dev python3 tar"
checkdepends=""
install=""
subpackages=""

# Git commit mentioned at https://github.com/pbatard/efifs
_grub2_version="2.13-0"
_grub2_commit="6811f6f09d61996a3acbc4fc0414e45964f0e2d9"

# EDK2
_edk2_stable_date="20250221"
_edk2_stable_str="edk2-stable${_edk2_stable_date:0:6}"

source="https://github.com/pbatard/efifs/archive/v$pkgver/efifs-$pkgver.tar.gz
	https://git.savannah.gnu.org/cgit/grub.git/snapshot/grub-${_grub2_commit}.tar.gz
	https://github.com/tianocore/edk2/archive/${_edk2_stable_str}.tar.gz"
builddir="$srcdir/EfiFs-$pkgver"
options="!check" # no tests

case "$CARCH" in
x86_64)
	_efi_arch_upper="X64" ;;
aarch64)
	_efi_arch_upper="AARCH64" ;;
loongarch64)
	_efi_arch_upper="LOONGARCH64" ;;
esac

_target_path="/boot/efi/EFI/efifs"

unpack() {
	mkdir -p "$srcdir"
	cd "$srcdir"

	tar -zxf "$SRCDEST"/efifs-$pkgver.tar.gz
	tar -zxf "$SRCDEST"/${_edk2_stable_str}.tar.gz

	cd "$builddir"
	tar -zxf "$SRCDEST"/grub-${_grub2_commit}.tar.gz --strip-components=1 --directory=grub

	(cd grub; patch -Np1 < ../0001-GRUB-fixes.patch; cd ..)
}

prepare() {
	cd "$srcdir/edk2-${_edk2_stable_str}"

	# Do not build BrotliCompress (because it's unused)	
	sed -e '/BrotliCompress/d' -i BaseTools/Source/C/GNUmakefile
		
	# Remove include path pointing to unused sub-module	
	sed -e '/mipisyst/d' -i MdePkg/MdePkg.dec

	ln -s ../EfiFs-$pkgver EfiFsPkg
}

build() {
	cd "$srcdir/edk2-${_edk2_stable_str}"

	export PYTHON_COMMAND=python3
	make -C BaseTools EXTRA_OPT_FLAGS="$CFLAGS" EXTRA_LDFLAGS="$LDFLAGS"

	source ./edksetup.sh --reconfig

	bash ./EfiFsPkg/set_grub_cpu.sh ${_efi_arch_upper}
	command build -a ${_efi_arch_upper} -b RELEASE -t GCC5 -p EfiFsPkg/EfiFsPkg.dsc
}

package() {
	cd "$srcdir/edk2-${_edk2_stable_str}"

	install -Dm755 ./Build/EfiFs/RELEASE_GCC5/${_efi_arch_upper}/*.efi -t "$pkgdir"/"${_target_path}"
}

sha512sums="
2cd91abba8e33fe4e73a2da795b00126232c8fbd5da049255cbc3acc9c94d4c5b7067b1a24eb4403d5c384ca93770eb9a038b854f010238b85a63525c4cc0b3e  efifs-1.11.tar.gz
73adfc7fd9c13ae40e14049904915e187a7b3ebfbe6a2b5b106df7a650771a384adcd3f907a29370b5194eefeff4011aa90a4d57100ca559c9d87b0c7540e140  grub-6811f6f09d61996a3acbc4fc0414e45964f0e2d9.tar.gz
1421b3e14acf6aa51c84cf0a12716990f08815fff631f4657bb9907fd8d620e9fac7794e05c2eed54d5f8966f8e9267d32bf2256237a959bd727629163b8c00d  edk2-stable202502.tar.gz
"
