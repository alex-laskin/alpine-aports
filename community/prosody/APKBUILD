# Contributor: Mika Havela <mika.havela@gmail.com>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
_luaver=5.4
pkgname=prosody
pkgver=13.0.2
pkgrel=0
pkgdesc="Lua based Jabber/XMPP server"
url="https://prosody.im/"
arch="all"
license="MIT"
depends="
	ca-certificates
	icu-data-full
	lua$_luaver
	lua$_luaver-busted
	lua$_luaver-expat
	lua$_luaver-filesystem
	lua$_luaver-sec
	lua$_luaver-socket
	lua$_luaver-unbound
	"
makedepends="
	icu-dev
	libidn-dev
	linux-headers
	lua$_luaver-dev
	openssl-dev>3
	"
checkdepends="lua-busted"
install="prosody.pre-install"
subpackages="$pkgname-doc $pkgname-openrc"
pkgusers="prosody"
pkggroups="prosody"
source="https://prosody.im/downloads/source/prosody-$pkgver.tar.gz
	$pkgname.logrotate
	$pkgname.initd
	prosody.cfg.lua.patch
	"

# secfixes:
#   0.11.9-r0:
#     - CVE-2021-32917
#     - CVE-2021-32918
#     - CVE-2021-32919
#     - CVE-2021-32920
#     - CVE-2021-32921
#   0.11.10-r0:
#     - CVE-2021-37601
#   0.11.12-r0:
#     - CVE-2022-0217

build() {
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc/prosody \
		--ostype=linux \
		--with-lua-lib=/usr/lib \
		--with-lua-include=/usr/include \
		--lua-version=$_luaver \
		--no-example-certs \
		--runwith=lua$_luaver
	# Don't generate certs
	rm -f "$builddir"/certs/Makefile

	make
}

check() {
	# spec/util_poll_spec.lua:23: Operation not permitted
	# Test cases in "works" require stdout to be writable, fails on the builders
	/usr/bin/lua$_luaver /usr/bin/busted --helper loader --lua=/usr/bin/lua$_luaver \
		--exclude-pattern=util_poll_spec

}

package() {
	make DESTDIR="$pkgdir" install

	install -d -o prosody -g prosody "$pkgdir/var/log/prosody"
	install -d -o prosody -g prosody "$pkgdir/var/run/prosody"
	install -d -m750 -o prosody -g prosody "$pkgdir/var/lib/prosody"

	install -D -m755 "$srcdir/$pkgname.initd" "$pkgdir/etc/init.d/$pkgname"
	install -D -m644 "$srcdir/$pkgname.logrotate" "$pkgdir/etc/logrotate.d/$pkgname"
}

sha512sums="
649f1f2d4798ca5d4fd224fd3c3784f2154366c5026f4207e88de61d98aaf906dc7378e575216cb8cb740ece98efa56df45be3e8a1d8e561954ca9fba4e0e59a  prosody-13.0.2.tar.gz
20bc16c981072be39f967d27ed983aaae16383d922172a4f0751858d4bd12a521496d5f621ef178e9a0da61102d4c01ba709f63ad9ddf5b8e55fbb5f6793e7cb  prosody.logrotate
c768e92d9e80e777c4e1ca1e8918da7f98b650f3cd2f46ce1002c585e54defa6c0d78f05c19aef055507f6db6a63a7138a8aca497e1deb58295114ee8e281bf9  prosody.initd
2f7d04a4690fc8478a8fdbe41d36708792dab4b89085393818f01c6c2232d3525bba71a7daff33bbaf0fac6939c871ab1e7928f699c7c9cf5e02e1f0d26ef25c  prosody.cfg.lua.patch
"
