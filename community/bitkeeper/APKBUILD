# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=bitkeeper
pkgver=7.3.3
pkgrel=0
_gitrev=0524ffb3f6f15ae8d3922b28da581f334475fe61
pkgdesc="Scalable Distributed Source Management System"
url="https://www.bitkeeper.org/"
arch="all"
license="Apache-2.0"
makedepends="
	bash
	bison
	clang
	fontconfig-dev
	ghostscript
	gperf
	groff
	libtommath-dev
	libx11-dev
	libxft-dev
	lz4-dev
	pcre-dev
	perl
	zlib-dev
	"
subpackages="$pkgname-doc $pkgname-gui"
source="https://github.com/bitkeeper-scm/bitkeeper/archive/$_gitrev/bitkeeper-$_gitrev.tar.gz
	gcc15-boolean.patch
	gcc15-pointer.patch
	makepatch-fix.patch
	man-bk-prefix.patch
	"
builddir="$srcdir/$pkgname-$_gitrev"
options="!check" # tests need to run from a cloned bitkeeper repo

build() {
	CC=clang CFLAGS="${CFLAGS//-Os/-O3}"
	CXX=clang++ CXXFLAGS="${CXXFLAGS//-Os/-O3}"

	make \
		CC="$CC" CFLAGS="$CFLAGS" \
		CXX="$CXX" CXXFLAGS="$CXXFLAGS" \
		LD="$CC" LDFLAGS="$CFLAGS $LDFLAGS"
}

package() {
	# According to Void, this is the upstream recommended install location
	make DESTDIR="$pkgdir" BINDIR=/usr/libexec/bitkeeper install

	install -Dvm644 LICENSE* NOTICE \
		-t "$pkgdir"/usr/share/licenses/$pkgname/

	mkdir -p "$pkgdir"/usr/bin
	# Symlink target must be an absolute path or running bk will error out
	ln -sv /usr/libexec/bitkeeper/bk "$pkgdir"/usr/bin/
	chmod +x "$pkgdir"/usr/libexec/bitkeeper/contrib/git2bk.l
	ln -sv ../libexec/bitkeeper/contrib/git2bk.l "$pkgdir"/usr/bin/git2bk

	cd "$pkgdir"/usr/libexec/bitkeeper
	find . -type d -exec chmod -c 0755 {} \;

	mkdir -p "$pkgdir"/usr/share
	mv -v "$pkgdir"/usr/libexec/bitkeeper/man "$pkgdir"/usr/share/
	ln -sv bk-bk.1 "$pkgdir"/usr/share/man/man1/bk.1
}

gui() {
	pkgdesc="$pkgdesc (graphical tools)"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove \
		usr/libexec/bitkeeper/gui/bin/bkgui \
		usr/libexec/bitkeeper/gui/images \
		usr/libexec/bitkeeper/gui/lib/[!t]* \
		usr/libexec/bitkeeper/gui/lib/tk*
}

sha512sums="
2ba3d48cd38972026f582e86edbefe13c7a7751ddf5e2db9fe630de96539607116ee1e713860e877c0c28fcbad77cf00cda50006455d7e07ba1159b88f672644  bitkeeper-0524ffb3f6f15ae8d3922b28da581f334475fe61.tar.gz
531b8c85f6ad1e2e901ea68d4623679c1b7626c65af8b0fee4644573a645bb6a1bb59f8bb7f952bb0e04625b9d6b369248122abf005f26c754d21160c6a1861d  gcc15-boolean.patch
f2117943dbd09ed19bbf1334ab0b05787b4f3f64aa588ccc0bee4dac58224a13ec92566bc76f081c4de4fd33c2fac550b459078535f3c40266f8113884faea8d  gcc15-pointer.patch
ae233115976fc3a449e3d43c3610679b6ece42c385b0d1152bede3e8673690476b81696e133adce5255c1de0c1ad93344fc3782a1cf3de77fecb31c163dafd5c  makepatch-fix.patch
ca20e6d9b9b3bbf1ece4d1bc29b88e04158e4508ce3e4af8bd911e1d3b18739e0a5b76b60f27bcf75cc2e3ac42bd26ce43f587615487db0e173cf3b70c0683c5  man-bk-prefix.patch
"
