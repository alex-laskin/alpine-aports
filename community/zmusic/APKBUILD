# Contributor: Peter Shkenev <santurysim@gmail.com>
# Maintainer: Antoni Aloy <aaloytorrens@gmail.com>
pkgname=zmusic
pkgver=1.3.0
pkgrel=0
pkgdesc="GZDoom's music system as a standalone library"
url="https://github.com/ZDoom/ZMusic"
arch="all !ppc64le" # ftbfs
license="GPL-3.0-or-later AND LGPL-3.0-or-later AND LGPL-2.1-or-later AND custom"
makedepends="
	alsa-lib-dev
	cmake
	fluidsynth-dev
	libsndfile-dev
	mpg123-dev
	samurai
	zlib-dev
	"
subpackages="$pkgname-dev $pkgname-doc"
options="!check"    # No test suite
source="https://github.com/ZDoom/ZMusic/archive/refs/tags/$pkgver/zmusic-$pkgver.tar.gz
	system-fluidsynth.patch
	"
builddir="$srcdir/ZMusic-$pkgver"

prepare() {
	default_prepare

	rm -r thirdparty/fluidsynth
}

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		$CMAKE_CROSSOPTS
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	install -Dm644 licenses/dumb.txt "$pkgdir"/usr/share/licenses/$pkgname/dumb.txt
}

sha512sums="
c1dd1d47ea9d7fc1ce038e598890058d78d6f0329d2333a2714a4cbafc01a7da8d5108b9f7cd505c2fe6fb47f81101addd8ead4ad15b0a47d585f9e7194a41ae  zmusic-1.3.0.tar.gz
e561a8c9a299d90db8deed851154d041aea1cdfe47d9d0c71c518b94dbeb8a745134535595baa3e227d7348a74a8183e2ebb8feca94954ea3a21a025a43d875d  system-fluidsynth.patch
"
