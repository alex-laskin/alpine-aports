# Contributor: Marian Buschsieweke <marian.buschsieweke@posteo.net>
# Maintainer: Marian Buschsieweke <marian.buschsieweke@posteo.net>
pkgname=afl++
pkgver=4.34c
pkgrel=0
pkgdesc="Fuzzer relying on genetic algorithms instead of brute force"
url="https://aflplus.plus/"
# s390x: internal error in c compiler, see https://gitlab.alpinelinux.org/alpine/aports/-/issues/17581
arch="all !s390x"
license="Apache-2.0"
# afl-cmin requires stat
_llvmver=21
# llvm LTO test fails on riscv64
# https://github.com/AFLplusplus/AFLplusplus/issues/2064
case "$CARCH" in
	riscv64) options="$options !check";;
esac
depends="
	clang$_llvmver
	clang$_llvmver-rtlib
	lld$_llvmver
	llvm$_llvmver
	python3
	"
# install -T
makedepends="
	bash
	clang$_llvmver-dev
	coreutils
	gmp-dev
	grep
	llvm$_llvmver-dev
	python3-dev
	"
checkdepends="
	cmocka-dev
	"
subpackages="
	$pkgname-doc
	afl++-tools
	"
provides="
	afl=$pkgver-r$pkgrel
	afl-clang=$pkgver-r$pkgrel
	afl-gcc=$pkgver-r$pkgrel
	"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/AFLplusplus/AFLplusplus/archive/refs/tags/v$pkgver.tar.gz

	7806b702a280f06f09120786bace19cd3c5c4bf7.patch
	0e4c4cfb887d5793c1714f29ef426b6a476171db.patch
	"
builddir="$srcdir/AFLplusplus-$pkgver"

build() {
	export PATH="$PATH:/usr/lib/llvm$_llvmver/bin"
	export NO_NYX=1
	export AFL_NO_X86=1
	export LLVM_LTO=1
	export NO_QEMU=1
	export NO_FRIDA=1
	make PREFIX=/usr all
}

check() {
	# Unset our CFLAGS/CXXFLAGS for the tests since these may
	# interact in unexpected ways with afl-cc instrumentation.
	CFLAGS= CXXFLAGS= make AFL_NO_X86=1 test
}

package() {
	make AFL_NO_X86=1 PREFIX=/usr DESTDIR="$pkgdir" install

	# Test cases contain x86 binaries that cause trouble with strip on non-x86
	# architectures, so just drop the test cases here.
	rm -rf "$pkgdir"/usr/share/afl/testcases/

	# afl-cmin.bash is the same as afl-cmin, but implemented differently making
	# use of bash features. No need for the same functionality twice.
	rm "$pkgdir"/usr/bin/afl-cmin.bash
}

tools() {
	pkgdesc="AFL++ tools and utilities"
	depends="
		afl++
		coreutils
		grep
		"

	amove usr/bin/afl-cmin
	amove usr/bin/afl-plot
	amove usr/bin/afl-showmap
	amove usr/bin/afl-tmin
}

sha512sums="
42f8618f8da4bfd1b4e4dc97ba827cfab730b1e2755a6143dce41d9e256aadb0ff18c2f61b07ae50790612f090371f58cd1e434996373d9c799a8a00b867b574  afl++-4.34c.tar.gz
9ae623a5b24d896dfd96fa6a138f9bffae56d433356cbe20e4534726af1b4e92cb5666ea9080a360575c09ce73726b196e45ac52004d82980c1e62e3830c0223  7806b702a280f06f09120786bace19cd3c5c4bf7.patch
93a23d31aa031b2b8600cdc6505eb0bcf6036e2e81802979a5ccf98f54babfe072764d83d26fea5c8d2c43c0938701f569a27cf8e3d07ccff606895970bb2ae9  0e4c4cfb887d5793c1714f29ef426b6a476171db.patch
"
