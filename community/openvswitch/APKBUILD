# Contributor: Stuart Cardall <developer@it-offshore.co.uk>
# Maintainer: Lindsay Zhou <i@lin.moe>
maintainer="Lindsay Zhou <i@lin.moe>"
pkgname=openvswitch
# Note: Update only to LTS versions
# Check https://docs.openvswitch.org/en/latest/internals/release-process/
pkgver=3.3.6
pkgrel=0
pkgdesc="production quality, multilayer virtual switch"
url="https://www.openvswitch.org/"
arch="all"
license="Apache-2.0"
makedepends="
	autoconf
	libcap-ng-dev
	linux-headers
	openssl-dev
	perl
	py3-twisted
	python3-dev
	"
checkdepends="py3-sortedcontainers sed"
subpackages="
	$pkgname-doc
	$pkgname-dbg
	$pkgname-dev
	$pkgname-libs
	$pkgname-bash-completion
	$pkgname-test:_test
	py3-$pkgname:_py3:noarch
	$pkgname-openrc
	"
source="https://www.openvswitch.org/releases/openvswitch-$pkgver.tar.gz
	ovsdb-server.initd
	ovsdb-server.confd
	ovs-vswitchd.initd
	ovs-vswitchd.confd
	ovs-modules.initd
	ifupdown-alpine.patch
	readme.debian.patch
	fix-tests.patch
	"
options="!check" # random failed
# secfixes:
#   2.17.9-r0:
#     - CVE-2023-3966
#     - CVE-2023-5366
#   2.17.8-r0:
#     - CVE-2023-1668
#   2.17.6-r0:
#     - CVE-2023-1668
#   2.17.5-r0:
#     - CVE-2022-4337
#     - CVE-2022-4338
#   2.12.3-r2:
#     - CVE-2021-36980
#   2.12.3-r0:
#     - CVE-2020-35498
#   2.12.2-r0:
#     - CVE-2020-27827
#     - CVE-2015-8011
#   2.12.1-r0:
#     - CVE-2019-14818
#     - CVE-2020-10722
#     - CVE-2020-10723
#     - CVE-2020-10724

build() {
	CFLAGS="$CFLAGS -flto=auto" \
	./configure \
		--prefix=/usr \
		--host=$CHOST \
		--build=$CBUILD \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--disable-static \
		--enable-shared \
		--enable-libcapng
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	local _py3site=$(python3 -c "import site; print(site.getsitepackages()[0])")
	mkdir -p "$pkgdir/$_py3site"
	cp -a "$pkgdir"/usr/share/openvswitch/python/* "$pkgdir/$_py3site"/
	rm -rf "$pkgdir"/usr/share/openvswitch/python

	mkdir -p "$pkgdir"/usr/share/bash-completion
	mv "$pkgdir"/etc/bash_completion.d "$pkgdir"/usr/share/bash-completion/completions

	rm -f "$pkgdir"/usr/lib/*.a
	install -Dm755 "$srcdir"/ovsdb-server.initd \
		"$pkgdir"/etc/init.d/ovsdb-server
	install -Dm755 "$srcdir"/ovs-vswitchd.initd \
		"$pkgdir"/etc/init.d/ovs-vswitchd
	install -Dm755 "$srcdir"/ovs-modules.initd \
		"$pkgdir"/etc/init.d/ovs-modules
	install -Dm644 "$srcdir"/ovsdb-server.confd \
		"$pkgdir"/etc/conf.d/ovsdb-server
	install -Dm644 "$srcdir"/ovs-vswitchd.confd \
		"$pkgdir"/etc/conf.d/ovs-vswitchd

	mkdir -p "$pkgdir"/etc/network/if-post-down.d
	install -Dm755 debian/ifupdown.sh \
		"$pkgdir"/etc/network/if-pre-up.d/openvswitch
	ln -s ../if-pre-up.d/openvswitch \
		"$pkgdir"/etc/network/if-post-down.d/openvswitch
	mkdir -p "$pkgdir"/usr/share/doc/openvswitch
	install -Dm644 debian/openvswitch-switch.README.Debian \
		"$pkgdir"/usr/share/doc/openvswitch/README.alpine
}

_test() {
	pkgdesc="Open vSwitch testing utilities"
	depends="py3-$pkgname=$pkgver-r$pkgrel py3-twisted"
	amove \
		usr/bin/ovs-pcap \
		usr/bin/ovs-tcpdump \
		usr/bin/ovs-tcpundump \
		usr/bin/ovs-testcontroller \
		usr/lib/python*/site-packages/ovstest
}

_py3() {
	pkgdesc="Python modules for Open vSwitch"
	amove usr/lib/python*
}

sha512sums="
35280ec92501a51cecc0a6c00c83d5d85bd22ffc58c8975f4fd9c056944205499a60306d1daacf65f810df66df24cf1296f59f58a7375b7203ce85515268ee0a  openvswitch-3.3.6.tar.gz
097d4721a78fff749c534910d98543778474406bd61b469b88a0d981a2a380556444437ec44278cead6d8688c45a38b2acbf1551acb9ab38d048f413728e3b88  ovsdb-server.initd
b1588d076bbfc7ef2dd46fce8e46186f40cbbc4667697f7ac13ddc68e34568fdab315fde47838de7f6d32916853190336cfe3735f672ad7cb624ae14dbff55a5  ovsdb-server.confd
4bff37f8bed32d5327b4b0433984ab8ffdce77f618034aa6ffd1ad4a7caa00703ea2bef312876dce5aafa4c17fe06dddd75e5c05c10e13bf8f5c3805a0654a96  ovs-vswitchd.initd
346aea099f51707d2b4fc9fdc8c1502582723fb4e00c4d5d1624b0378c94dfb76674fa95e2af894f36169df52109dbe441ee6a45aa744584d9e4c74d15a46c1d  ovs-vswitchd.confd
1e08aa5ac6ce55b97256478b9243c8a4c92a42a97fc70ea0439c832b12a775af28a127224ae6c4ce01642dde65f76c610a44105912338bf443d8ea390c2d9ccf  ovs-modules.initd
3ed7baad4274887657896accbf72a4f6e8540dfeaa800f7ec1bcf3528e71cc7e682ae4f8ca505dde2b90a08280915e71cc433735f3286f4dc33c810ce4f28ec6  ifupdown-alpine.patch
993588f22dcf4fc5855734d331b8770ec09da4762e34359a645f3c29c67ad3134356950475d98881ea892eec5c3f68fffb8e81a605d6cc4b36cb65995e733208  readme.debian.patch
0a3420fb4b0ee0ef15f98e40c61c433a5f35ef256b747e56dcd484bfd12609c6cd02d4828cabe0411eb7b3a307fbab40c1e7562f0c95d4004fc6cbfa1c93dda6  fix-tests.patch
"
