maintainer="Hoang Nguyen <folliekazetani@protonmail.com>"
pkgname=py3-gql
pkgver=4.0.0
pkgrel=0
pkgdesc="GraphQL client in Python"
url="https://gql.readthedocs.io/"
arch="noarch"
license="MIT"
depends="
	python3
	py3-anyio
	py3-backoff
	py3-graphql-core
	py3-yarl
	"
makedepends="
	py3-setuptools
	py3-gpep517
	py3-installer
	py3-wheel
	"
checkdepends="
	py3-aiofiles
	py3-aiohttp
	py3-mock
	py3-parse
	py3-pytest
	py3-pytest-asyncio
	py3-pytest-console-scripts
	py3-requests
	py3-requests-toolbelt
	py3-urllib3
	py3-botocore
	py3-httpx
	py3-vcrpy
	py3-websockets
	"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/graphql-python/gql/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/gql-$pkgver"

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl

	# All tests in test_transport.py and test_transport_batch.py rely on a locally running graphql API endpoint
	# A few tests try to execute the built gql-cli program, so export PATH here
	PATH="$PATH:$builddir/.testenv/bin" \
		.testenv/bin/python3 -m pytest tests/ \
		--ignore=tests/test_transport.py \
		--ignore=tests/test_transport_batch.py
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

sha512sums="
a1ae73d5847025019a222654925910b71b08180a05cd0f0e70b3233b5bf024313fa66a110fda3a4a581245384e59fde5995884441646a3b2e57e610f77ac9093  py3-gql-4.0.0.tar.gz
"
