# Maintainer: kpcyrd <git@rxv.cc>
pkgname=wasm-bindgen
pkgver=0.2.104
pkgrel=0
pkgdesc="Interoperating JS and Rust code"
url="https://github.com/rustwasm/wasm-bindgen"
arch="all"
license="Apache-2.0"
depends="cargo nodejs rust-wasm"
makedepends="
	cargo-auditable
	"
source="https://github.com/rustwasm/wasm-bindgen/archive/refs/tags/$pkgver/wasm-bindgen-$pkgver.tar.gz
	Cargo-$pkgver.lock::https://gitlab.archlinux.org/archlinux/packaging/packages/wasm-bindgen/-/raw/$pkgver-1/Cargo.lock
	"
options="net !check" # most tests fail outside of x86_64

prepare() {
	# https://github.com/rustwasm/wasm-bindgen/issues/1819
	cp "$srcdir/Cargo-$pkgver.lock" Cargo.lock

	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cd crates/cli
	cargo auditable build --release --frozen
}

check() {
	cd crates/cli
	cargo test --frozen
}

package() {
	install -Dm755 -t "$pkgdir"/usr/bin \
		target/release/wasm-bindgen \
		target/release/wasm-bindgen-test-runner \
		target/release/wasm2es6js
}

sha512sums="
d83608330f83aa86b5525627af8a8dd0fe25b8340301790ba0cb1af250a025ad16cd1d633922f0c7cbd1c35baa54abd3a5cda5512c8d8bdaadbc96d0334854c2  wasm-bindgen-0.2.104.tar.gz
73764ed1f090a22eb3a8305ec315f43f1525a53747d843fe44c908c500c2218a8cded65429ab0ed9fca42f9373bf36b35ac80de49afb2683ddf032b485853d0a  Cargo-0.2.104.lock
"
