From 49a5dd5d6ce38bb28eefe7bbc4ed26265275478a Mon Sep 17 00:00:00 2001
From: Manuel Stoeckl <code@mstoeckl.com>
Date: Sat, 16 Aug 2025 18:19:09 -0400
Subject: [PATCH] Specify soname instead of linker name for dynamic libraries

---
 src/gbm.rs           | 4 ++--
 src/video.rs         | 5 +++--
 wrap-ffmpeg/build.rs | 2 ++
 3 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/src/gbm.rs b/src/gbm.rs
index ff150ba..6b68207 100644
--- a/src/gbm.rs
+++ b/src/gbm.rs
@@ -169,9 +169,9 @@ pub fn setup_gbm_device(device: Option<u64>) -> Result<Option<Rc<GBMDevice>>, St
         return Ok(None);
     }
     unsafe {
-        let bindings = match gbm::new("libgbm.so") {
+        let bindings = match gbm::new("libgbm.so.1") {
             Err(x) => {
-                error!("Failed to load libgbm.so: {}", x);
+                error!("Failed to load libgbm.so.1: {}", x);
                 return Ok(None);
             }
             Ok(x) => x,
diff --git a/src/video.rs b/src/video.rs
index 9a989a5..829de95 100644
--- a/src/video.rs
+++ b/src/video.rs
@@ -17,7 +17,7 @@ use waypipe_ffmpeg_wrapper::{
     AVPixelFormat_AV_PIX_FMT_NONE, AVPixelFormat_AV_PIX_FMT_NV12, AVPixelFormat_AV_PIX_FMT_VULKAN,
     AVPixelFormat_AV_PIX_FMT_YUV420P, AVRational, AVVkFrame, AVVulkanDeviceContext,
     AVVulkanFramesContext, VkStructureType_VK_STRUCTURE_TYPE_PHYSICAL_DEVICE_FEATURES_2,
-    AV_LOG_VERBOSE, AV_LOG_WARNING, AV_NUM_DATA_POINTERS,
+    AV_LOG_VERBOSE, AV_LOG_WARNING, AV_NUM_DATA_POINTERS, LIBAVCODEC_VERSION_MAJOR,
 };
 use waypipe_shaders::{NV12_IMG_TO_RGB, RGB_TO_NV12_IMG, RGB_TO_YUV420_BUF, YUV420_BUF_TO_RGB};
 
@@ -599,7 +599,8 @@ pub unsafe fn setup_video(
     device_exts: &[*const c_char],
     instance_exts: &[*const c_char],
 ) -> Result<Option<VulkanVideo>, String> {
-    let lib = match ffmpeg::new("libavcodec.so") {
+    /* loading libavcodec transitively loads a matching libavutil */
+    let lib = match ffmpeg::new(format!("libavcodec.so.{}", LIBAVCODEC_VERSION_MAJOR)) {
         Ok(x) => x,
         Err(x) => {
             error!("Failed to load libavcodec (+ libavutil, etc.): {}. Video encoding/decoding is disabled.", x);
diff --git a/wrap-ffmpeg/build.rs b/wrap-ffmpeg/build.rs
index 4dae998..ca4803c 100644
--- a/wrap-ffmpeg/build.rs
+++ b/wrap-ffmpeg/build.rs
@@ -99,6 +99,8 @@ fn main() {
         "AV_LOG_INFO",
         "AV_LOG_WARNING",
         "AV_NUM_DATA_POINTERS",
+        "LIBAVUTIL_VERSION_MAJOR",
+        "LIBAVCODEC_VERSION_MAJOR",
     ];
 
     let bindgen = "bindgen";
-- 
2.51.0

