# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=roc-toolkit
pkgver=0.4.0
pkgrel=1
pkgdesc="Real-time audio streaming over the network"
url="https://roc-streaming.org/"
arch="all"
license="MPL-2.0"
depends_dev="
	libsndfile-dev
	libunwind-dev
	libuv-dev
	openssl-dev
	speexdsp-dev
	"
makedepends="
	$depends_dev
	cpputest
	gengetopt
	ragel
	scons
	cmake
	samurai
	"
checkdepends="python3"
subpackages="$pkgname-libs $pkgname-dev $pkgname-doc"
source="https://github.com/roc-streaming/roc-toolkit/archive/v$pkgver/roc-toolkit-$pkgver.tar.gz
	samurai.patch
	"
options="net" # Required for tests

case $CARCH in
	# CHECK(backend_device != NULL) failed
	# https://github.com/roc-streaming/roc-toolkit/issues/744
	s390x) options="$options !check" ;;
esac

_run_scons() {
	scons \
		--prefix=/usr \
		--with-libraries=/usr/lib \
		--enable-tests \
		--disable-sox \
		--build-3rdparty=openfec \
		--disable-pulseaudio \
		"$@"
}

build() {
	# Export cmake minimum version for third-party openfec-1.4.2.9
	export CMAKE_POLICY_VERSION_MINIMUM=3.5
	export CFLAGS="$CFLAGS -O2 -flto=auto"
	export CXXFLAGS="$CXXFLAGS -O2 -flto=auto"
	_run_scons
}

check() {
	_run_scons test
}

package() {
	export DESTDIR="$pkgdir"
	_run_scons install
}

sha512sums="
51763287ee825b6617273ededd9e77560f4223b8ba4a577855c3225908e848895a4f925163862cf6d19a8215245ec26f33d07d6cb80c51768d37eaa06ac02063  roc-toolkit-0.4.0.tar.gz
89ff1fd3237a156d66e3c368550c18a71ceddeb5175e2674f4f5e1d261f69773e0cf5afb697201dd9e6377c772acf83f3a4907d625ab895bdc01c1d85abd9926  samurai.patch
"
