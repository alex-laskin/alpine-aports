# Maintainer: Marian Buschsieweke <marian.buschsieweke@posteo.net>
pkgname=py3-pymupdf
_pkgname=PyMuPDF
pkgver=1.26.4
pkgrel=0
pkgdesc="Python lib for data extraction, analysis, conversion & manipulation of PDF"
url="https://github.com/pymupdf/PyMuPDF"
# s390x: limited by py3-mupdf
arch="all !s390x"
license="AGPL-3.0"
depends="
	py3-mupdf
	"
makedepends="
	mupdf-dev
	py3-setuptools
	py3-gpep517
	py3-wheel
	python3-dev
	swig
	"
checkdepends="
	py3-codespell
	py3-flake8
	py3-pillow
	py3-psutil
	py3-pytest
	"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/pymupdf/PyMuPDF/archive/refs/tags/$pkgver.tar.gz
	https://github.com/user-attachments/files/20862923/test_4457_a.pdf
	https://github.com/user-attachments/files/20862922/test_4457_b.pdf
	test_4445.pdf::https://github.com/user-attachments/files/19738242/ss.pdf
	test_4533.pdf::https://github.com/user-attachments/files/20497146/NineData_user_manual_V3.0.5.pdf
	"
builddir="$srcdir"/$_pkgname-$pkgver

prepare() {
	default_prepare
	mkdir tests/cache
	mv "$srcdir"/*.pdf tests/cache/
}

build() {
	PYMUPDF_SETUP_MUPDF_BUILD='' \
		gpep517 build-wheel \
			--wheel-dir .dist \
			--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	PATH="$builddir/.testenv/bin:$PATH" .testenv/bin/python3 -m pytest \
		--deselect tests/test_barcode.py::test_barcode \
		--deselect tests/test_codespell.py::test_codespell \
		--deselect tests/test_font.py::test_fontarchive \
		--deselect tests/test_general.py::test_subset_fonts \
		--deselect tests/test_general.py::test_open2 \
		--deselect tests/test_general.py::test_4392 \
		--deselect tests/test_pixmap.py::test_color_count \
		--deselect tests/test_pixmap.py::test_3050 \
		--deselect tests/test_pixmap.py::test_3854 \
		--deselect tests/test_pylint.py::test_pylint \
		--deselect tests/test_tesseract.py::test_tesseract \
		--deselect tests/test_textextract.py::test_4180 \
		--deselect tests/test_pixmap.py::test_3050 \
		--deselect tests/test_textbox.py::test_textbox3
}

package() {
	gpep517 install-wheel --destdir "$pkgdir" \
		.dist/*.whl
}

sha512sums="
0adb7b1d0b21080f34ab4263ffcde5fb6b12672cdbde20f3b71ee0b21eb4f3f4b7460b5fc62b63df7b804fd69d4166d754abf557b75a36c02982069a8ea0d3b7  py3-pymupdf-1.26.4.tar.gz
6d96470d6211d1a1cdd5cada94155e029eac127889ebf522c0aae6cbcb55045dc8510ca33618b093af2a6b8a164eecd704384d05445d3614e4763960d8db37dc  test_4457_a.pdf
e41d9c5b0aba3399c5e4fe4036ca1b52ae96daeddd20dd551ffc46dbf3fbba16bd0aaf5ec87b2ff7cc692791671bfeb775825bca08793cea9d2abd145cca71fb  test_4457_b.pdf
77c1002eecd0016172394071158261db6355d4ff9b759017198f1cf0a9a3f2691de44b252695ebec3c9e1c62172ef785cb19ab319ee7d9ccfb6893c9b49069c2  test_4445.pdf
a438a8d6852f3ca5954403a0033ec62f863b62ca6356a46e382ac7856bab65a064cc866229c4c2c3035f0185baa3b377002a92bbc4da31daf3baba35f0eb4042  test_4533.pdf
"
