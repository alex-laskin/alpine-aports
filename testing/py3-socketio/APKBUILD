maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=py3-socketio
_pkgname=python-socketio
pkgver=5.13.0
pkgrel=0
pkgdesc="Python 3 implementation of the Socket.IO realtime server"
url="https://github.com/miguelgrinberg/python-socketio"
# riscv64: py3-eventlet
arch="noarch !riscv64"
license="MIT"
depends="
	py3-bidict
	py3-engineio
	py3-msgpack
"
makedepends="
	py3-gpep517
	py3-setuptools
	py3-sphinx
	py3-wheel
"
checkdepends="
	py3-aiohttp
	py3-eventlet
	py3-gevent
	py3-gevent-websocket
	py3-pytest
	py3-pytest-asyncio
	py3-redis
	py3-tornado
	uvicorn
"
subpackages="$pkgname-pyc $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::$url/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/$_pkgname-$pkgver"


build() {
	gpep517 build-wheel --wheel-dir dist --output-fd 3 3>&1
	PYTHONPATH="$PWD/src" make -j1 -C docs man text SPHINXBUILD=sphinx-build
}

check() {
	python3 -m venv --system-site-packages test-env
	test-env/bin/python -m installer dist/*.whl
	test-env/bin/python -m pytest
}

package() {
	python3 -m installer --destdir="$pkgdir" dist/*.whl
	install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
	install -Dm644 docs/_build/text/index.txt "$pkgdir/usr/share/doc/$pkgname/DOCUMENTATION"
	install -Dm644 docs/_build/man/python-socketio.1 \
		"$pkgdir/usr/share/man/man1/$pkgname.1"
	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
sha512sums="
4835d27048c04c0524a08174482a32a3fc7b26b9dc35092ce69c2162102ba53362effa15a9e4319d9fee62d1c8d7d14b4ed828d0d9cfc313429cf1b9107fd6d7  py3-socketio-5.13.0.tar.gz
"
