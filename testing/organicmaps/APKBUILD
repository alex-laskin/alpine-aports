maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=organicmaps
pkgver=2025.09.05.1
_just_gtfs_commit=7516753825500f90ac2de6f18c256d5abec1ff33
_protobuf_commit=9442c12e866b56369f1c53abea1261259c924a19
_fast_obj_commit=42629f744269e004907a6fb4f16c6c7f69acc586
_pkgver=${pkgver%.*}-${pkgver##*.}
pkgrel=0
pkgdesc="Free offline maps app"
url="https://organicmaps.app/"
arch="all"
license="Apache-2.0"
makedepends="
	bash
	boost-dev
	cmake
	expat-dev
	fast-double-parser
	gflags-dev
	gtest-dev
	jansson-dev
	pugixml-dev
	qt6-qtbase-dev
	qt6-qtpositioning-dev
	qt6-qtsvg-dev
	samurai
	utfcpp
	glm-dev
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/organicmaps/organicmaps/archive/refs/tags/$_pkgver-linux.tar.gz
	$pkgname-just_gtfs-$_just_gtfs_commit.tar.gz::https://github.com/organicmaps/just_gtfs/archive/$_just_gtfs_commit.tar.gz
	$pkgname-protobuf-$_protobuf_commit.tar.gz::https://github.com/organicmaps/protobuf/archive/$_protobuf_commit.tar.gz
	fast_obj-$_fast_obj_commit.tar.gz::https://github.com/thisistherk/fast_obj/archive/$_fast_obj_commit.tar.gz
	use-external-jansson.patch
	libs-hack.patch
	use-internal-protobuf.patch
	no-dev-sandbox.patch
	no-macdeployqt.patch
	"
builddir="$srcdir/$pkgname-$_pkgver-linux"
options="!check" # fail

prepare() {
	default_prepare

	mv "$srcdir"/just_gtfs-*/* "$builddir"/3party/just_gtfs/
	mv "$srcdir"/protobuf-*/* "$builddir"/3party/protobuf/protobuf/
	mv "$srcdir"/fast_obj-*/* "$builddir"/3party/fast_obj/
}

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=OFF \
		-DBUILD_DESIGNER:BOOL=OFF \
		-DBUILD_STANDALONE:BOOL=ON \
		-DWITH_SYSTEM_PROVIDED_3PARTY=ON \
		$crossopts
	cmake --build build
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	rm -r "$pkgdir"/usr/share/organicmaps/data/test_data/
}

sha512sums="
a36b717108dcb5867916d9a1fd3a87fd26b20db377ce31eca570c70d57b109cce35b5e492b9768a68fb709d88f1348b001287f77d9f5495bb6382b5dc4e8d1ad  organicmaps-2025.09.05.1.tar.gz
b1095b4cf0e5268c49344a9d64a5d805b5b2923657dd1bde72e5a097453b83b3cfdac3e8c032ec492da57c39700ea3f2e0ad53a4ddf4f23244fe8564776378a8  organicmaps-just_gtfs-7516753825500f90ac2de6f18c256d5abec1ff33.tar.gz
f1149d71ba09c0becebaf6564980d0aa05433c2caeb6df6cebddd635758f76d578524638b3adb92fd8813286a4ee5f5b5aa2253493287693800b8904b5ab71f6  organicmaps-protobuf-9442c12e866b56369f1c53abea1261259c924a19.tar.gz
6ad72d4436e9b3a0de5ee0b49dae09c3c89883d2bf9488955713baffc57092769519ebd77f570b6aec56dd2665d1ee68e553d9aea6081c3dd9b2ac30e5ce287e  fast_obj-42629f744269e004907a6fb4f16c6c7f69acc586.tar.gz
bd914dbb254e8c080953ebecde63a5d6431ca6a59d358125ead9a3d6046cfaa16870942a9cb5606530e8ae076e828f5151c4bc70aa38e14dd3956c388ac5c499  use-external-jansson.patch
8a1092612b4996b485dac644a1db548d39262387e80b2f46ff889f77547e8999aa8016045ca07e1c58cf4294729850307de7d7e17dd8f43caa28c07e4856e0b6  libs-hack.patch
51749a6d7721df7d510016b251b7c376000753091ada2c0df79c9f321321a189c769cc9fa20f5145b2e6b1a06e1d5353ad64b6e368f16d128ee2e4ef2932f238  use-internal-protobuf.patch
f233535ecbe5e331b142cfc2d9ad74fca87169b65ec760f8ab4d93bd22d393eef70e9d26342df7df0bd3c162e79750f8c8eda365afdbb7e05ae3f8dd839f92f6  no-dev-sandbox.patch
54780eb25add0fc0f2b7f11eeb9f1cb88bbff325011f1a300b536c8d37ecdb61aa7789ae77f2abd3b94530e818c955e4d9b8948a2b757e35bc2ff8a677c3ee01  no-macdeployqt.patch
"
