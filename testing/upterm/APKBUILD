maintainer="Hoang Nguyen <folliekazetani@protonmail.com>"
pkgname=upterm
pkgver=0.17.0
pkgrel=0
pkgdesc="Secure terminal sharing"
url="https://upterm.dev/"
arch="all"
license="Apache-2.0"
makedepends="go"
checkdepends="bash"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-zsh-completion
	$pkgname-server
	$pkgname-server-openrc
	"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/owenthereal/upterm/archive/refs/tags/v$pkgver.tar.gz
	uptermd.initd
	uptermd.confd
	"
options="net !check" # fail on network flakiness

build() {
	local _goldflags="
	-X github.com/owenthereal/upterm/internal/version.Version=$pkgver
	-X github.com/owenthereal/upterm/internal/version.GitCommit=AlpineLinux
	-X github.com/owenthereal/upterm/internal/version.Date=$(date -u '+%Y-%m-%dT%H:%M:%S%z' ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})
	"

	mkdir out
	go build -v -o out/ \
		-ldflags "$_goldflags" \
		./cmd/upterm ./cmd/uptermd

	# Re-generate completion files and man pages
	go run cmd/gendoc/main.go
}

package() {
	install -Dm755 out/upterm out/uptermd \
		-t "$pkgdir"/usr/bin/

	install -Dm644 etc/man/man1/*.1 -t "$pkgdir"/usr/share/man/man1/
	install -Dm644 etc/completion/upterm.bash_completion.sh \
		"$pkgdir"/usr/share/bash-completion/completions/upterm
	install -Dm644 etc/completion/upterm.zsh_completion \
		"$pkgdir"/usr/share/zsh/site-functions/_upterm
	install -Dm755 "$srcdir"/uptermd.initd "$pkgdir"/etc/init.d/uptermd
	install -Dm644 "$srcdir"/uptermd.confd "$pkgdir"/etc/conf.d/uptermd
}

server() {
	pkgdesc="$pkgdesc (server)"
	install="$pkgname-server.pre-install"
	amove usr/bin/uptermd
}

sha512sums="
1178949b38817fd5b80cb7864b5fe9f2ea6af41dcca19ad43f943cc06b6416438ac2a2f611f593583bb535c11b3b7d7c67bf57b5e122b3fa883ccc2806596efb  upterm-0.17.0.tar.gz
981ef973c13ba36204f3b8f942a1c32cbdb9bf37d9de78e20e62d1cd2c45b0dcd4fcf58a157e18951082d54ab6cf22febdd94a340e5185e29ee1e6a1ceecd4b3  uptermd.initd
3a8119bcbab8c93ef607297d6e4b5cdbfc758cfec3e9eb43b46a271a8f25fe9f615b5284773ced389351ab1730797327fb4ea53431c1a6f465628514d53d6691  uptermd.confd
"
