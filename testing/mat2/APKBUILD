# Contributor: Waweic <waweic@activ.ism.rocks>
# Maintainer: Waweic <waweic@activ.ism.rocks>
pkgname=mat2
pkgver=0.13.5
pkgrel=0
pkgdesc="Metadata removal tool, supporting a wide range of commonly used file formats"
url="https://0xacab.org/jvoisin/mat2"
arch="noarch"
license="LGPL-3.0-or-later"
depends="
	exiftool
	gdk-pixbuf
	gobject-introspection
	librsvg
	mailcap
	poppler-glib
	py3-cairo
	py3-gobject3
	py3-mutagen
	python3
	"
makedepends="py3-setuptools py3-gpep517"
checkdepends="ffmpeg"
source="https://0xacab.org/jvoisin/mat2/-/archive/$pkgver/mat2-$pkgver.tar.gz
	skip-failed-tests.patch
	"
subpackages="$pkgname-doc $pkgname-pyc"

prepare() {
	default_prepare

	# doesn't contain a version in [project], so it's invalid to parse from a
	# builder, 	# but we can ignore all that as all the logic is in setup.*
	rm -fv pyproject.toml
}

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	gpep517 install-wheel --destdir .testenv --prefix '' .dist/*.whl
	.testenv/bin/python3 -m unittest discover
}

package() {
	gpep517 install-wheel --destdir "$pkgdir" \
		.dist/*.whl
	install -Dm 644 doc/*.md -t "$pkgdir/usr/share/doc/$pkgname"
}

sha512sums="
a700f5c136b20203b5173c685b49d589f75082a067b9a6059766dd3d78d7cf2988080c5e523e0d35e6aced79790e9a322c3b0d4a8364bb83af6ce2490acb6abb  mat2-0.13.5.tar.gz
0cf3de4a6e1a726513607b383438073784cc5fb71417b154473b6d72bf2212ac2f71eb6ac68f95e0f3f2132bfa4dc60bce27f863e21ed08b7ceec3e61a8f714e  skip-failed-tests.patch
"
