maintainer="Leon White <badfunkstripe@gmail.com>>"
pkgname=py3-duckdb
_pkgname=${pkgname#py3-}
pkgver=1.4.0
pkgrel=0
pkgdesc="High-performance analytical database system (Python3 module)"
url="https://duckdb.org"
arch="x86_64 aarch64" # same as duckdb
license="MIT"
depends="python3"
makedepends="
	py3-installer
	py3-numpy
	py3-pybind11-dev
	py3-scikit-build-core
	py3-setuptools_scm
	python3-dev
	samurai
	uv
"
checkdepends="
	py3-mypy
	py3-pandas
	py3-pytest
	py3-pytest-reraise
	py3-typing-extensions
"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://files.pythonhosted.org/packages/source/${_pkgname:0:1}/$_pkgname/$_pkgname-$pkgver.tar.gz"
builddir="$srcdir/$_pkgname-$pkgver"
options="!check" # no tests in sdist

build() {
	uv build --wheel --no-build-isolation \
		--config-setting=skbuild.ninja.version=">=1.9"
}

check() {
	# tests for github version of source package
	python3 -m pytest --shell-binary build/duckdb tools/shell/tests

	# tests/stubs/test_stubs.py depends on py3-mypy (and isn't worth the effort)
	# tests/fast/api/test_query_progress.py fails with query start timeout (x86_64)
	_skip_tests="--ignore=tests/stubs/test_stubs.py --ignore=tests/fast/api/test_query_progress.py"

	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer dist/*.whl
	.testenv/bin/python3 -m pytest tests $_skip_tests
}

package() {
	python3 -m installer -d "$pkgdir" \
		dist/*.whl
}

sha512sums="
a19b28c5683266d475713d0675a60856d8f0b2e54eab931b08679aeee454f9eff7c0261bd36df72a3ebbb2a0772ca838f1870f245be4a2be2aa8968baa60b416  py3-duckdb-1.4.0.tar.gz
"
