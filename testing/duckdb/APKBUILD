maintainer="Leon White <badfunkstripe@gmail.com>>"
pkgname=duckdb
pkgver=1.4.0
pkgrel=0
# Run `git describe --tags --long` from source repo checked out at the $pkgver tag to get this 10-character hash
_pkghash=b8a06e4a22
pkgdesc="High-performance analytical database system"
url="https://duckdb.org"
# No support for 32-bit or big-endian architectures
# Other archs exit with Error: Unrecognized opcode: `pause'
arch="x86_64 aarch64"
license="MIT"
makedepends="
	cmake
	openssl-dev
	samurai
	unixodbc-dev
	"
depends_dev="$pkgname-libs=$pkgver-r$pkgrel"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-libs
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/duckdb/duckdb/archive/refs/tags/v$pkgver.tar.gz"

export OVERRIDE_GIT_DESCRIBE="v$pkgver-0-g$_pkghash"

build() {
	# TODO: unvendor thirdparty source files
	# shellcheck disable=2086
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCORE_EXTENSIONS='icu;parquet;json' \
		-DMUSL_ENABLED=ON \
		-DOVERRIDE_GIT_DESCRIBE="$OVERRIDE_GIT_DESCRIBE"
	cmake --build build
}

check() {
	# fails with mismatch:
	# test/issues/general/test_17757.test (aarch64)
	# test/sql/aggregate/distinct/grouped/distinct_grouping_tpch.test_slow (aarch64)
	# test/sql/copy/csv/rejects/csv_buffer_size_rejects.test_slow (aarch64, x86_64)
	# test/sql/storage/compression/alp/alp_tpcds.test_slow (x86_64)
	# test/sql/storage/parallel/insert_order_preserving_odd_sized_batches.test_slow (x86_64)
	# test/sql/storage/parallel/reclaim_space_insert_unique_idx_optimistic.test_slow (aarch64)
	# test/sql/copy/parquet/writer/parquet_write_memory_limit.test_slow (oom on aarch64)
	# The other tests simply segfault (no error output).
	build/test/unittest "*" \
		exclude:'Test Parquet Files round-trip' \
		exclude:'test/fuzzer/duckfuzz/array_group_by_sample.test' \
		exclude:'test/issues/general/test_17757.test' \
		exclude:'test/sql/aggregate/aggregates/test_list_aggregate_function.test_slow' \
		exclude:'test/sql/aggregate/distinct/grouped/distinct_grouping_tpch.test_slow' \
		exclude:'test/sql/aggregate/group/test_group_by_nested.test' \
		exclude:'test/sql/copy/csv/rejects/csv_buffer_size_rejects.test_slow' \
		exclude:'test/sql/join/test_nested_keys.test_slow' \
		exclude:'test/sql/join/test_nested_payloads.test_slow' \
		exclude:'test/sql/order/issue_11936.test' \
		exclude:'test/sql/order/test_order_nested.test_slow' \
		exclude:'test/sql/order/test_order_variable_size_payload.test_slow' \
		exclude:'test/sql/storage/compression/alp/alp_tpcds.test_slow' \
		exclude:'test/sql/storage/parallel/insert_order_preserving_odd_sized_batches.test_slow' \
		exclude:'test/sql/storage/parallel/reclaim_space_insert_unique_idx_optimistic.test_slow' \
		exclude:'test/sql/copy/parquet/writer/parquet_write_memory_limit.test_slow' \
		exclude:'test/sql/types/list/nested_list_extract.test' \
		exclude:'test/sql/types/nested/array/array_sort.test_slow'
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm644 LICENSE -t "$pkgdir/usr/share/licenses/$pkgname/"

	# We don't need these source files
	rm -rf "$pkgdir"/usr/duckdb_build "$pkgdir"/usr/includes.list "$pkgdir"/usr/sources.list
}

sha512sums="
c6514268d136b7c1c768c4d5470b230345b68d5db0c78acd48329d8fa0b6faff146d1840ff5d207dacdc9930a60aed09495f3867bd0e11bc9c63bdbef7781478  duckdb-1.4.0.tar.gz
"
