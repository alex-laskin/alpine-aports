maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=py3-flask-socketio
_pkgname=Flask-SocketIO
pkgver=5.5.1
pkgrel=0
pkgdesc="Socket.IO integration for Flask applications (Python 3)"
url="https://github.com/miguelgrinberg/Flask-SocketIO"
# riscv64: py3-eventlet, py3-socketio
arch="noarch !riscv64"
license="MIT"
depends="
	py3-eventlet
	py3-flask
	py3-simple-websocket
	py3-socketio
	py3-werkzeug
"
makedepends="
	py3-gpep517
	py3-setuptools
	py3-sphinx
	py3-wheel
"
checkdepends="py3-pytest py3-redis"
subpackages="$pkgname-pyc $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::$url/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/$_pkgname-$pkgver"

build() {
	gpep517 build-wheel --wheel-dir dist --output-fd 3 3>&1
	PYTHONPATH="$PWD/src" make -j1 -C docs man text SPHINXBUILD=sphinx-build
}

check() {
	python3 -m venv --system-site-packages test-env
	test-env/bin/python -m installer dist/*.whl
	test-env/bin/python -m pytest \
		--deselect test_socketio.py::TestSocketIO::test_background_task
}

package() {
	python3 -m installer --destdir="$pkgdir" dist/*.whl

	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
	install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
	install -Dm644 docs/_build/text/index.txt "$pkgdir/usr/share/doc/$pkgname/index.txt"
	install -Dm644 docs/_build/man/flask-socketio.1 \
		"$pkgdir/usr/share/man/man1/$pkgname.1"
}

sha512sums="
3118a70fedeb66a88af17446e8527f9b34a5b7b0f1c062622d5ea89821837b0af84e41a34ff954de9f9fb50fd1c82d1bf99889a13cfbd8ec909c5fc81c1ccb5c  py3-flask-socketio-5.5.1.tar.gz
"
