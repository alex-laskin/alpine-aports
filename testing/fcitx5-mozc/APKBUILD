# Maintainer: Lauri Tirkkonen <lauri@hacktheplanet.fi>
pkgname=fcitx5-mozc
# there are no meaningful tags/releases in fcitx/mozc we could use. official
# flatpak builds use the mozc version string (and store it in
# src/unix/fcitx5/org.fcitx.Fcitx5.Addon.Mozc.metainfo.xml.in), but since mozc
# is only one component of fcitx5-mozc, we need to disambiguate further, so we
# append the commit date from fcitx/mozc to pkgver.
#
# in a way even that's not correct, because we have so many different source
# inputs to the build, but probably good enough.
pkgver=2.31.5851.102.20250917
_fcitx_mozc_commit=d1a070e6611640686979dc22e1308dc5606c8271
pkgrel=0
pkgdesc="fcitx plugin for Mozc Japanese IME"
url="https://github.com/fcitx/mozc"
# bazel8 is only available for these arches
arch="aarch64 x86_64"
license="BSD-3-Clause AND Apache-2.0 AND LGPL-2.0-or-later AND Unicode-DFS-2015 AND NAIST-2003"
depends="fcitx5"
makedepends="fcitx5-dev bash bazel8 qt6-qtbase-dev musl-fts-dev python3"
subpackages="$pkgname-doc $pkgname-lang"

# git submodules from fcitx/mozc/src/third_party/
_abseil_cpp_commit=987c57f325f7fa8472fa84e1f885f7534d391b0d
_breakpad_commit=216cea7bca53fa441a3ee0d0f5fd339a3a894224
_googletest_commit=52eb8108c5bdec04579160ae17225d66034bd723
_gyp_commit=9ecf45e37677743503342ee4c6a76eaee80e4a7f
_japanese_usage_dictionary_commit=e5b3425575734c323e1d947009dd74709437b684
_protobuf_commit=4fbd1111a292d04746c732573025e3251de0bb9c
_wil_commit=fc5dbf55989fe20351c71d038a8d12de4b397a6d
# and their source urls
_submodule_src="
https://github.com/abseil/abseil-cpp/archive/$_abseil_cpp_commit/abseil-cpp-$_abseil_cpp_commit.tar.gz
https://github.com/google/breakpad/archive/$_breakpad_commit/breakpad-$_breakpad_commit.tar.gz
https://github.com/google/googletest/archive/$_googletest_commit/googletest-$_googletest_commit.tar.gz
https://github.com/chromium/gyp/archive/$_gyp_commit/gyp-$_gyp_commit.tar.gz
https://github.com/hiroyuki-komatsu/japanese-usage-dictionary/archive/$_japanese_usage_dictionary_commit/japanese-usage-dictionary-$_japanese_usage_dictionary_commit.tar.gz
https://github.com/protocolbuffers/protobuf/archive/$_protobuf_commit/protobuf-$_protobuf_commit.tar.gz
https://github.com/microsoft/wil/archive/$_wil_commit/wil-$_wil_commit.tar.gz
"
# for building without network, we need a copy of the BCR
_bazel_central_registry_commit=4c9fa3699160fc77965fe02398ea037f22a9b290
# as well as all the bazel dependencies of mozc. we follow the same versions
# as https://github.com/fcitx/flatpak-fcitx5/blob/master/mozc-deps.yaml does.
# do 'abuild update_bazel_deps" to update this list from the above url.
# NOTE: there is some overlap between the submodules above and the bazel deps
# (eg. abseil-cpp, protobuf), but that's expected; they might be different
# versions.
_bazel_deps="
abseil-cpp-20250814.0.tar.gz.noextract::https://github.com/abseil/abseil-cpp/releases/download/20250814.0/abseil-cpp-20250814.0.tar.gz
bazel_features-v1.30.0.tar.gz.noextract::https://github.com/bazel-contrib/bazel_features/releases/download/v1.30.0/bazel_features-v1.30.0.tar.gz
rules_python-1.5.4.tar.gz.noextract::https://github.com/bazel-contrib/rules_python/releases/download/1.5.4/rules_python-1.5.4.tar.gz
apple_support.1.23.1.tar.gz.noextract::https://github.com/bazelbuild/apple_support/releases/download/1.23.1/apple_support.1.23.1.tar.gz
bazel-skylib-1.8.1.tar.gz.noextract::https://github.com/bazelbuild/bazel-skylib/releases/download/1.8.1/bazel-skylib-1.8.1.tar.gz
platforms-1.0.0.tar.gz.noextract::https://github.com/bazelbuild/platforms/releases/download/1.0.0/platforms-1.0.0.tar.gz
rules_android_ndk-v0.1.3.tar.gz.noextract::https://github.com/bazelbuild/rules_android_ndk/releases/download/v0.1.3/rules_android_ndk-v0.1.3.tar.gz
rules_apple.4.1.2.tar.gz.noextract::https://github.com/bazelbuild/rules_apple/releases/download/4.1.2/rules_apple.4.1.2.tar.gz
rules_cc-0.2.2.tar.gz.noextract::https://github.com/bazelbuild/rules_cc/releases/download/0.2.2/rules_cc-0.2.2.tar.gz
rules_java-8.14.0.tar.gz.noextract::https://github.com/bazelbuild/rules_java/releases/download/8.14.0/rules_java-8.14.0.tar.gz
rules_kotlin-v1.9.6.tar.gz.noextract::https://github.com/bazelbuild/rules_kotlin/releases/download/v1.9.6/rules_kotlin-v1.9.6.tar.gz
rules_license-1.0.0.tar.gz.noextract::https://github.com/bazelbuild/rules_license/releases/download/1.0.0/rules_license-1.0.0.tar.gz
rules_pkg-1.1.0.tar.gz.noextract::https://github.com/bazelbuild/rules_pkg/releases/download/1.1.0/rules_pkg-1.1.0.tar.gz
rules_shell-v0.3.0.tar.gz.noextract::https://github.com/bazelbuild/rules_shell/releases/download/v0.3.0/rules_shell-v0.3.0.tar.gz
rules_swift.3.1.2.tar.gz.noextract::https://github.com/bazelbuild/rules_swift/releases/download/3.1.2/rules_swift.3.1.2.tar.gz
2025-01-25.zip.noextract::https://github.com/hiroyuki-komatsu/japanese-usage-dictionary/archive/refs/tags/2025-01-25.zip
jigyosyo.zip.noextract::https://github.com/hiroyuki-komatsu/japanpost_zipcode/raw/33524763837473258e7ba2f14b17fc3a70519831/jigyosyo.zip
ken_all.zip.noextract::https://github.com/hiroyuki-komatsu/japanpost_zipcode/raw/33524763837473258e7ba2f14b17fc3a70519831/ken_all.zip
zlib-1.3.1.tar.gz.noextract::https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
protobuf-32.0.zip.noextract::https://github.com/protocolbuffers/protobuf/releases/download/v32.0/protobuf-32.0.zip
"
source="
https://github.com/fcitx/mozc/archive/$_fcitx_mozc_commit.tar.gz
$_submodule_src
https://github.com/bazelbuild/bazel-central-registry/archive/$_bazel_central_registry_commit/bazel-central-registry-$_bazel_central_registry_commit.tar.gz
$_bazel_deps
link-libfts.patch
use-system-python-for-bazel.patch
use-rules_java-8.14.0.patch
"
builddir="$srcdir/mozc-$_fcitx_mozc_commit"
options="!check"

unpack() {
	default_unpack
	# remove .noextract from the bazel deps' filenames
	local f tgt
	for f in "$srcdir"/*.noextract; do
		tgt=${f%.noextract}
		mv $f $tgt
	done
}

prepare() {
	default_prepare
	local srcname dstname moddstdir
	for src in $_submodule_src; do
		srcname=${src#https://github.com/*/}
		srcname=${srcname%%/*}
		case $srcname in
		googletest)
			dstname=gtest
			;;
		japanese-usage-dictionary)
			dstname=japanese_usage_dictionary
			;;
		*)
			dstname=$srcname
			;;
		esac
		moddstdir=src/third_party/$dstname
		if [ -d $moddstdir ]; then
			rmdir $moddstdir
		else
			rm -f $moddstdir
		fi
		msg "symlinking $moddstdir -> $srcdir/$srcname"
		ln -s $srcdir/$srcname $moddstdir
	done
}

build() {
	local linkopt conlyopt cxxopt
	cd src
	for flag in $LDFLAGS; do
		linkopt="$linkopt --linkopt $flag"
	done
	for flag in $CFLAGS; do
		conlyopt="$conlyopt --conlyopt $flag"
	done
	for flag in $CXXFLAGS; do
		cxxopt="$cxxopt --cxxopt $flag"
	done
	bazel --output_base=$builddir/bazel-cache build \
		--distdir=$srcdir \
		--registry=file://$srcdir/bazel-central-registry-$_bazel_central_registry_commit \
		$linkopt $conlyopt $cxxopt \
		--@rules_python//python/config_settings:py_linux_libc=musl \
		-c opt --copt=-fPIC --config oss_linux \
		--verbose_failures \
		unix/fcitx5:fcitx5-mozc.so server:mozc_server gui/tool:mozc_tool
	cd ..
}

package() {
	(
		export PREFIX="$pkgdir"/usr
		cd src
		../scripts/install_server_bazel
		../scripts/install_fcitx5_bazel
	)
	install -dm0755 "$pkgdir"/usr/share/licenses/$pkgname
	install -m0644 LICENSE src/data/installer/credits_en.html "$pkgdir"/usr/share/licenses/$pkgname/
}

update_bazel_deps() {
	local urls
	urls=$(curl -s https://raw.githubusercontent.com/fcitx/flatpak-fcitx5/refs/heads/master/mozc-deps.yaml | awk \
		'/^  url:/ && !/cpython-/ {
		url = $2
		split(url, path, "/")
		fn = path[length(path)]
		print fn ".noextract::" $2
		}')
	msg "Updating _bazel_deps in $APKBUILD..."
	awk -v urls="$urls" \
		'!deps { print }
		/^_bazel_deps="$/ { deps = 1 }
		deps && /^"$/ { print urls; print "\""; deps = 0; }' \
		$APKBUILD >$APKBUILD.new
	mv $APKBUILD.new $APKBUILD
}

sha512sums="
4ed970a37fb4f78d8ca19ff282b8f6db6c890207bd604d625bcfd4c101be5b9b9eea8eb0618f551b42e7a2cca242bda376727d1f9179eaa046f49c8c7c56e819  d1a070e6611640686979dc22e1308dc5606c8271.tar.gz
cd6960a086adfd0c0d19df6d07991887ea8c7b224b65a0ffd63d40bb2555f95f0bb1bc7ae0c25519dc478bd790a0c4d1c06564b270f59028613c86eec95fef52  abseil-cpp-987c57f325f7fa8472fa84e1f885f7534d391b0d.tar.gz
6c7c667349c1b8e5509ba3a4a78873b87d1f1decefbd01e916e4b34497518c53c418ff5eaf88c9c9ef1815c8ee75112f876eebca4222ebb372fe6e5c2f5ab948  breakpad-216cea7bca53fa441a3ee0d0f5fd339a3a894224.tar.gz
7382ec9f583939f482d9d684ebccee9e564a2f1b7f1af0fbe654bdd498ba3b3f70d96e94983e7fc1890f936c18a6803599ba629ed3518345730dabc2cd73f9a8  googletest-52eb8108c5bdec04579160ae17225d66034bd723.tar.gz
961259c270471524ac371310460ca0fc34cec1cc57f6604915a6771be5f577420a7f1ddccb0d865fb94f5fb1516e0cdbb7f74d05252c5c3782d2b8fe7bf6f7df  gyp-9ecf45e37677743503342ee4c6a76eaee80e4a7f.tar.gz
b7e997a979b6d50e49b9af5dc830ea4df0532f6ab1321b9ef14983f65bb54f1b2967375c82e07957ae7693ebbf43c9b56ecea6bfea8dd1fdaee444bd549d83a7  japanese-usage-dictionary-e5b3425575734c323e1d947009dd74709437b684.tar.gz
c09118f7f1d0d25b37870827b76c27b08691ba60c578f8913a82b435fda34112be433059c003b5b80b52ecef53064fbf65451c9efad59ef0814896e943c22176  protobuf-4fbd1111a292d04746c732573025e3251de0bb9c.tar.gz
59548723d25e6f3c4a0f750d9874b06a487c15afb9cc9fa3a7a5290cbf79ea42cf36b9906c73dc56c566736141819d7a020b7a3d793724df83a9de5bc61ef674  wil-fc5dbf55989fe20351c71d038a8d12de4b397a6d.tar.gz
07b0583480e1f8873a57e70f6eba3003c871c18cf49e5694a1b92ca4dea846ac3f9bc51104f141550d3f10fcc72d02aca5e5fc75fa2dccbd7bf89e9710f83c6b  bazel-central-registry-4c9fa3699160fc77965fe02398ea037f22a9b290.tar.gz
4ee1a217203933382e728d354a149253a517150eee7580a0abecc69584b2eb200d91933ef424487e3a3fe0e8ab5e77b0288485cac982171b3585314a4417e7d4  abseil-cpp-20250814.0.tar.gz.noextract
9cca730483639e6b711c1e48d8d916839d5c618eda0b07ccb965184e79326ac6fcecc1446c61efcb4f7bb76b557e291cd2666b90e280dc8a4a76e1f9c09f1bb2  bazel_features-v1.30.0.tar.gz.noextract
c702e38d13e7b502408aadc313878682272f5e86059350b7568ac07f518439c8645b69ad0ecacc997caa9405ea0c838b7dc08f2d4eb531190d6067c610d30237  rules_python-1.5.4.tar.gz.noextract
60991d408dc073245ab1ae407286e30a6e1390063546d9d6017aa2d395443dfb924b60a5553b930aa7b5ce549200e90354135dabda3ce397232ee300331f1ee8  apple_support.1.23.1.tar.gz.noextract
519623c2ddce5606ffd101108667ca82b12a53da8c6f01d176b61339dae383b747ae4a6a96584e56b4ee6b1a57167813ee29ccae9736202907b8f3c401458d4f  bazel-skylib-1.8.1.tar.gz.noextract
cb05b7157e4e3b8ec05f1e4ac3e5eecc73d9a3ed5729455058a1290a5f04fb4e58be30368fc2ce6a90d6938ada331ea2abaeaaeaede16d1ae2ee091fa0c1faef  platforms-1.0.0.tar.gz.noextract
6fc90f12ff4736a50e058b1d675b47fe2bb63320b27c42c3be996c52b0076e17248ce246849cc264cd96418c046d54075ebf8ee2ddb3b74b8813d605e8968135  rules_android_ndk-v0.1.3.tar.gz.noextract
0494e784c5140059903cf8eeabd900125c5f917c6e2afdd2bdcb39b8c5c01a928ef3f717ce24cf10c8c3c6fae252d9cb246abe6ece63a9a40bd9cfb1f995710b  rules_apple.4.1.2.tar.gz.noextract
1cbad05b9b40460f398d767d73c2d4edcf546c6402d38c98e703664b8201f6eacb9195713a632715613c49c65cc6d182c05193a3594835b5a85bcba59ef27b63  rules_cc-0.2.2.tar.gz.noextract
b7ea0d839c9ed2edfe3042d8d7ffffeaee66547d9ec6670e71fcadadaa21a465e4fe0db7fae0fd2840a3499a06d1c4543378b96050387bd164ae28b657e9c1ce  rules_java-8.14.0.tar.gz.noextract
0e2d538a4d4c200d40ad0041d7ccc3155670247144b2be322607c5db219262fd6f7de512b54df9ed3bae72213ca340b6919a0248a00260b451af93042ccd3216  rules_kotlin-v1.9.6.tar.gz.noextract
17801f13c8a019de7e85a81ccfe6147ee9b996bbb72bbf4753aadb62e13c7c05040012182f3e557395a36453d8c7e9ca504b624bd2e490447656d0196c0fc6bb  rules_license-1.0.0.tar.gz.noextract
8eae67ababbf596d0c86f5ac9d6c6a0853f301c682df50403509b3bf2a85fdfc8532c4ca0c11e4ab85dac2bdb23165c8bbbeb35eb695a58a29b83c12a40abf55  rules_pkg-1.1.0.tar.gz.noextract
384f14574edf22fc7b515ca184b2af3868ea21aac31247a53aa5dab44293ed92dfed13807f1428051d6a539fd40f0fdb7e83ac2c8c8811be9ecdaa9725f044db  rules_shell-v0.3.0.tar.gz.noextract
d3155ed53b2811e17d3f92f1e1641a09e115c50c8dce686766b138b618925d9e60a1322655394e978fd9e6abc503bbc2601ef1f15ffef63826cb955bd5899554  rules_swift.3.1.2.tar.gz.noextract
e2d71432836855192bee9ccf45781aef797d0112a0444684c782a5310cec35ff96793c2d4aba80ad2e71b789839f4fa1c70eb175be09a1c92e747639b0f6ab3e  2025-01-25.zip.noextract
ec76f0c9b02a8f0a8633d752ebdb80ac7c4d5c71dfd9916cc9140d446bae8e09755db8d40eca87fbb08d21c31db80ec977f307c497f0d731087c73a1df9ea0c7  jigyosyo.zip.noextract
00aef90b785a703d536813616eeec7057eeaf681b83bc35c6c4b597df298ccb6bbd97f97845c7570788e7f063d94b4c62e359ccc698fcaeff17ce472bc1b9225  ken_all.zip.noextract
580677aad97093829090d4b605ac81c50327e74a6c2de0b85dd2e8525553f3ddde17556ea46f8f007f89e435493c9a20bc997d1ef1c1c2c23274528e3c46b94f  zlib-1.3.1.tar.gz.noextract
53ba7921add31048adb7ae0fc442d819bf2e9dae5341163770cfc165795b80b19e81aa281f90757a637929acfff200c50ab1c1d09e8612e7a50cd0c3a6e374ba  protobuf-32.0.zip.noextract
24050ab789f99a4536b0d9750fe0940af04d3721e1aeca1afd8833dfde6b1cd7af84b0b95634e0398df317fbe14d728b78cd79a567512f94a97845e54c135e14  link-libfts.patch
2ed8ecdd48a79e077f53a9b6a826c316324fe950af3ac071876fe3f6b70dafc96e5e15b30cdb1876d1c1137ced5c583cc89479e8fa386d73f32a9930b3b7a0af  use-system-python-for-bazel.patch
84357e5222dd582945130c437056e3b561c4e01a686258798e1c85198d5d05c8a4929f07973f32e1fb55a33ccec5f5a17098fe5b3308a7fa6270f7e1de50649a  use-rules_java-8.14.0.patch
"
