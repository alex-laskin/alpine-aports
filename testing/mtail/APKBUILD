# Contributor: Guy Godfroy <guy.godfroy@gugod.fr>
# Maintainer: Guy Godfroy <guy.godfroy@gugod.fr>
pkgname=mtail
pkgver=3.0.8
pkgrel=0
pkgdesc="Extract internal monitoring data from application logs for collection in a timeseries database"
url="https://google.github.io/mtail/"
arch="all"
license="Apache-2.0"
depends="tzdata"
makedepends="go"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
options="net" # go deps
source="$pkgname-$pkgver.tar.gz::https://github.com/google/mtail/archive/refs/tags/v$pkgver.tar.gz
	mtail.initd
	mtail.confd
	"

prepare() {
	default_prepare
	mkdir -p build
}

build() {
	local ldflags="-X main.Branch=main -X main.Version=$pkgver"
	go build -v -ldflags "$ldflags" -o build ./...
}

check() {
	go test ./...
}

package() {
	install -m755 -D build/mdot "$pkgdir"/usr/bin/mdot
	install -m755 -D build/mfmt "$pkgdir"/usr/bin/mfmt
	install -m755 -D build/mgen "$pkgdir"/usr/bin/mgen
	install -m755 -D build/mtail "$pkgdir"/usr/bin/mtail
	install -m755 -d "$pkgdir"/usr/share/mtail/example
	install -m644 examples/*.mtail "$pkgdir"/usr/share/mtail/example
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
e3f048e615966154949774889f43596a75019577ecbb008ac5072a9492602babdc8d1272ae3cb1ad789a14c15e3de1f5c4d299e03ba63469722eaad84994126a  mtail-3.0.8.tar.gz
4d63ee6d26de5b38a3bd5649652c15145cd0c2b5810649d6f250b59794a22f263f11923dbc23561b11048f9c0d0cbfb7dace6b52778605af4414bacf91372fcf  mtail.initd
c2e9c0e50b9e32b3c3305e05b68789a5cc6263ccd7072af613ee81c5992a31655b8dffccb6fb01051b42651cfd5c7c4bb4d2720d41e3a35a566d1e25ec448c29  mtail.confd
"
