# Contributor: Maxim Karasev <mxkrsv@disroot.org>
# Maintainer: Patrycja Rosa <alpine@ptrcnull.me>
pkgname=r2ghidra
pkgver=6.0.2
_ghidra_native=0.6.2
pkgrel=0
pkgdesc="native ghidra decompiler for radare2"
url="https://github.com/radareorg/r2ghidra"
# this is massive, and nobody is going to use a decompiler on other
# architectures
arch="x86_64 aarch64 ppc64le"
license="LGPL-3.0-only AND Apache-2.0"
depends="radare2"
makedepends="
	libzip-dev
	meson
	openssl-dev
	pugixml-dev
	radare2-dev
	"
source="https://github.com/radareorg/r2ghidra/archive/refs/tags/$pkgver/r2ghidra-$pkgver.tar.gz
	https://github.com/radareorg/ghidra-native/archive/refs/tags/$_ghidra_native/ghidra-native-$_ghidra_native.tar.gz
	use-system-pugixml.patch"
options="!check" # no tests

prepare() {
	default_prepare

	mv "$srcdir"/ghidra-native-"$_ghidra_native" \
		"$builddir"/subprojects/ghidra-native
	make -C "$builddir"/subprojects/ghidra-native patch
	cp "$builddir"/subprojects/packagefiles/ghidra-native/meson.build \
		"$builddir"/subprojects/ghidra-native/
}

build() {
	abuild-meson \
		-Db_lto=true \
		. output
	meson compile -C output

	# not implemented for meson yet
	cd ghidra
	make sleigh-build
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	# not implemented for meson yet
	cd "$builddir"/ghidra
	make D="$pkgdir"/usr/lib/radare2/$pkgver/r2ghidra_sleigh sleigh-install
}

sha512sums="
ecdd7f9b54eff2017050805a7d9e48e7608cbfb0d3322a44879f274744bf7fb1b7c5adbded934952ec4787ee3cc1c5e33fd99d66947d1ec91d42d05a57ed102f  r2ghidra-6.0.2.tar.gz
55509e9e12d9a7c7b14a0655a0c8c386477f55198626c1c9fd60b1cd9faf99dd8f143b3aacb8f7418379179afce37cf5124758918f18a7dcfbfb4737e93bb16e  ghidra-native-0.6.2.tar.gz
778cde771658ffa73d627623c363ddc306525f613d068f25f9afa80957a50320aeede35cea418ab036c2931799a6b15a25c490c784fdcf1c6c32e091aae40758  use-system-pugixml.patch
"
