maintainer="Fabricio Silva <hi@fabricio.dev>"
pkgname=parpar
pkgver=0.4.5
pkgrel=0
pkgdesc="High performance PAR2 create client for NodeJS"
url="https://github.com/animetosho/ParPar"
arch="all !riscv64 !x86" # riscv64: target specific builtin not available / x86: Found textrels
license="PD OR CC0-1.0"
depends="nodejs"
makedepends="make python3 npm"
options="net" # net for npm
source="https://github.com/animetosho/ParPar/archive/refs/tags/v$pkgver/parpar-$pkgver.tar.gz"
builddir="$srcdir/ParPar-$pkgver"

prepare() {
	default_prepare
	npm install --ignore-scripts
}

check() {
	./bin/parpar.js --version

	cd test
	NODE_OPTIONS=--openssl-legacy-provider \
		node ./par-compare.js -f
}

build() {
	node-gyp rebuild --build-from-source

	# cleanup src files
	rm -r build/Release/obj.target build/Release/.deps
	rm build/Makefile build/*.Makefile build/config.gypi build/*.mk
}

package() {
	local destdir="$pkgdir"/usr/lib/node_modules/@animetosho/parpar

	install -d "$pkgdir"/usr/bin "$destdir"

	install -Dm755 bin/parpar.js -t "$destdir"/bin
	cp -r build cli lib node_modules \
		package.json help.txt help-full.txt \
		"$destdir"

	ln -s ../lib/node_modules/@animetosho/parpar/bin/parpar.js \
		"$pkgdir"/usr/bin/parpar
}

sha512sums="
5380624249fa31beab9d37b4d44debc3859bc51e3163c2df5edbec8a5c310044a4987e2e5e06db17c3fd7bac0ddd6657b4ef5756cfc21106dcd6d41b8fc4a46f  parpar-0.4.5.tar.gz
"
