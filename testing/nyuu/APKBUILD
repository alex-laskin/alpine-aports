maintainer="Fabricio Silva <hi@fabricio.dev>"
pkgname=nyuu
pkgver=0.4.2
pkgrel=0
pkgdesc="Flexible usenet binary posting tool"
url="https://github.com/animetosho/Nyuu"
# x86: textrels
# riscv64: target specific builtin not available
# loongarch64: time out
arch="all !x86 !riscv64 !loongarch64"
license="PD OR CC0-1.0"
depends="nodejs"
makedepends="make python3 npm"
options="net" # net for npm
source="https://github.com/animetosho/Nyuu/archive/refs/tags/v$pkgver/nyuu-$pkgver.tar.gz"
builddir="$srcdir/Nyuu-$pkgver"

prepare() {
	default_prepare
	npm install --ignore-scripts --omit=dev
}

check() {
	./bin/nyuu.js --version
	npx -y mocha
}

build() {
	# build yencode
	cd node_modules/yencode
	node-gyp rebuild --build-from-source

	# cleanup src files
	rm -r crcutil-1.0 src test build/Release/obj.target build/Release/.deps
	rm binding.gyp build/Makefile build/*.Makefile build/config.gypi build/*.mk
}

package() {
	local destdir="$pkgdir"/usr/lib/node_modules/nyuu

	install -d "$pkgdir"/usr/bin "$destdir"

	install -Dm755 bin/nyuu.js -t "$destdir"/bin
	cp -r cli lib node_modules \
		package.json config.js help.txt help-full.txt \
		"$destdir"

	ln -s ../lib/node_modules/nyuu/bin/nyuu.js \
		"$pkgdir"/usr/bin/nyuu
}

sha512sums="
0cc20bf6c5150e0a580c2d08a3b8f7ba57c0b57622e8a037c0d6083fd6f96332b581ad20cdef4060b4091e8efab603628c51102636ae6099c54161494f1ffcb2  nyuu-0.4.2.tar.gz
"
