# Maintainer: qaqland <qaq@qaq.land>
pkgname=mado
pkgver=0.3.0
pkgrel=0
pkgdesc="A fast Markdown linter written in Rust"
url="https://github.com/akiomik/mado"
arch="all"
license="Apache-2.0"
makedepends="
	cargo
	cargo-auditable
	jemalloc-dev
	oniguruma-dev
	"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="https://github.com/akiomik/mado/archive/v$pkgver/mado-$pkgver.tar.gz"
options="net" # cargo fetch

export RUSTONIG_SYSTEM_LIBONIG=1 # oniguruma-dev

prepare() {
	default_prepare

	cargo fetch --target="$CHOST" --locked

	# Build against system-provided libs
	mkdir -p .cargo
	cat >> .cargo/config.toml <<-EOF
		[target.$CHOST]
		jemalloc = { rustc-link-lib = ["jemalloc"] }
	EOF

}

build() {
	cargo auditable build --frozen --release

	target/release/mado generate-shell-completion bash > mado
	target/release/mado generate-shell-completion fish > mado.fish
	target/release/mado generate-shell-completion zsh > _mado
}

check() {
	CLICOLOR_FORCE=true cargo test --frozen
}

package() {
	install -Dm755 target/release/mado -t "$pkgdir"/usr/bin

	install -Dm644 README.md CHANGELOG.md -t "$pkgdir"/usr/share/doc/mado
	install -Dm644 LICENSE -t "$pkgdir"/usr/share/licenses/mado

	install -Dm644 mado -t "$pkgdir"/usr/share/bash-completion/completions
	install -Dm644 mado.fish -t "$pkgdir"/usr/share/fish/vendor_completions.d
	install -Dm644 _mado -t "$pkgdir"/usr/share/zsh/site-functions
}

sha512sums="
65a154cb4bda06731d1d4b37791fbcf68f011362bbe4bb3d2446a3070241c85d2493d686f61a9268f4e913b3dc0b74f169f4a582110f6d07feed38686b9eee62  mado-0.3.0.tar.gz
"
