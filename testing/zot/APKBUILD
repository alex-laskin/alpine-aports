maintainer="Hoang Nguyen <folliekazetani@protonmail.com>"
pkgname=zot
pkgver=2.1.8
_zui_commit=731b63943eedb1845ca53741384b5e2a44249959
pkgrel=1
pkgdesc="Vendor-neutral OCI-native container image registry"
url="https://zotregistry.dev/"
# 32-bit, riscv64: build fails
arch="all !x86 !armhf !armv7 !riscv64"
license="Apache-2.0"
makedepends="go linux-headers npm nodejs"
checkdepends="openssl"
subpackages="
	$pkgname-doc
	$pkgname-openrc
	$pkgname-cli:_cli
	$pkgname-exporter:_exporter
	$pkgname-cli-bash-completion:_bashcomp:noarch
	$pkgname-cli-fish-completion:_fishcomp:noarch
	$pkgname-cli-zsh-completion:_zshcomp:noarch
	"
install="$pkgname.pre-install"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/project-zot/zot/archive/refs/tags/v$pkgver.tar.gz
	zui-$_zui_commit.tar.gz::https://github.com/project-zot/zui/archive/$_zui_commit.tar.gz
	zot.initd
	zot.confd
	"
options="net" # download Go modules

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

prepare() {
	default_prepare

	cd "$srcdir"/zui-$_zui_commit
	npm install --no-progress
}

build() {
	cd "$srcdir"/zui-$_zui_commit
	npm run build
	cp -r build "$builddir"/pkg/extensions/

	cd "$builddir"
	local _extensions="sync,search,scrub,metrics,lint,ui,mgmt,profile,userprefs,imagetrust"
	local _goldflags="
	-X zotregistry.dev/zot/pkg/api/config.ReleaseTag=v$pkgver
	-X zotregistry.dev/zot/pkg/api/config.Commit=AlpineLinux
	-X zotregistry.dev/zot/pkg/api/config.BinaryType=${_extensions//,/-}
	-X zotregistry.dev/zot/pkg/api/config.GoVersion=$(go env GOVERSION)
	"

	for binary in zot zb zli; do
		go build -v \
			-ldflags "$_goldflags" \
			-tags "$_extensions,containers_image_openpgp" \
			./cmd/$binary
	done
	go build -v -tags containers_image_openpgp ./cmd/zxp

	# Only generate shell completions for the CLI client
	for shell in bash fish zsh; do
		./zli completion $shell > zli.$shell
	done
}

check() {
	# A small part of 'make test/data'
	mkdir -p test/data/noidentity
	cd test/data
	sh ../scripts/gen_certs.sh
	cd noidentity
	sh ../../scripts/gen_nameless_certs.sh

	# Skip tests requiring static container image tarballs (pulled via skopeo) in $builddir/test/data/
	cd "$builddir"
	go test -tags containers_image_openpgp \
		-skip 'TestGarbageCollectForImageStore|TestImageBuilder|TestPredefinedImages' \
		./...
}

package() {
	install -Dm755 zot -t "$pkgdir"/usr/bin/

	install -Dm644 examples/config-*.json -t "$pkgdir"/usr/share/doc/zot/examples/

	install -Dm755 "$srcdir"/zot.initd "$pkgdir"/etc/init.d/zot
	install -Dm644 "$srcdir"/zot.confd "$pkgdir"/etc/conf.d/zot
}

_cli() {
	pkgdesc="$pkgdesc - CLI tools"
	install -Dm755 "$builddir"/zli "$builddir"/zb -t "$subpkgdir"/usr/bin/
}

_exporter() {
	pkgdesc="$pkgdesc - metrics exporter"
	install -Dm755 "$builddir"/zxp -t "$subpkgdir"/usr/bin/
}

_bashcomp() {
	pkgdesc="Bash completions for $pkgname-cli"
	install_if="bash-completion $pkgname-cli=$pkgver-r$pkgrel"
	install -Dm644 "$builddir"/zli.bash \
		"$subpkgdir"/usr/share/bash-completion/completions/zli
}

_fishcomp() {
	pkgdesc="Fish completions for $pkgname-cli"
	install_if="fish $pkgname-cli=$pkgver-r$pkgrel"
	install -Dm644 "$builddir"/zli.fish \
		"$subpkgdir"/usr/share/fish/vendor_completions.d/zli.fish
}

_zshcomp() {
	pkgdesc="Zsh completions for $pkgname-cli"
	install_if="zsh $pkgname-cli=$pkgver-r$pkgrel"
	install -Dm644 "$builddir"/zli.zsh \
		"$subpkgdir"/usr/share/zsh/site-functions/_zli
}

sha512sums="
afebeda25a74ea507a5062d54b995437d14e9f59db089971d11413dfcd63e4b66f8f38c1060a289316d5de97f306092f6b24204b4208c09caed67a9cd9647055  zot-2.1.8.tar.gz
d8e669f6a4927d924680fc9191ecd3d2a6f0224e3400d4ef4b8a989add624f9f9f9f225cb513bc677a68ef74c14828cfd25c4e1d93599a0c55884956353736aa  zui-731b63943eedb1845ca53741384b5e2a44249959.tar.gz
86dfa273e97110b703fbc368757520ef6169dead185ff54b5b8ba45e764949bc3a21a51d53a1605d7163faef8c83c066e688577f5315b8c0afb09f69a2bbe3bb  zot.initd
b128ecaf3e35cfdab8069da9a8267a9faed50b892ae07b6a4a22a4108236d6cdbc10cc4cf0105c728e9e6da6ac773f56d1dd84de1ba4463110058b6c2f190b30  zot.confd
"
