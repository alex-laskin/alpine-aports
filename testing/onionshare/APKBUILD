maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=onionshare
pkgver=2.6.3
pkgrel=0
pkgdesc="Share a file over Tor Hidden Services anonymously and securely"
url="https://github.com/onionshare/onionshare"
# armhf: py3-pyside6
# riscv64: py3-flask-socketio
arch="noarch !armhf !riscv64"
license="GPL-3.0-or-later"
depends="
	hicolor-icon-theme
	py3-colorama
	py3-flask-compress
	py3-flask-httpauth
	py3-flask-socketio
	py3-gevent-websocket
	py3-psutil
	py3-pycryptodome
	py3-pynacl
	py3-pysocks
	py3-qrcode
	py3-requests
	py3-stem
	py3-unidecode
	py3-waitress
	tor
	"
_desktop_depends="py3-pyside6"
makedepends="py3-poetry-core py3-gpep517 $_desktop_depends"
checkdepends="py3-pytest"
subpackages="$pkgname-pyc $pkgname-desktop"
source="https://github.com/onionshare/onionshare/releases/download/v$pkgver/onionshare-$pkgver.tar.gz"
builddir="$srcdir/onionshare"


build() {
	cd cli
	gpep517 build-wheel --wheel-dir dist --output-fd 3 3>&1
	cd ../desktop
	gpep517 build-wheel --wheel-dir dist --output-fd 3 3>&1
}

check() {
	cd cli
	PYTHONPATH=".:$PYTHONPATH" pytest tests/
	# disabled: core dump
	# cd ../desktop
	# PYTHONPATH="src:../cli:$PYTHONPATH" pytest tests/
}

package() {
	python3 -m installer --destdir="$pkgdir" desktop/dist/*.whl
	# Wheel above installs this binary but not the actual package:
	rm "$pkgdir/usr/bin/onionshare-cli"
	python3 -m installer --destdir="$pkgdir" cli/dist/*.whl

	install -Dm 644 -t "$pkgdir/usr/share/applications/" \
		desktop/org.onionshare.OnionShare.desktop
	install -Dm 644 -t "$pkgdir/usr/share/icons/hicolor/scalable/apps/" \
		desktop/org.onionshare.OnionShare.svg
	install -Dm 644 -t "$pkgdir/usr/share/metainfo/" \
		desktop/org.onionshare.OnionShare.appdata.xml
}

desktop() {
	depends="$pkgname=$pkgver-r$pkgrel $_desktop_depends"
	amove \
		usr/share/applications/org.onionshare.OnionShare.desktop \
		usr/share/icons/hicolor/scalable/apps/org.onionshare.OnionShare.svg \
		usr/share/metainfo/org.onionshare.OnionShare.appdata.xml \
		usr/lib/python3.12/site-packages/onionshare/ \
		usr/bin/onionshare
}

sha512sums="
ae9873dc0eadb537adda6f815659a83582897b4332961ba2897392ce6fa5ad72561f36327772e934699328462feba7e3177998debe8700443423925eab32ede8  onionshare-2.6.3.tar.gz
"
