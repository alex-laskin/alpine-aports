# Contributor: Holger Jaekel <holger.jaekel@gmx.de>
maintainer="Holger Jaekel <holger.jaekel@gmx.de>"
pkgname=gl2ps
pkgver=1.4.2
pkgrel=0
pkgdesc="OpenGL to Postscript printing library"
url="https://www.geuz.org/gl2ps/"
arch="all !loongarch64 !riscv64"  # loongarch64 and riscv64 test fails with core dump
license="LGPL-2.0-or-later"
makedepends="
	cmake
	freeglut-dev
	glu-dev
	libpng-dev
	libxmu-dev
	mesa-dri-gallium
	samurai
	xvfb-run
	zlib-dev
	"
subpackages="$pkgname-static $pkgname-dev $pkgname-doc"
source="https://www.geuz.org/gl2ps/src/gl2ps-$pkgver.tgz
	10-test.patch
	"

# texlive is not available on ppc64le and s390x
case "$CARCH" in
ppc64le|s390x) ;;
*) makedepends="$makedepends texlive texmf-dist-latexrecommended" ;;
esac

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake3.5 -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		$crossopts
	cmake --build build
}

check() {
	xvfb-run -a -s "-screen 0 1280x1024x24 -dpi 96" ./build/gl2psTestSimple
	xvfb-run -a -s "-screen 0 1280x1024x24 -dpi 96" ./build/gl2psTest
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	# remove test programs
	rm -rf "$pkgdir"/usr/share/doc/gl2ps/*.c

	install -Dm644 gl2ps.pdf \
		"$pkgdir"/usr/share/doc/$pkgname/gl2ps.pdf
}

sha512sums="
46652e1b3825ace61dbd77c4b0bf451e7671c248eb18bbd3369e2fac00056ea4cd5d2578561984313c239e3b02f78b9d9a76d963c935af65a13bc2abfc538620  gl2ps-1.4.2.tgz
cd0a6eabf3686215d79beff2cc19b1a84e58df7e76d69dc5c0b31fb702e6161771a7f024eb318c7ece846e6946454acfe093135cad5f8cec4e4070bc425cf9cc  10-test.patch
"
