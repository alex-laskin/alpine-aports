# Contributor: Saijin-Naib <Saijin-Naib_package-maintenance@outlook.com>
# Maintainer: Saijin-Naib <Saijin-Naib_package-maintenance@outlook.com>
pkgname=darkradiant
pkgver=3.9.0
pkgrel=0
pkgdesc="Map editor for The Dark Mod and other idTech4/Doom3-based games"
url="https://www.darkradiant.net/"
arch="aarch64 loongarch64 ppc64le riscv64 s390x x86_64"
license="GPL-v2.0-only"
depends="
	wxwidgets-gtk3
	"
makedepends="
	asciidoctor
	cmake
	eigen-dev
	freealut-dev
	freetype-dev
	ftgl-dev
	gettext
	glew-dev
	glib-dev
	gtest-dev
	libgit2-dev
	libjpeg-turbo-dev
	libpng-dev
	libsigc++-dev
	libvorbis-dev
	openal-soft-dev
	pugixml-dev
	python3-dev
	samurai
	wxwidgets-dev
	zlib-dev
	"
checkdepends="gtest virtualgl xvfb xvfb-run"
subpackages="$pkgname-doc $pkgname-lang"
source="$pkgname-$pkgver.tar.gz::https://github.com/codereader/DarkRadiant/archive/refs/tags/$pkgver.tar.gz
	no-execinfo.patch"
builddir="$srcdir/DarkRadiant-$pkgver/"
options="!check" #Nearly all tests breaking on xvfb-run and vglrun

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		$crossopts
	cmake --build build
}

check() {
	xvfb-run -a vglrun \
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
79e8e5730cf77c4dc42a1193d06263befdb4fdd081f8cb92c40e183c8d51083f2d5dc746c4e784ae8cf536465e6b7dc21fa1c0515be55384f4c5614f073e3702  darkradiant-3.9.0.tar.gz
fb591ba59de1987d8339adfb602466c7666504495b0526f8322574a3227f05ed18633121ee63ab67b754b1afff266e4d934f842eb619782cf2c2743f8e01c5b9  no-execinfo.patch
"
