# Maintainer: Cowington Post <cowingtonpost@gmail.com>
pkgname=agate
pkgver=3.3.19
pkgrel=0
pkgdesc="Simple Gemini server for static files"
url="https://github.com/mbrubeck/agate"
arch="all"
license="Apache-2.0"
makedepends="cargo cargo-auditable openssl-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/mbrubeck/agate/archive/refs/tags/v$pkgver.tar.gz
	agate.initd
	agate.confd
	"

# armhf/armv7: OpenSSL errors, tcp connection timeouts
# https://tpaste.us/VYM1
case "$CARCH" in
	arm*) options="!check" ;;
esac

prepare() {
	default_prepare

	sed -i 's/version = "3.3.1"/version = "3.3.3"/' Cargo.lock

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --release
}

check() {
	cargo test
}

package() {
	install -Dm755 target/release/agate -t "$pkgdir"/usr/bin
	install -Dm755 "$srcdir"/agate.initd "$pkgdir"/etc/init.d/agate
	install -Dm644 "$srcdir"/agate.confd "$pkgdir"/etc/conf.d/agate
}

sha512sums="
02be6af301626d366e8cc4f62b6e1d887482a13bff4073e8b30cef434d1c0e7a496648b832832d7f6b5861d7846e596b43f14f1b8dbe96b3137f2d79d2707483  agate-3.3.19.tar.gz
711c7687e3e5421d0d625a11aa0067cc5fb4dbe9656e8d9aee2dd1a0fa0befe7a83c705c4875c8f20d3701fa0557c80af4b82373bade7c5be2c4dbd27e9f5141  agate.initd
d8f54616edafaf513c591fc3ab405c65044a8f43cf1e50e43c7cac5ae3fa5c383a267108c10210ea236a5edfa1fcf2014a932e77bc216cc06dce83cab7e32c85  agate.confd
"
