maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=py3-prctl
_pkgname=python-prctl
pkgver=1.8.1
pkgrel=0
pkgdesc="Interface to the Linux prctl syscall"
url="https://github.com/seveas/python-prctl"
# s390x: tests fail; returns bogus values
arch="all !s390x"
license="GPL-3.0-or-later"
makedepends="py3-gpep517 py3-setuptools libcap-dev python3-dev"
subpackages="$pkgname-pyc"
source="$_pkgname-$pkgver.tar.gz::https://github.com/seveas/python-prctl/archive/v$pkgver.tar.gz
	0001-tests-skip-speculation-enable-if-force-disabled.patch
	0002-Disable-tests-which-fail-in-sandboxes.patch
	0003-Fix-tests-for-ppc64le.patch
	0004-Fix-tests-on-aarch64.patch
	0005-Fix-mixup-in-test.patch
	setuptools-62.1.patch
"
builddir="$srcdir/python-prctl-$pkgver"
options="!check" # fail on builders: https://tpaste.us/zP1w

build() {
	gpep517 build-wheel --wheel-dir dist --output-fd 3 3>&1
}

check() {
	PYTHONDONTWRITEBYTECODE=1 python3 -m unittest discover -v
}

package() {
	python3 -m installer -d "$pkgdir" dist/*.whl
}

sha512sums="
a251b0aefbd6a16d69fd664cadf87ba16af87e7551ae474846858876007028c13b619e227518688e876f95726d327eb4793c37a34317ec8a1bf2c6ea02a31b21  python-prctl-1.8.1.tar.gz
d3db1b0294c5561ef68b04db0ee6e7851d77723e177d19112b3fef2902737b3999807c785edc0997bd66bd1247cfe861c1ffc9f6f8ce590bb1ee03eab6978456  0001-tests-skip-speculation-enable-if-force-disabled.patch
f880025192e10af0495b910fecb91a602589cc84fd11f1624eb1f90e50bbce79a388266992fd648a4189a07a05feca2eb306316f1d25f00ac5b9403f7711e6d9  0002-Disable-tests-which-fail-in-sandboxes.patch
21c84a7b09b8138c762f8f13e6bca41511cb891fd82168bf688282265f06b7d7d2c107281f88521ebc5a50b16850908053c1d54a884c41f909845a85c3efb71a  0003-Fix-tests-for-ppc64le.patch
15115be4144840e707081abd69269f3ce90514cea39848a81fca75c0b1b295e91ea422cde015e6f149127b94ada9d98daf511f533d66f55c535f697d179890d4  0004-Fix-tests-on-aarch64.patch
666579a5b30b59f43deba8ed0aeadc006fe86acfd000bdf5f4fd0183ff971a7477580b8fecd37c9ed2f74f6ceeb07ed0d8549609ea65914164958f6b0d53a059  0005-Fix-mixup-in-test.patch
9b5b4c3b61babfb86cf15474247f68bcfa76b957ab7e25c344ed4253c4598c32ad9915509ab1d94f58a90fccaf52a83a83e282863217cf3e9bc3ef09cc439db4  setuptools-62.1.patch
"
