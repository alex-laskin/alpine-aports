# Maintainer: Samuel Kalbfleisch <contact+alpine@mallory.re>
pkgname=libetebase
pkgver=0.5.8
pkgrel=0
pkgdesc="Etebase C library providing end-to-end encrypted backend as a service"
url="https://github.com/etesync/libetebase"
arch="all"
license="BSD-3-Clause"
makedepends="openssl-dev libsodium-dev cargo"
subpackages="$pkgname-dev"
source="
$pkgname-$pkgver.tar.gz::https://github.com/etesync/libetebase/archive/refs/tags/v$pkgver.tar.gz
c_test_no-fsanitize=address.patch
"
options="!check net" # checks expects a running etebase: https://github.com/etesync/libetebase/blob/26023dc432d7fa5cad8957e4c742474c0455e388/c_tests/test_service.c#L14-L18

build() {
	make
}

check() {
	make build
	ln -s libetebase.so target/release/libetebase.so.0
	LD_LIBRARY_PATH="../target/release:$LD_LIBRARY_PATH" make check
}

package() {
	make DESTDIR="$pkgdir" install

	# Move the solink-named library to a full path then create
	# symlinks, soname is already set but upstream didn't create
	# these
	# See: https://github.com/etesync/libetebase/issues/4
	mv "$pkgdir/usr/lib/libetebase.so" "$pkgdir/usr/lib/libetebase.so.0.0.0"
	ln -s libetebase.so.0.0.0 "$pkgdir/usr/lib/libetebase.so.0"
	ln -s libetebase.so.0.0.0 "$pkgdir/usr/lib/libetebase.so"
}

sha512sums="
7b3aab9d8522e4237e0ea34e348ab75fdddf400ecd8492a57a602a707b12e18706ee796eca6c4092846d772f5663fb5df749c7c83fca14a04b8c452ca45f55ea  libetebase-0.5.8.tar.gz
ea891616c53f9525c5649a72a5cb092139de680d5a34d06d027ae937b5c1072d149a7ba01c2173dc041af333284ee7f640f353a90e5e1934a376565de4288800  c_test_no-fsanitize=address.patch
"
