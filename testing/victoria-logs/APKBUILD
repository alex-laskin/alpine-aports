# Contributor: Konstantin Kulikov <k.kulikov2@gmail.com>
# Maintainer: Konstantin Kulikov <k.kulikov2@gmail.com>
pkgname=victoria-logs
pkgver=1.36.1
pkgrel=0
provides="victorialogs=$pkgver-r$pkgrel"
pkgdesc="User-friendly database for logs"
url="https://github.com/VictoriaMetrics/VictoriaLogs"
# Many test failures on other archs.
arch="x86_64 aarch64"
license="Apache-2.0"
makedepends="go zstd-dev"
checkdepends="tzdata"
subpackages="$pkgname-openrc $pkgname-vlogscli:_vlogscli $pkgname-vlagent:_vlagent"
install="$pkgname.pre-install"
source="$pkgname-$pkgver.tar.gz::https://github.com/VictoriaMetrics/VictoriaLogs/archive/v$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	libzstd_system.go
	"
builddir="$srcdir/VictoriaLogs-$pkgver"

prepare() {
	default_prepare
	# Avoid linking to binary blobs.
	# Note that valyala/gozstd uses vendored headers and defines ZSTD_STATIC_LINKING_ONLY,
	# which opens access to some experimental symbols.
	# It's not an issue right now, but could be, if gozstd starts using symbols that depend on .so and .h being in sync.
	rm -rf "$builddir/vendor/github.com/valyala/gozstd/libzstd_"*
	cp "$srcdir/libzstd_system.go" "$builddir/vendor/github.com/valyala/gozstd/"
}

build() {
	local ldflags="-X github.com/VictoriaMetrics/VictoriaMetrics/lib/buildinfo.Version=v$pkgver-r$pkgrel"
	local bin
	for bin in victoria-logs vlogscli vlagent; do
		go build -ldflags="$ldflags" -o bin/$bin ./app/$bin &
	done
	wait
}

check() {
	go test -short -parallel 4 ./app/... ./lib/...
}

package() {
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname

	cd bin
	install -Dm755 -t "$pkgdir"/usr/bin \
		victoria-logs vlogscli vlagent
}

_vlogscli() {
	pkgdesc="$pkgdesc (vlogscli)"
	amove usr/bin/vlogscli
}

_vlagent() {
	pkgdesc="$pkgdesc (vlagent)"
	amove usr/bin/vlagent
}

sha512sums="
a0a68c70b7884361e6ff35c1fdb8c83e6106df239e9144dc26725621a1d86354fb8bfc22ecd13f3398b5cc9032843343c1766df58c1d902a59e6e772f17277ef  victoria-logs-1.36.1.tar.gz
25ee0e5d16bfc21dfba2b1c804097d8c6327bac0ad3a5116a287608c0d7ac0b74e316cd2fabe99d1666788f91e58eb04e749a64d133ec94cdf6ab92fff0a263d  victoria-logs.initd
c066c9f2a28dc14eb4d79e62ad994fec64a8c2b401142320c172c24551ccb91185e5d4d3fcedb364ae796380f410b3c8445e03580814b446f61d7835929d34f2  victoria-logs.confd
7219afe00c5af3c322b08478c92eafc762da5a22f4bcb0e7d09d5f0f057fd62eb5db01a6c5d015c5c94eafd99a2116faf318c070be3f1b13e920b3ce8955f3a7  libzstd_system.go
"
