# Maintainer: Lauri Tirkkonen <lauri@hacktheplanet.fi>
pkgname=netbird
pkgver=0.59.11
pkgrel=0
pkgdesc="WireGuard-based overlay network and mesh VPN"
url="https://netbird.io/"
arch="all"
license="BSD-3-Clause"
options="net !check" # tests require root
depends="openresolv"
makedepends="go libxkbcommon-dev mesa-dev wayland-dev"
subpackages="
$pkgname-doc
$pkgname-openrc
$pkgname-bash-completion
$pkgname-fish-completion
$pkgname-zsh-completion
$pkgname-mgmt
$pkgname-signal
$pkgname-relay
$pkgname-mgmt-openrc
$pkgname-signal-openrc
$pkgname-relay-openrc
"
install="
$pkgname.pre-install
$pkgname-mgmt.pre-install
$pkgname-relay.pre-install
$pkgname-signal.pre-install
"
source="
https://github.com/netbirdio/netbird/archive/refs/tags/v$pkgver/netbird-$pkgver.tar.gz
unix-socket-permissions.patch
netbird.initd
netbird-mgmt.initd
netbird-relay.initd
netbird-signal.initd
netbird.confd
netbird-mgmt.confd
netbird-relay.confd
netbird-signal.confd
"

case "$CARCH" in
x86)
	# ./client/ui fails to build with:
	# runtime.main_mainÂ·f: function main is undeclared in the main package
	;;
*)
	subpackages="$subpackages $pkgname-ui"
	;;
esac

build() {
	local build_ui=""
	mkdir -p build
	case "$subpackages" in
	*$pkgname-ui*)
		build_ui=./client/ui
		;;
	esac
	go build -v -o build \
		-tags wayland \
		-ldflags "-X github.com/netbirdio/netbird/version.version=$pkgver -extldflags \"$LDFLAGS\"" \
		./client $build_ui ./management ./signal ./relay
}

_install_completions() {
	local bashdir="$pkgdir"/usr/share/bash-completion/completions
	local fishdir="$pkgdir"/usr/share/fish/vendor_completions.d
	local zshdir="$pkgdir"/usr/share/zsh/site-functions

	local prog="$1"

	mkdir -p "$bashdir" "$fishdir" "$zshdir"
	"$pkgdir"/usr/bin/$prog completion bash >"$bashdir"/$prog
	"$pkgdir"/usr/bin/$prog completion fish >"$fishdir"/$prog.fish
	"$pkgdir"/usr/bin/$prog completion zsh >"$zshdir"/_$prog
}

package() {
	install -Dm0755 build/client "$pkgdir"/usr/bin/netbird
	install -Dm0644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE

	if [ -x build/ui ]; then
		install -Dm0755 build/ui "$pkgdir"/usr/bin/netbird-ui
		install -Dm0644 client/ui/build/netbird.desktop "$pkgdir"/usr/share/applications/netbird.desktop
		install -Dm0644 client/ui/assets/netbird.png "$pkgdir"/usr/share/pixmaps/netbird.png
	fi

	install -Dm0755 build/management "$pkgdir"/usr/bin/netbird-mgmt
	install -Dm0755 build/signal "$pkgdir"/usr/bin/netbird-signal
	install -Dm0755 build/relay "$pkgdir"/usr/bin/netbird-relay

	install -Dm0755 $srcdir/netbird.initd "$pkgdir"/etc/init.d/netbird
	install -Dm0755 $srcdir/netbird-signal.initd "$pkgdir"/etc/init.d/netbird-signal
	install -Dm0755 $srcdir/netbird-mgmt.initd "$pkgdir"/etc/init.d/netbird-mgmt
	install -Dm0755 $srcdir/netbird-relay.initd "$pkgdir"/etc/init.d/netbird-relay
	install -Dm0644 $srcdir/netbird.confd "$pkgdir"/etc/conf.d/netbird
	install -Dm0644 $srcdir/netbird-signal.confd "$pkgdir"/etc/conf.d/netbird-signal
	install -Dm0600 $srcdir/netbird-mgmt.confd "$pkgdir"/etc/conf.d/netbird-mgmt
	install -Dm0600 $srcdir/netbird-relay.confd "$pkgdir"/etc/conf.d/netbird-relay

	_install_completions netbird
	_install_completions netbird-mgmt
	_install_completions netbird-signal
}

ui() {
	pkgdesc="Graphical user interface for NetBird"
	amove usr/bin/netbird-ui usr/share
}

mgmt() {
	license="AGPL-3.0-only"
	depends=""

	amove usr/bin/netbird-mgmt
}

signal() {
	license="AGPL-3.0-only"
	depends=""

	amove usr/bin/netbird-signal
}

relay() {
	license="AGPL-3.0-only"
	depends=""

	amove usr/bin/netbird-relay
}

openrc() {
	local subpkg="${subpkgname%-openrc}"
	depends="$depends_openrc"
	install_if="openrc $subpkg=$pkgver-r$pkgrel"

	amove etc/init.d/$subpkg etc/conf.d/$subpkg
}

sha512sums="
37bc2b740c83b2b1eb0bcbbdc599eecd0bedc6bca27b609ce23f6ab18a07b38744f2263bd7bcd978bf46795e7f6ea5d307a638d1a47793128c2d48bba33b1e85  netbird-0.59.11.tar.gz
48e42689f0799c6c6acfb25ac6385c1006e9dab25b683634b3248656ce1195bf999d1e45643fd1d3876e7df88bc0b6f6b52ffa72aaf74da41bebe38ade49317f  unix-socket-permissions.patch
a71c8e4d0e625fb3cc8d7aac64d1d6a93e56dc2b811058e079c39cd37bfe9aa0b914478a3028171a561b0f0a75ac000190d2b0dff2759aab08985b67e717e625  netbird.initd
856bc20ead943255eaadd5ad5e1b7c43ce73b9995ca2c6b61779540f7361e92160470dcb1301f98a7073c774872c6573e96ff6cc9a98adcdfaa9f6f216f270c0  netbird-mgmt.initd
c2125963716fe341419eab4a44c819e2577e5b06ca70b0bf26d6b8ea67430d599da2cb2320b5a87544651c82a27ef24504e0dd97e7d93d0489fc84fb5264b3d1  netbird-relay.initd
09c60aa1aaf3c9a1e365d32b2bc552c7d7614b37d6bd4313c0341eb728975238143c7d9b7e47091717f18729eea90ac3432ef41158173815c1eb3088717e3f78  netbird-signal.initd
30f2a2248a1e1f77a7a545df8261b1b1b384816edbf1fae9b38967267f924b76307852d852415f00eed80bb406202c943fe26282484af3c06f65ec176b84d68d  netbird.confd
21fa5dc0d8a47d5d5b45cf99dc00383a7cdfed400fb421ab8cfc94cfac09c09c9e86f88abad2995a1132d05d22ea9408880a84013bb6add7ce38164e7a95c2e0  netbird-mgmt.confd
180126bd36cc9b8e0f50418df6619f8f58fcafc1cabadbc298233ec511f74cab9ead66c6bd582787ef6b4e3720dfaa148d220f1595692c4ca87eeabff094d45e  netbird-relay.confd
f5e17f8e000cbcddf78f538760ef1a6bc12ff78d0f681b447f8c3da2d47a70a2ca161c1cc2e5e526d9ba1cdd1b4fd9e450757ef70f257dd05e852f043bbc1bde  netbird-signal.confd
"
